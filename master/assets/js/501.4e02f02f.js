(window.webpackJsonp=window.webpackJsonp||[]).push([[501],{888:function(a,t,e){"use strict";e.r(t);var s=e(43),r=Object(s.a)({},(function(){var a=this,t=a.$createElement,e=a._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h1",{attrs:{id:"arm64-kylinos-编译运行-doris"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#arm64-kylinos-编译运行-doris"}},[a._v("#")]),a._v(" ARM64 + KylinOS 编译运行 Doris")]),a._v(" "),e("p",[a._v("本文档介绍如何在 ARM64 平台上编译 Doris。")]),a._v(" "),e("p",[a._v("注意，该文档仅作为指导性文档。在不同环境中编译可能出现其他错误。")]),a._v(" "),e("h2",{attrs:{id:"软硬件环境"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#软硬件环境"}},[a._v("#")]),a._v(" 软硬件环境")]),a._v(" "),e("ol",[e("li",[e("p",[a._v("KylinOS 版本：")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("$> cat /etc/.kyinfo\nname=Kylin-Server\nmilestone=10-SP1-Release-Build04-20200711\narch=arm64\nbeta=False\ntime=2020-07-11 17:16:54\ndist_id=Kylin-Server-10-SP1-Release-Build04-20200711-arm64-2020-07-11 17:16:54\n")])])])]),a._v(" "),e("li",[e("p",[a._v("CPU型号")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("$> cat /proc/cpuinfo\nmodel name  : Phytium,FT-2000+/64\n")])])])]),a._v(" "),e("li",[e("p",[a._v("Doris 版本")]),a._v(" "),e("p",[a._v("commit 68bab73")])])]),a._v(" "),e("h2",{attrs:{id:"编译工具安装（无网络）"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#编译工具安装（无网络）"}},[a._v("#")]),a._v(" 编译工具安装（无网络）")]),a._v(" "),e("p",[a._v("示例中，所有工具安装在在 "),e("code",[a._v("/home/doris/tools/installed/")]),a._v(" 目录下。")]),a._v(" "),e("p",[a._v("所需安装包请先在有网络情况下获取。")]),a._v(" "),e("h3",{attrs:{id:"_1-安装gcc10"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装gcc10"}},[a._v("#")]),a._v(" 1. 安装gcc10")]),a._v(" "),e("p",[a._v("下载 gcc-10.1.0")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("wget https://mirrors.tuna.tsinghua.edu.cn/gnu/gcc/gcc-10.1.0/gcc-10.1.0.tar.gz\n")])])]),e("p",[a._v("解压后，在 "),e("code",[a._v("contrib/download_prerequisites")]),a._v(" 查看依赖并下载：")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("http://gcc.gnu.org/pub/gcc/infrastructure/gmp-6.1.0.tar.bz2\nhttp://gcc.gnu.org/pub/gcc/infrastructure/mpfr-3.1.4.tar.bz2\nhttp://gcc.gnu.org/pub/gcc/infrastructure/mpc-1.0.3.tar.gz\nhttp://gcc.gnu.org/pub/gcc/infrastructure/isl-0.18.tar.bz2\n")])])]),e("p",[a._v("解压这四个依赖，然后移动到 gcc-10.1.0 源码目录下，并重命名为 gmp、isl、mpc、mpfr。")]),a._v(" "),e("p",[a._v("下载并安装 automake-1.15（因为gcc10编译过程中会查找automake 1.15 版本）")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("https://ftp.gnu.org/gnu/automake/automake-1.15.tar.gz\ntar xzf automake-1.15.tar.gz\n./configure --prefix=/home/doris/tools/installed\nmake && make install\nexport PATH=/home/doris/tools/installed/bin:$PATH\n")])])]),e("p",[a._v("编译GCC10:")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("cd gcc-10.1.0\n./configure --prefix=/home/doris/tools/installed\nmake -j && make install\n")])])]),e("p",[a._v("编译时间较长。")]),a._v(" "),e("h3",{attrs:{id:"_2-安装其他编译组件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-安装其他编译组件"}},[a._v("#")]),a._v(" 2. 安装其他编译组件")]),a._v(" "),e("ol",[e("li",[e("p",[a._v("jdk-8u291-linux-aarch64.tar.gz")]),a._v(" "),e("p",[e("code",[a._v("https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html")])]),a._v(" "),e("p",[a._v("无需编译，开箱即用。")])]),a._v(" "),e("li",[e("p",[a._v("cmake-3.19.8-Linux-aarch64.tar.gz")]),a._v(" "),e("p",[e("code",[a._v("https://cmake.org/download/")])]),a._v(" "),e("p",[a._v("无需编译，开箱即用")])]),a._v(" "),e("li",[e("p",[a._v("apache-maven-3.8.1-bin.tar.gz")]),a._v(" "),e("p",[e("code",[a._v("https://maven.apache.org/download.cgi")])]),a._v(" "),e("p",[a._v("无需编译，开箱即用")])]),a._v(" "),e("li",[e("p",[a._v("nodejs 16.3.0")]),a._v(" "),e("p",[e("code",[a._v("https://nodejs.org/dist/v16.3.0/node-v16.3.0-linux-arm64.tar.xz")])]),a._v(" "),e("p",[a._v("无需编译，开箱即用")])]),a._v(" "),e("li",[e("p",[a._v("libtool-2.4.6.tar.gz")]),a._v(" "),e("p",[a._v("编译第三方组件用，虽然系统可能自带了libtool，但是libtool需要和automake在一起，这样不容易出问题。")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("https://ftp.gnu.org/gnu/libtool/libtool-2.4.6.tar.gz\ncd  libtool-2.4.6/\n./configure --prefix=/home/doris/tools/installed\nmake -j && make install\n")])])])]),a._v(" "),e("li",[e("p",[a._v("binutils-2.36.tar.xz（获取bdf.h）")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("https://ftp.gnu.org/gnu/binutils/binutils-2.36.tar.bz2\n./configure --prefix=/home/doris/tools/installed\nmake -j && make install\n")])])])]),a._v(" "),e("li",[e("p",[a._v("libiberty（编译BE用）")]),a._v(" "),e("p",[a._v("这个库的源码就在 gcc-10.1.0 的源码包下")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("cd gcc-10.1.0/libiberty/\n./configure --prefix=/home/doris/tools/installed\nmake\n")])])]),e("p",[a._v("编译后会产生 libiberty.a，后续移动到 Doris 的thirdparty 的 lib64 目录中即可。")])])]),a._v(" "),e("h3",{attrs:{id:"_3-编译第三方库"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-编译第三方库"}},[a._v("#")]),a._v(" 3. 编译第三方库")]),a._v(" "),e("p",[a._v("假设Doris源码在 "),e("code",[a._v("/home/doris/doris-src/")]),a._v(" 下。")]),a._v(" "),e("ol",[e("li",[e("p",[a._v("手动下载所有第三方库并放在 thirdparty/src 目录下。")])]),a._v(" "),e("li",[e("p",[a._v("在Doris源码目录下新增 "),e("code",[a._v("custom_env.sh")]),a._v(" 并添加如下内容")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("export DORIS_THIRDPARTY=/home/doris/doris-src/thirdparty/\nexport JAVA_HOME=/home/doris/tools/jdk1.8.0_291/\nexport DORIS_GCC_HOME=/home/doris/tools/installed/\nexport PATCH_COMPILER_RT=true\n")])])]),e("p",[a._v("注意替换对应的目录")])]),a._v(" "),e("li",[e("p",[a._v("修改 build-thirdparty.sh 中的部分内容")]),a._v(" "),e("ol",[e("li",[e("p",[a._v("关闭 "),e("code",[a._v("build_mysql")]),a._v(" 和 "),e("code",[a._v("build_libhdfs3")])]),a._v(" "),e("p",[a._v("mysql 不在需要。而 libhdfs3 暂不支持 arm 架构，所以在arm中运行Doris，暂不支持通过 libhdfs3 直接访问 hdfs，需要通过broker。")])]),a._v(" "),e("li",[e("p",[a._v("在 "),e("code",[a._v("build_curl")]),a._v(" 中增加 configure 参数："),e("code",[a._v("--without-libpsl")]),a._v("。如果不添加，则在最终编译Doris BE的链接阶段，可能报错："),e("code",[a._v("undefined reference to ‘psl_is_cookie_domain_acceptable'")])])])])]),a._v(" "),e("li",[e("p",[a._v("执行 build-thirdparty.sh。这里仅列举可能出现的错误")]),a._v(" "),e("ul",[e("li",[e("p",[e("code",[a._v("error: narrowing conversion of '-1' from 'int' to 'char' [-Wnarrowing]")])]),a._v(" "),e("p",[a._v("编译brpc 0.9.7 时会出现错误，解决方案，在 brpc 的 CMakeLists.txt 的 "),e("code",[a._v("CMAKE_CXX_FLAGS")]),a._v(" 中添加 "),e("code",[a._v("-Wno-narrowing")]),a._v("。brpc master 代码中已经修复这个问题：")]),a._v(" "),e("p",[e("code",[a._v("https://github.com/apache/incubator-brpc/issues/1091")])])]),a._v(" "),e("li",[e("p",[e("code",[a._v("libz.a(deflate.o): relocation R_AARCH64_ADR_PREL_PG_HI21 against symbol")]),a._v("z_errmsg' which may bind externally can not be used when making a shared object; recompile with -fPIC`")]),a._v(" "),e("p",[a._v("编译brpc 0.9.7 时会出现错误，还有 libcrypto 也会报类似错误。原因未知，似乎在 aarch64 下，brpc 需要链接动态的 zlib 和 crypto 库。但是我们在编译这两个第三方库时，都只编译的了 .a 静态文件。解决方案：重新编译zlib和 openssl 生成.so 动态库：")]),a._v(" "),e("p",[a._v("打开 "),e("code",[a._v("build-thirdparty.sh")]),a._v("，找到 "),e("code",[a._v("build_zlib")]),a._v(" 函数，将：")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("./configure --prefix=$TP_INSTALL_DIR --static\n就改为\n./configure --prefix=$TP_INSTALL_DIR\n")])])]),e("p",[a._v("找到 "),e("code",[a._v("build_openssl")]),a._v("，将以下部分注释掉：")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("#if [ -f $TP_INSTALL_DIR/lib64/libcrypto.so ]; then\n#    rm -rf $TP_INSTALL_DIR/lib64/libcrypto.so*\n#fi\n#if [ -f $TP_INSTALL_DIR/lib64/libssl.so ]; then\n#    rm -rf $TP_INSTALL_DIR/lib64/libssl.so*\n#fi\n")])])]),e("p",[a._v("然后来到 "),e("code",[a._v("build-thirdparty.sh")]),a._v("，注释掉其他 "),e("code",[a._v("build_xxx")]),a._v("，仅打开 "),e("code",[a._v("build_zlib")]),a._v(" 和 "),e("code",[a._v("build_openssl")]),a._v("，以及 "),e("code",[a._v("build_brpc")]),a._v(" 和之后的 "),e("code",[a._v("build_xxx")]),a._v("。然后重新执行 "),e("code",[a._v("build-thirdparty.sh")]),a._v("。")])]),a._v(" "),e("li",[e("p",[a._v("编译到某个阶段卡住不动。")]),a._v(" "),e("p",[a._v("不确定原因。解决方案：重跑 "),e("code",[a._v("build-thirdparty.sh")]),a._v("。"),e("code",[a._v("build-thirdparty.sh")]),a._v(" 是可以重复执行的。")])])])])]),a._v(" "),e("h3",{attrs:{id:"_4-编译doris源码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-编译doris源码"}},[a._v("#")]),a._v(" 4. 编译Doris源码")]),a._v(" "),e("p",[a._v("执行 sh build.sh 即可。")])])}),[],!1,null,null,null);t.default=r.exports}}]);