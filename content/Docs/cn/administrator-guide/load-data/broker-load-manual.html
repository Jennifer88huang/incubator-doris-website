

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Broker Load &mdash; Doris Documentations 0.11.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Stream load" href="stream-load-manual.html" />
    <link rel="prev" title="导入总览" href="load-manual.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Doris Documentations
          

          
          </a>

          
            
            
              <div class="version">
                0.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installing/index.html">编译与部署</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">开始使用</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">操作手册</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">数据导入</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="load-manual.html">导入总览</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Broker Load</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">适用场景</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">名词解释</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">基本原理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">基本操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">相关系统配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">最佳实践</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">常见问题</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="stream-load-manual.html">Stream load</a></li>
<li class="toctree-l3"><a class="reference internal" href="routine-load-manual.html">Routine Load</a></li>
<li class="toctree-l3"><a class="reference internal" href="insert-into-manual.html">Insert Into</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../http-actions/index.html">HTTP API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operation/index.html">运维操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alter-table/index.html">表结构变更</a></li>
<li class="toctree-l2"><a class="reference internal" href="../backup-restore.html">备份与恢复</a></li>
<li class="toctree-l2"><a class="reference internal" href="../colocation-join.html">Colocation Join</a></li>
<li class="toctree-l2"><a class="reference internal" href="../export_manual.html">数据导出</a></li>
<li class="toctree-l2"><a class="reference internal" href="../privilege.html">权限管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../small-file-mgr.html">文件管理器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../time-zone.html">时区</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../extending-doris/index.html">扩展功能</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/index.html">设计文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql-reference/index.html">SQL 手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/index.html">Apache 社区</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Doris Documentations</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">操作手册</a> &raquo;</li>
        
          <li><a href="index.html">数据导入</a> &raquo;</li>
        
      <li>Broker Load</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/Docs/cn/administrator-guide/load-data/broker-load-manual.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="broker-load">
<h1>Broker Load<a class="headerlink" href="#broker-load" title="Permalink to this headline">¶</a></h1>
<p>Broker load 是一个异步的导入方式，支持的数据源取决于 Broker 进程支持的数据源。</p>
<p>用户需要通过 MySQL 协议 创建 Broker load 导入，并通过查看导入命令检查导入结果。</p>
<div class="section" id="id1">
<h2>适用场景<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>源数据在 Broker 可以访问的存储系统中，如 HDFS。</li>
<li>数据量在 几十到百GB 级别。</li>
</ul>
</div>
<div class="section" id="id2">
<h2>名词解释<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li>Frontend（FE）：Doris 系统的元数据和调度节点。在导入流程中主要负责导入 plan 生成和导入任务的调度工作。</li>
<li>Backend（BE）：Doris 系统的计算和存储节点。在导入流程中主要负责数据的 ETL 和存储。</li>
<li>Broker：Broker 为一个独立的无状态进程。封装了文件系统接口，提供 Doris 读取远端存储系统中文件的能力。</li>
<li>Plan：导入执行计划，BE 会执行导入执行计划将数据导入到 Doris 系统中。</li>
</ol>
</div>
<div class="section" id="id3">
<h2>基本原理<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>用户在提交导入任务后，FE 会生成对应的 Plan 并根据目前 BE 的个数和文件的大小，将 Plan 分给 多个 BE 执行，每个 BE 执行一部分导入数据。</p>
<p>BE 在执行的过程中会从 Broker 拉取数据，在对数据 transform 之后将数据导入系统。所有 BE 均完成导入，由 FE 最终决定导入是否成功。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                 <span class="o">+</span>
                 <span class="o">|</span> <span class="mf">1.</span> <span class="n">user</span> <span class="n">create</span> <span class="n">broker</span> <span class="n">load</span>
                 <span class="n">v</span>
            <span class="o">+----+----+</span>
            <span class="o">|</span>         <span class="o">|</span>
            <span class="o">|</span>   <span class="n">FE</span>    <span class="o">|</span>
            <span class="o">|</span>         <span class="o">|</span>
            <span class="o">+----+----+</span>
                 <span class="o">|</span>
                 <span class="o">|</span> <span class="mf">2.</span> <span class="n">BE</span> <span class="n">etl</span> <span class="ow">and</span> <span class="n">load</span> <span class="n">the</span> <span class="n">data</span>
    <span class="o">+--------------------------+</span>
    <span class="o">|</span>            <span class="o">|</span>             <span class="o">|</span>
<span class="o">+---</span><span class="n">v</span><span class="o">---+</span>     <span class="o">+--</span><span class="n">v</span><span class="o">----+</span>    <span class="o">+---</span><span class="n">v</span><span class="o">---+</span>
<span class="o">|</span>       <span class="o">|</span>     <span class="o">|</span>       <span class="o">|</span>    <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span>  <span class="n">BE</span>   <span class="o">|</span>     <span class="o">|</span>  <span class="n">BE</span>   <span class="o">|</span>    <span class="o">|</span>   <span class="n">BE</span>  <span class="o">|</span>
<span class="o">|</span>       <span class="o">|</span>     <span class="o">|</span>       <span class="o">|</span>    <span class="o">|</span>       <span class="o">|</span>
<span class="o">+---+-^-+</span>     <span class="o">+---+-^-+</span>    <span class="o">+--+-^--+</span>
    <span class="o">|</span> <span class="o">|</span>           <span class="o">|</span> <span class="o">|</span>         <span class="o">|</span> <span class="o">|</span>
    <span class="o">|</span> <span class="o">|</span>           <span class="o">|</span> <span class="o">|</span>         <span class="o">|</span> <span class="o">|</span> <span class="mf">3.</span> <span class="n">pull</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">broker</span>
<span class="o">+---</span><span class="n">v</span><span class="o">-+-+</span>     <span class="o">+---</span><span class="n">v</span><span class="o">-+-+</span>    <span class="o">+--</span><span class="n">v</span><span class="o">-+--+</span>
<span class="o">|</span>       <span class="o">|</span>     <span class="o">|</span>       <span class="o">|</span>    <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span><span class="n">Broker</span> <span class="o">|</span>     <span class="o">|</span><span class="n">Broker</span> <span class="o">|</span>    <span class="o">|</span><span class="n">Broker</span> <span class="o">|</span>
<span class="o">|</span>       <span class="o">|</span>     <span class="o">|</span>       <span class="o">|</span>    <span class="o">|</span>       <span class="o">|</span>
<span class="o">+---+-^-+</span>     <span class="o">+---+-^-+</span>    <span class="o">+---+-^-+</span>
    <span class="o">|</span> <span class="o">|</span>           <span class="o">|</span> <span class="o">|</span>          <span class="o">|</span> <span class="o">|</span>
<span class="o">+---</span><span class="n">v</span><span class="o">-+-----------</span><span class="n">v</span><span class="o">-+----------</span><span class="n">v</span><span class="o">-+-+</span>
<span class="o">|</span>       <span class="n">HDFS</span><span class="o">/</span><span class="n">BOS</span><span class="o">/</span><span class="n">AFS</span> <span class="n">cluster</span>       <span class="o">|</span>
<span class="o">|</span>                                  <span class="o">|</span>
<span class="o">+----------------------------------+</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>基本操作<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id5">
<h3>创建导入<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>Broker load 创建导入语句</p>
<p>语法：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LOAD</span> <span class="n">LABEL</span> <span class="n">db_name</span><span class="o">.</span><span class="n">label_name</span> 
<span class="p">(</span><span class="n">data_desc</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">WITH</span> <span class="n">BROKER</span> <span class="n">broker_name</span> <span class="n">broker_properties</span>
<span class="p">[</span><span class="n">PROPERTIES</span> <span class="p">(</span><span class="n">key1</span><span class="o">=</span><span class="n">value1</span><span class="p">,</span> <span class="o">...</span> <span class="p">)]</span>

<span class="o">*</span> <span class="n">data_desc</span><span class="p">:</span>

    <span class="n">DATA</span> <span class="n">INFILE</span> <span class="p">(</span><span class="s1">&#39;file_path&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="p">[</span><span class="n">NEGATIVE</span><span class="p">]</span>
    <span class="n">INTO</span> <span class="n">TABLE</span> <span class="n">tbl_name</span>
    <span class="p">[</span><span class="n">PARTITION</span> <span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">COLUMNS</span> <span class="n">TERMINATED</span> <span class="n">BY</span> <span class="n">separator</span> <span class="p">]</span>
    <span class="p">[(</span><span class="n">col1</span><span class="p">,</span> <span class="o">...</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">SET</span> <span class="p">(</span><span class="n">k1</span><span class="o">=</span><span class="n">f1</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">k2</span><span class="o">=</span><span class="n">f2</span><span class="p">(</span><span class="n">xx</span><span class="p">))]</span>

<span class="o">*</span> <span class="n">broker_properties</span><span class="p">:</span> 

    <span class="p">(</span><span class="n">key1</span><span class="o">=</span><span class="n">value1</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LOAD</span> <span class="n">LABEL</span> <span class="n">db1</span><span class="o">.</span><span class="n">label1</span>
<span class="p">(</span>
    <span class="n">DATA</span> <span class="n">INFILE</span><span class="p">(</span><span class="s2">&quot;hdfs://abc.com:8888/user/palo/test/ml/file1&quot;</span><span class="p">)</span>
    <span class="n">INTO</span> <span class="n">TABLE</span> <span class="n">tbl1</span>
    <span class="n">COLUMNS</span> <span class="n">TERMINATED</span> <span class="n">BY</span> <span class="s2">&quot;,&quot;</span>
    <span class="p">(</span><span class="n">tmp_c1</span><span class="p">,</span><span class="n">tmp_c2</span><span class="p">)</span>
    <span class="n">SET</span>
    <span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">tmp_c2</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">tmp_c1</span>
    <span class="p">),</span>
    <span class="n">DATA</span> <span class="n">INFILE</span><span class="p">(</span><span class="s2">&quot;hdfs://abc.com:8888/user/palo/test/ml/file2&quot;</span><span class="p">)</span>
    <span class="n">INTO</span> <span class="n">TABLE</span> <span class="n">tbl2</span>
    <span class="n">COLUMNS</span> <span class="n">TERMINATED</span> <span class="n">BY</span> <span class="s2">&quot;,&quot;</span>
    <span class="p">(</span><span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">WITH</span> <span class="n">BROKER</span> <span class="s1">&#39;broker&#39;</span>
<span class="p">(</span>
    <span class="s2">&quot;username&quot;</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="o">=</span><span class="s2">&quot;pass&quot;</span>
<span class="p">)</span>
<span class="n">PROPERTIES</span>
<span class="p">(</span>
    <span class="s2">&quot;timeout&quot;</span> <span class="o">=</span> <span class="s2">&quot;3600&quot;</span>
<span class="p">);</span>
</pre></div>
</div>
<p>创建导入的详细语法执行 <code class="docutils literal notranslate"><span class="pre">HELP</span> <span class="pre">BROKER</span> <span class="pre">LOAD</span></code> 查看语法帮助。这里主要介绍 Broker load 的创建导入语法中参数意义和注意事项。</p>
<div class="section" id="label">
<h4>Label<a class="headerlink" href="#label" title="Permalink to this headline">¶</a></h4>
<p>导入任务的标识。每个导入任务，都有一个在单 database 内部唯一的 Label。Label 是用户在导入命令中自定义的名称。通过这个 Label，用户可以查看对应导入任务的执行情况。</p>
<p>Label 的另一个作用，是防止用户重复导入相同的数据。<strong>强烈推荐用户同一批次数据使用相同的label。这样同一批次数据的重复请求只会被接受一次，保证了 At-Most-Once 语义</strong></p>
<p>当 Label 对应的导入作业状态为 CANCELLED 时，可以再次使用该 Label 提交导入作业。</p>
</div>
<div class="section" id="id6">
<h4>数据描述类参数<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>数据描述类参数主要指的是 Broker load 创建导入语句中的属于 <code class="docutils literal notranslate"><span class="pre">data_desc</span></code> 部分的参数。每组 <code class="docutils literal notranslate"><span class="pre">data_desc</span> </code> 主要表述了本次导入涉及到的数据源地址，ETL 函数，目标表及分区等信息。</p>
<p>下面主要对数据描述类的部分参数详细解释：</p>
<ul>
<li><p class="first">多表导入</p>
<p>Broker load 支持一次导入任务涉及多张表，每个 Broker load 导入任务可在多个 <code class="docutils literal notranslate"><span class="pre">data_desc</span></code> 声明多张表来实现多表导入。每个单独的 <code class="docutils literal notranslate"><span class="pre">data_desc</span></code> 还可以指定属于该表的数据源地址。Broker load 保证了单次导入的多张表之间原子性成功或失败。</p>
</li>
<li><p class="first">negative</p>
<p><code class="docutils literal notranslate"><span class="pre">data_desc</span></code>中还可以设置数据取反导入。这个功能主要用于，当数据表中聚合列的类型都为 SUM 类型时。如果希望撤销某一批导入的数据。则可以通过 <code class="docutils literal notranslate"><span class="pre">negative</span></code> 参数当如同一批数据。Doris 会自动为这一批数据在聚合列上数据取反，以达到消除同一批数据的功能。</p>
</li>
<li><p class="first">partition</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">data_desc</span></code> 中可以指定待导入表的 partition 信息，如果待导入数据不属于指定的 partition 则不会被导入。同时，不在指定 Partition 的数据会被认为是错误数据。</p>
</li>
<li><p class="first">set column mapping</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">data_desc</span></code> 中的 SET 语句负责设置列函数变换，这里的列函数变换支持所有查询的等值表达式变换。如果原始数据的列和表中的列不一一对应，就需要用到这个属性。</p>
</li>
</ul>
</div>
<div class="section" id="id7">
<h4>导入作业参数<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>导入作业参数主要指的是 Broker load 创建导入语句中的属于 <code class="docutils literal notranslate"><span class="pre">opt_properties</span></code>部分的参数。导入作业参数是作用于整个导入作业的。</p>
<p>下面主要对导入作业参数的部分参数详细解释：</p>
<ul>
<li><p class="first">timeout</p>
<p>导入作业的超时时间(以秒为单位)，用户可以在 <code class="docutils literal notranslate"><span class="pre">opt_properties</span></code> 中自行设置每个导入的超时时间。导入任务在设定的 timeout 时间内未完成则会被系统取消，变成 CANCELLED。Broker load 的默认导入超时时间为4小时。</p>
<p>通常情况下，用户不需要手动设置导入任务的超时时间。当在默认超时时间内无法完成导入时，可以手动设置任务的超时时间。</p>
<blockquote>
<div><p>推荐超时时间</p>
<p>总文件大小（MB） / 用户 Doris 集群最慢导入速度(MB/s)  &gt; timeout &gt; （（总文件大小(MB) * 待导入的表及相关 Roll up 表的个数） / (10 * 导入并发数） ）</p>
</div></blockquote>
<blockquote>
<div><p>导入并发数见文档最后的导入系统配置说明，公式中的 10 为目前的导入限速 10MB/s。</p>
</div></blockquote>
<blockquote>
<div><p>例如一个 1G 的待导入数据，待导入表包含3个 Rollup 表，当前的导入并发数为 3。则 timeout 的 最小值为 <code class="docutils literal notranslate"><span class="pre">(1</span> <span class="pre">*</span> <span class="pre">1024</span> <span class="pre">*</span> <span class="pre">3</span> <span class="pre">)</span> <span class="pre">/</span> <span class="pre">(10</span> <span class="pre">*</span> <span class="pre">3)</span> <span class="pre">=</span> <span class="pre">102</span> <span class="pre">秒</span></code></p>
</div></blockquote>
<p>由于每个 Doris 集群的机器环境不同且集群并发的查询任务也不同，所以用户 Doris 集群的最慢导入速度需要用户自己根据历史的导入任务速度进行推测。</p>
</li>
<li><p class="first">max_filter_ratio</p>
<p>导入任务的最大容忍率，默认为0容忍，取值范围是0~1。当导入的错误率超过该值，则导入失败。</p>
<p>如果用户希望忽略错误的行，可以通过设置这个参数大于 0，来保证导入可以成功。</p>
<p>计算公式为：</p>
<p><code class="docutils literal notranslate"><span class="pre">(dpp.abnorm.ALL</span> <span class="pre">/</span> <span class="pre">(dpp.abnorm.ALL</span> <span class="pre">+</span> <span class="pre">dpp.norm.ALL</span> <span class="pre">)</span> <span class="pre">)</span> <span class="pre">&gt;</span> <span class="pre">max_filter_ratio</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">dpp.abnorm.ALL</span></code> 表示数据质量不合格的行数。如类型不匹配，列数不匹配，长度不匹配等等。</p>
<p><code class="docutils literal notranslate"><span class="pre">dpp.norm.ALL</span></code> 指的是导入过程中正确数据的条数。可以通过 <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">LOAD</span></code> 命令查询导入任务的正确数据量。</p>
<p>原始文件的行数 = <code class="docutils literal notranslate"><span class="pre">dpp.abnorm.ALL</span> <span class="pre">+</span> <span class="pre">dpp.norm.ALL</span></code></p>
</li>
<li><p class="first">exec_mem_limit</p>
<p>导入任务的内存使用上限。当导入任务使用的内存超过设定上限时，导入任务会被 CANCEL。默认为 2G，单位为字节。</p>
<p>当导入出现 <code class="docutils literal notranslate"><span class="pre">Memory</span> <span class="pre">exceed</span> <span class="pre">limit</span></code> 错误时，可以适当调整这个参数，如调整为 4G、8G 等。</p>
</li>
<li><p class="first">strict_mode</p>
<p>Broker load 导入可以开启 strict mode 模式。开启方式为 <code class="docutils literal notranslate"><span class="pre">properties</span> <span class="pre">(&quot;strict_mode&quot;</span> <span class="pre">=</span> <span class="pre">&quot;true&quot;)</span></code> 。默认的 strict mode 为开启。</p>
<p>strict mode 模式的意思是：对于导入过程中的列类型转换进行严格过滤。严格过滤的策略如下：</p>
<ol class="simple">
<li>对于列类型转换来说，如果 strict mode 为true，则错误的数据将被 filter。这里的错误数据是指：原始数据并不为空值，在参与列类型转换后结果为空值的这一类数据。</li>
<li>对于导入的某列由函数变换生成时，strict mode 对其不产生影响。</li>
<li>对于导入的某列类型包含范围限制的，如果原始数据能正常通过类型转换，但无法通过范围限制的，strict mode 对其也不产生影响。例如：如果类型是 decimal(1,0), 原始数据为 10，则属于可以通过类型转换但不在列声明的范围内。这种数据 strict 对其不产生影响。</li>
</ol>
</li>
</ul>
</div>
<div class="section" id="strict-mode-source-data">
<h4>strict mode 与 source data 的导入关系<a class="headerlink" href="#strict-mode-source-data" title="Permalink to this headline">¶</a></h4>
<p>这里以列类型为 TinyInt 来举例</p>
<blockquote>
<div>注：当表中的列允许导入空值时</div></blockquote>
<table border="1" class="docutils">
<thead>
<tr>
<th>source data</th>
<th>source data example</th>
<th>string to int</th>
<th>strict_mode</th>
<th>result</th>
</tr>
</thead>
<tbody>
<tr>
<td>空值</td>
<td>\N</td>
<td>N/A</td>
<td>true or false</td>
<td>NULL</td>
</tr>
<tr>
<td>not null</td>
<td>aaa or 2000</td>
<td>NULL</td>
<td>true</td>
<td>invalid data(filtered)</td>
</tr>
<tr>
<td>not null</td>
<td>aaa</td>
<td>NULL</td>
<td>false</td>
<td>NULL</td>
</tr>
<tr>
<td>not null</td>
<td>1</td>
<td>1</td>
<td>true or false</td>
<td>correct data</td>
</tr>
</tbody>
</table><p>这里以列类型为 Decimal(1,0) 举例</p>
<blockquote>
<div>注：当表中的列允许导入空值时</div></blockquote>
<table border="1" class="docutils">
<thead>
<tr>
<th>source data</th>
<th>source data example</th>
<th>string to int</th>
<th>strict_mode</th>
<th>result</th>
</tr>
</thead>
<tbody>
<tr>
<td>空值</td>
<td>\N</td>
<td>N/A</td>
<td>true or false</td>
<td>NULL</td>
</tr>
<tr>
<td>not null</td>
<td>aaa</td>
<td>NULL</td>
<td>true</td>
<td>invalid data(filtered)</td>
</tr>
<tr>
<td>not null</td>
<td>aaa</td>
<td>NULL</td>
<td>false</td>
<td>NULL</td>
</tr>
<tr>
<td>not null</td>
<td>1 or 10</td>
<td>1</td>
<td>true or false</td>
<td>correct data</td>
</tr>
</tbody>
</table><blockquote>
<div>注意：10 虽然是一个超过范围的值，但是因为其类型符合 decimal的要求，所以 strict mode对其不产生影响。10 最后会在其他 ETL 处理流程中被过滤。但不会被 strict mode 过滤。</div></blockquote>
</div>
</div>
<div class="section" id="id8">
<h3>查看导入<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>Broker load 导入方式由于是异步的，所以用户必须将创建导入的 Label 记录，并且在<strong>查看导入命令中使用 Label 来查看导入结果</strong>。查看导入命令在所有导入方式中是通用的，具体语法可执行 <code class="docutils literal notranslate"><span class="pre">HELP</span> <span class="pre">SHOW</span> <span class="pre">LOAD</span></code> 查看。</p>
<p>示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mysql&gt; show load order by createtime desc limit 1\G
*************************** 1. row ***************************
         JobId: 76391
         Label: label1
         State: FINISHED
      Progress: ETL:N/A; LOAD:100%
          Type: BROKER
       EtlInfo: dpp.abnorm.ALL=15; dpp.norm.ALL=28133376
      TaskInfo: cluster:N/A; timeout(s):10800; max_filter_ratio:5.0E-5
      ErrorMsg: N/A
    CreateTime: 2019-07-27 11:46:42
  EtlStartTime: 2019-07-27 11:46:44
 EtlFinishTime: 2019-07-27 11:46:44
 LoadStartTime: 2019-07-27 11:46:44
LoadFinishTime: 2019-07-27 11:50:16
           URL: http://192.168.1.1:8040/api/_load_error_log?file=__shard_4/error_log_insert_stmt_4bb00753932c491a-a6da6e2725415317_4bb00753932c491a_a6da6e2725415317
</pre></div>
</div>
<p>下面主要介绍了查看导入命令返回结果集中参数意义：</p>
<ul>
<li><p class="first">JobId</p>
<p>导入任务的唯一ID，每个导入任务的 JobId 都不同，有系统自动生成。与 Label 不同的是，JobId永远不会相同，而 Label 则可以在导入任务失败后被复用。</p>
</li>
<li><p class="first">Label</p>
<p>导入任务的标识。</p>
</li>
<li><p class="first">State</p>
<p>导入任务当前所处的阶段。在 Broker load 导入过程中主要会出现 PENDING 和 LOADING 这两个导入中的状态。如果 Broker load 处于 PENDING 状态，则说明当前导入任务正在等待被执行；LOADING 状态则表示正在执行中。</p>
<p>导入任务的最终阶段有两个：CANCELLED 和 FINISHED，当 Load job 处于这两个阶段时，导入完成。其中 CANCELLED 为导入失败，FINISHED 为导入成功。</p>
</li>
<li><p class="first">Progress</p>
<p>导入任务的进度描述。分为两种进度：ETL 和 LOAD，对应了导入流程的两个阶段 ETL 和 LOADING。目前 Broker load 由于只有 LOADING 阶段，所以 ETL 则会永远显示为 <code class="docutils literal notranslate"><span class="pre">N/A</span></code></p>
<p>LOAD 的进度范围为：0~100%。</p>
<p><code class="docutils literal notranslate"><span class="pre">LOAD</span> <span class="pre">进度</span> <span class="pre">=</span> <span class="pre">当前完成导入的表个数</span> <span class="pre">/</span> <span class="pre">本次导入任务设计的总表个数</span> <span class="pre">*</span> <span class="pre">100%</span></code></p>
<p><strong>如果所有导入表均完成导入，此时 LOAD 的进度为 99%</strong> 导入进入到最后生效阶段，整个导入完成后，LOAD 的进度才会改为 100%。</p>
<p>导入进度并不是线性的。所以如果一段时间内进度没有变化，并不代表导入没有在执行。</p>
</li>
<li><p class="first">Type</p>
<p>导入任务的类型。Broker load 的 type 取值只有 BROKER。</p>
</li>
<li><p class="first">EtlInfo</p>
<p>主要显示了导入的数据量指标 <code class="docutils literal notranslate"><span class="pre">dpp.norm.ALL</span> <span class="pre">和</span> <span class="pre">dpp.abnorm.ALL</span></code>。用户可以根据这两个指标验证当前导入任务的错误率是否超过 max_filter_ratio。</p>
</li>
<li><p class="first">TaskInfo</p>
<p>主要显示了当前导入任务参数，也就是创建 Broker load 导入任务时用户指定的导入任务参数，包括：<code class="docutils literal notranslate"><span class="pre">cluster</span></code>，<code class="docutils literal notranslate"><span class="pre">timeout</span></code> 和<code class="docutils literal notranslate"><span class="pre">max_filter_ratio</span></code>。</p>
</li>
<li><p class="first">ErrorMsg</p>
<p>在导入任务状态为CANCELLED，会显示失败的原因，显示分两部分：type 和 msg，如果导入任务成功则显示 <code class="docutils literal notranslate"><span class="pre">N/A</span></code>。</p>
<p>type的取值意义：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>USER_CANCEL: 用户取消的任务
ETL_RUN_FAIL：在ETL阶段失败的导入任务
ETL_QUALITY_UNSATISFIED：数据质量不合格，也就是错误数据率超过了 max_filter_ratio
LOAD_RUN_FAIL：在LOADING阶段失败的导入任务
TIMEOUT：导入任务没在超时时间内完成
UNKNOWN：未知的导入错误
</pre></div>
</div>
</li>
<li><p class="first">CreateTime/EtlStartTime/EtlFinishTime/LoadStartTime/LoadFinishTime</p>
<p>这几个值分别代表导入创建的时间，ETL阶段开始的时间，ETL阶段完成的时间，Loading阶段开始的时间和整个导入任务完成的时间。</p>
<p>Broker load 导入由于没有 ETL 阶段，所以其 EtlStartTime, EtlFinishTime, LoadStartTime 被设置为同一个值。</p>
<p>导入任务长时间停留在 CreateTime，而 LoadStartTime 为 N/A 则说明目前导入任务堆积严重。用户可减少导入提交的频率。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LoadFinishTime</span> <span class="o">-</span> <span class="n">CreateTime</span> <span class="o">=</span> <span class="n">整个导入任务所消耗时间</span>
<span class="n">LoadFinishTime</span> <span class="o">-</span> <span class="n">LoadStartTime</span> <span class="o">=</span> <span class="n">整个</span> <span class="n">Broker</span> <span class="n">load</span> <span class="n">导入任务执行时间</span> <span class="o">=</span> <span class="n">整个导入任务所消耗时间</span> <span class="o">-</span> <span class="n">导入任务等待的时间</span>
</pre></div>
</div>
</li>
<li><p class="first">URL</p>
<p>导入任务的错误数据样例，访问 URL 地址既可获取本次导入的错误数据样例。当本次导入不存在错误数据时，URL 字段则为 N/A。</p>
</li>
</ul>
</div>
<div class="section" id="id9">
<h3>取消导入<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>当 Broker load 作业状态不为 CANCELLED 或 FINISHED 时，可以被用户手动取消。取消时需要指定待取消导入任务的 Label 。取消导入命令语法可执行 <code class="docutils literal notranslate"><span class="pre">HELP</span> <span class="pre">CANCEL</span> <span class="pre">LOAD</span></code>查看。</p>
</div>
</div>
<div class="section" id="id10">
<h2>相关系统配置<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<div class="section" id="fe">
<h3>FE 配置<a class="headerlink" href="#fe" title="Permalink to this headline">¶</a></h3>
<p>下面几个配置属于 Broker load 的系统级别配置，也就是作用于所有 Broker load 导入任务的配置。主要通过修改 <code class="docutils literal notranslate"> <span class="pre">fe.conf</span></code>来调整配置值。</p>
<ul>
<li><p class="first">min_bytes_per_broker_scanner/max_bytes_per_broker_scanner/max_broker_concurrency</p>
<p>前两个配置限制了单个 BE 处理的数据量的最小和最大值。第三个配置限制了一个作业的最大的导入并发数。最小处理的数据量，最大并发数，源文件的大小和当前集群 BE 的个数 <strong>共同决定了本次导入的并发数</strong>。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>本次导入并发数 = Math.min(源文件大小/最小处理量，最大并发数，当前BE节点个数)
本次导入单个BE的处理量 = 源文件大小/本次导入的并发数
</pre></div>
</div>
<p>通常一个导入作业支持的最大数据量为 <code class="docutils literal notranslate"><span class="pre">max_bytes_per_broker_scanner</span> <span class="pre">*</span> <span class="pre">BE</span> <span class="pre">节点数</span></code>。如果需要导入更大数据量，则需要适当调整 <code class="docutils literal notranslate"><span class="pre">max_bytes_per_broker_scanner</span></code> 参数的大小。</p>
<p>默认配置：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>参数名：min_bytes_per_broker_scanner， 默认 64MB，单位bytes。
参数名：max_broker_concurrency， 默认 10。
参数名：max_bytes_per_broker_scanner，默认 3G，单位bytes。
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="id11">
<h2>最佳实践<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id12">
<h3>应用场景<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>使用 Broker load 最适合的场景就是原始数据在文件系统（HDFS，BOS，AFS）中的场景。其次，由于 Broker load 是单次导入中唯一的一种异步导入的方式，所以如果用户在导入大文件中，需要使用异步接入，也可以考虑使用 Broker load。</p>
</div>
<div class="section" id="id13">
<h3>数据量<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>这里仅讨论单个 BE 的情况，如果用户集群有多个 BE 则下面标题中的数据量应该乘以 BE 个数来计算。比如：如果用户有3个 BE，则 3G 以下（包含）则应该乘以 3，也就是 9G 以下（包含）。</p>
<ul>
<li><p class="first">3G 以下（包含）</p>
<p>用户可以直接提交 Broker load 创建导入请求。</p>
</li>
<li><p class="first">3G 以上</p>
<p>由于单个导入 BE 最大的处理量为 3G，超过 3G 的待导入文件就需要通过调整 Broker load 的导入参数来实现大文件的导入。</p>
<ol>
<li><p class="first">根据当前 BE 的个数和原始文件的大小修改单个 BE 的最大扫描量和最大并发数。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>修改 fe.conf 中配置

max_broker_concurrency = BE 个数
当前导入任务单个 BE 处理的数据量 = 原始文件大小 / max_broker_concurrency
max_bytes_per_broker_scanner &gt;= 当前导入任务单个 BE 处理的数据量

比如一个 100G 的文件，集群的 BE 个数为 10 个
max_broker_concurrency = 10
max_bytes_per_broker_scanner &gt;= 10G = 100G / 10
</pre></div>
</div>
<p>修改后，所有的 BE 会并发的处理导入任务，每个 BE 处理原始文件的一部分。</p>
<p><em>注意：上述两个 FE 中的配置均为系统配置，也就是说其修改是作用于所有的 Broker load的任务的。</em></p>
</li>
<li><p class="first">在创建导入的时候自定义当前导入任务的 timeout 时间</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>当前导入任务单个 BE 处理的数据量 / 用户 Doris 集群最慢导入速度(MB/s) &gt;= 当前导入任务的 timeout 时间 &gt;= 当前导入任务单个 BE 处理的数据量 / 10M/s

比如一个 100G 的文件，集群的 BE 个数为 10个
timeout &gt;= 1000s = 10G / 10M/s
</pre></div>
</div>
</li>
<li><p class="first">当用户发现第二步计算出的 timeout 时间超过系统默认的导入最大超时时间 4小时</p>
<p>这时候不推荐用户将导入最大超时时间直接改大来解决问题。单个导入时间如果超过默认的导入最大超时时间4小时，最好是通过切分待导入文件并且分多次导入来解决问题。主要原因是：单次导入超过4小时的话，导入失败后重试的时间成本很高。</p>
<p>可以通过如下公式计算出 Doris 集群期望最大导入文件数据量：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>期望最大导入文件数据量 = 14400s * 10M/s * BE 个数
比如：集群的 BE 个数为 10个
期望最大导入文件数据量 = 14400 * 10M/s * 10 = 1440000M ≈ 1440G

注意：一般用户的环境可能达不到 10M/s 的速度，所以建议超过 500G 的文件都进行文件切分，再导入。
</pre></div>
</div>
</li>
</ol>
</li>
</ul>
</div>
<div class="section" id="id14">
<h3>完整例子<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>数据情况：用户数据在 HDFS 中，文件地址为 hdfs://abc.com:8888/store_sales, hdfs 的认证用户名为 root, 密码为 password, 数据量大小约为 30G，希望导入到数据库 bj_sales 的表 store_sales 中。</p>
<p>集群情况：集群的 BE 个数约为 3 个，Broker 名称均为 broker。</p>
<ul>
<li><p class="first">step1: 经过上述方法的计算，本次导入的单个 BE 导入量为 10G，则需要先修改 FE 的配置，将单个 BE 导入最大量修改为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">max_bytes_per_broker_scanner</span> <span class="o">=</span> <span class="mi">10737418240</span>
</pre></div>
</div>
</li>
<li><p class="first">step2: 经计算，本次导入的时间大约为 1000s，并未超过默认超时时间，可不配置导入自定义超时时间。</p>
</li>
<li><p class="first">step3：创建导入语句</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LOAD</span> <span class="n">LABEL</span> <span class="n">bj_sales</span><span class="o">.</span><span class="n">store_sales_broker_load_01</span>
<span class="p">(</span>
    <span class="n">DATA</span> <span class="n">INFILE</span><span class="p">(</span><span class="s2">&quot;hdfs://abc.com:8888/store_sales&quot;</span><span class="p">)</span>
    <span class="n">INTO</span> <span class="n">TABLE</span> <span class="n">store_sales</span>
<span class="p">)</span>
<span class="n">WITH</span> <span class="n">BROKER</span> <span class="s1">&#39;broker&#39;</span>
<span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="id15">
<h2>常见问题<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">导入报错：<code class="docutils literal notranslate"><span class="pre">Scan</span> <span class="pre">bytes</span> <span class="pre">per</span> <span class="pre">broker</span> <span class="pre">scanner</span> <span class="pre">exceed</span> <span class="pre">limit:xxx</span></code></p>
<p>请参照文档中最佳实践部分，修改 FE 配置项 <code class="docutils literal notranslate"><span class="pre">max_bytes_per_broker_scanner</span></code> 和 <code class="docutils literal notranslate"><span class="pre">max_broker_concurrency</span></code></p>
</li>
<li><p class="first">导入报错：<code class="docutils literal notranslate"><span class="pre">failed</span> <span class="pre">to</span> <span class="pre">send</span> <span class="pre">batch</span></code> 或 <code class="docutils literal notranslate"><span class="pre">TabletWriter</span> <span class="pre">add</span> <span class="pre">batch</span> <span class="pre">with</span> <span class="pre">unknown</span> <span class="pre">id</span></code></p>
<p>请参照 <a class="reference internal" href="load-manual.html"><span class="doc">导入手册</span></a> 中 <strong>通用系统配置</strong> 中 <strong>BE 配置</strong>，适当修改 <code class="docutils literal notranslate"><span class="pre">tablet_writer_rpc_timeout_sec</span></code> 和 <code class="docutils literal notranslate"><span class="pre">streaming_load_rpc_max_alive_time_sec</span></code>。</p>
</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="stream-load-manual.html" class="btn btn-neutral float-right" title="Stream load" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="load-manual.html" class="btn btn-neutral float-left" title="导入总览" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Apache Doris(Incubating)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>