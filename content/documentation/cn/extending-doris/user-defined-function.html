

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>User Define Function &mdash; Doris Documentations 0.11.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="设计文档" href="../internal/index.html" />
    <link rel="prev" title="Doris On ES" href="doris-on-es.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Doris Documentations
          

          
          </a>

          
            
            
              <div class="version">
                0.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">中文</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../installing/index.html">编译与部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/index.html">开始使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../administrator-guide/index.html">操作手册</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">扩展功能</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="doris-on-es.html">Doris On ES</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">User Define Function</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#udf">编写UDF函数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">编译UDF函数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">创建UDF函数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">使用UDF</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">删除UDF函数</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../internal/index.html">设计文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sql-reference/index.html">SQL 手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer-guide/index.html">开发者手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../community/index.html">Apache 社区</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../en/index.html">English</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Doris Documentations</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">中文</a> &raquo;</li>
        
          <li><a href="index.html">扩展功能</a> &raquo;</li>
        
      <li>User Define Function</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/incubator-doris/blob/master/docs/documentation/cn/extending-doris/user-defined-function.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <!-- 
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
--><div class="section" id="user-define-function">
<h1>User Define Function<a class="headerlink" href="#user-define-function" title="Permalink to this headline">¶</a></h1>
<p>用户可以通过UDF机制来扩展Doris的能力。通过这篇文档，用户能够创建自己的UDF。</p>
<div class="section" id="udf">
<h2>编写UDF函数<a class="headerlink" href="#udf" title="Permalink to this headline">¶</a></h2>
<p>在使用UDF之前，用户需要先在Doris的UDF框架下，编写自己的UDF函数。在<code class="docutils literal notranslate"><span class="pre">be/src/udf_samples/udf_sample.h|cpp</span></code>文件中是一个简单的UDF Demo。</p>
<p>编写一个UDF函数需要以下几个步骤。</p>
<div class="section" id="id1">
<h3>编写函数<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>创建对应的头文件、CPP文件，在CPP文件中实现你需要的逻辑。CPP文件中的实现函数格式与UDF的对应关系。</p>
<div class="section" id="id2">
<h4>非可变参数<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>对于非可变参数的UDF，那么两者之间的对应关系很直接。
比如<code class="docutils literal notranslate"><span class="pre">INT</span> <span class="pre">MyADD(INT,</span> <span class="pre">INT)</span></code>的UDF就会对应<code class="docutils literal notranslate"><span class="pre">IntVal</span> <span class="pre">AddUdf(FunctionContext*</span> <span class="pre">context,</span> <span class="pre">const</span> <span class="pre">IntVal&amp;</span> <span class="pre">arg1,</span> <span class="pre">const</span> <span class="pre">IntVal&amp;</span> <span class="pre">arg2)</span></code>。</p>
<ol class="simple">
<li><code class="docutils literal notranslate"><span class="pre">AddUdf</span></code>可以为任意的名字，只要创建UDF的时候指定即可。</li>
<li>实现函数中的第一个参数永远是<code class="docutils literal notranslate"><span class="pre">FunctionContext*</span></code>。实现者可以通过这个结构体获得一些查询相关的内容，以及申请一些需要使用的内存。具体使用的接口可以参考<code class="docutils literal notranslate"><span class="pre">udf/udf.h</span></code>中的定义。</li>
<li>实现函数中从第二个参数开始需要与UDF的参数一一对应，比如<code class="docutils literal notranslate"><span class="pre">IntVal</span></code>对应<code class="docutils literal notranslate"><span class="pre">INT</span></code>类型。这部分的类型都要使用<code class="docutils literal notranslate"><span class="pre">const</span></code>引用。</li>
<li>返回参数与UDF的参数的类型要相对应。</li>
</ol>
</div>
<div class="section" id="id3">
<h4>可变参数<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>对于可变参数，可以参见以下例子，UDF<code class="docutils literal notranslate"><span class="pre">String</span> <span class="pre">md5sum(String,</span> <span class="pre">...)</span></code>对应的
实现函数是<code class="docutils literal notranslate"><span class="pre">StringVal</span> <span class="pre">md5sumUdf(FunctionContext*</span> <span class="pre">ctx,</span> <span class="pre">int</span> <span class="pre">num_args,</span> <span class="pre">const</span> <span class="pre">StringVal*</span> <span class="pre">args)</span></code></p>
<ol class="simple">
<li><code class="docutils literal notranslate"><span class="pre">md5sumUdf</span></code>这个也是可以任意改变的，创建的时候指定即可。</li>
<li>第一个参数与非可变参数函数一样，传入的是一个<code class="docutils literal notranslate"><span class="pre">FunctionContext*</span></code>。</li>
<li>可变参数部分由两部分组成，首先会传入一个整数，说明后面还有几个参数。后面传入的是一个可变参数部分的数组。</li>
</ol>
</div>
<div class="section" id="id4">
<h4>类型对应关系<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<thead>
<tr>
<th>UDF Type</th>
<th>Argument Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>TinyInt</td>
<td>TinyIntVal</td>
</tr>
<tr>
<td>SmallInt</td>
<td>SmallIntVal</td>
</tr>
<tr>
<td>Int</td>
<td>IntVal</td>
</tr>
<tr>
<td>BigInt</td>
<td>BigIntVal</td>
</tr>
<tr>
<td>LargeInt</td>
<td>LargeIntVal</td>
</tr>
<tr>
<td>Float</td>
<td>FloatVal</td>
</tr>
<tr>
<td>Double</td>
<td>DoubleVal</td>
</tr>
<tr>
<td>Date</td>
<td>DateTimeVal</td>
</tr>
<tr>
<td>Datetime</td>
<td>DateTimeVal</td>
</tr>
<tr>
<td>Char</td>
<td>StringVal</td>
</tr>
<tr>
<td>Varchar</td>
<td>StringVal</td>
</tr>
<tr>
<td>Decimal</td>
<td>DecimalVal</td>
</tr>
</tbody>
</table></div>
</div>
</div>
<div class="section" id="id5">
<h2>编译UDF函数<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<div class="section" id="doris">
<h3>编译Doris<a class="headerlink" href="#doris" title="Permalink to this headline">¶</a></h3>
<p>在Doris根目录下执行<code class="docutils literal notranslate"><span class="pre">sh</span> <span class="pre">build.sh</span></code>就会在<code class="docutils literal notranslate"><span class="pre">output/udf/</span></code>生成对应<code class="docutils literal notranslate"><span class="pre">headers|libs</span></code></p>
</div>
<div class="section" id="cmakelists-txt">
<h3>编写CMakeLists.txt<a class="headerlink" href="#cmakelists-txt" title="Permalink to this headline">¶</a></h3>
<p>基于上一步生成的<code class="docutils literal notranslate"><span class="pre">headers|libs</span></code>，用户可以使用<code class="docutils literal notranslate"><span class="pre">CMakeLists</span></code>等工具引入该依赖；在<code class="docutils literal notranslate"><span class="pre">CMakeLists</span></code>中，可以通过向<code class="docutils literal notranslate"><span class="pre">CMAKE_CXX_FLAGS</span></code>添加<code class="docutils literal notranslate"><span class="pre">-I|L</span></code>分别指定<code class="docutils literal notranslate"><span class="pre">headers|libs</span></code>路径；然后使用<code class="docutils literal notranslate"><span class="pre">add_library</span></code>添加动态库。例如，在<code class="docutils literal notranslate"><span class="pre">be/src/udf_samples/CMakeLists.txt</span></code>中，使用<code class="docutils literal notranslate"><span class="pre">add_library(udfsample</span> <span class="pre">SHARED</span> <span class="pre">udf_sample.cpp)</span></code> <code class="docutils literal notranslate"><span class="pre">target_link_libraries</span></code>(udfsample -static-libstdc++ -static-libgcc)增加了一个<code class="docutils literal notranslate"><span class="pre">udfsample</span></code>动态库。后面需要写上涉及的所有源文件（不包含头文件）。</p>
</div>
<div class="section" id="id6">
<h3>执行编译<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>在该目录下创建一个<code class="docutils literal notranslate"><span class="pre">build</span></code>目录并在<code class="docutils literal notranslate"><span class="pre">build</span></code>下执行<code class="docutils literal notranslate"><span class="pre">cmake</span> <span class="pre">../</span></code>生成<code class="docutils literal notranslate"><span class="pre">Makefile</span></code>，并执行<code class="docutils literal notranslate"><span class="pre">make</span></code>就会生成对应动态库。</p>
</div>
</div>
<div class="section" id="id7">
<h2>创建UDF函数<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>通过上述的步骤后，你可以得到一个动态库。你需要将这个动态库放到一个能够通过HTTP协议访问到的位置。然后执行创建UDF函数在Doris系统内部创建一个UDF，你需要拥有AMDIN权限才能够完成这个操作。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="p">[</span><span class="n">AGGREGATE</span><span class="p">]</span> <span class="n">FUNCTION</span> 
	<span class="n">name</span> <span class="p">([</span><span class="n">argtype</span><span class="p">][,</span><span class="o">...</span><span class="p">])</span>
	<span class="p">[</span><span class="n">RETURNS</span><span class="p">]</span> <span class="n">rettype</span>
	<span class="n">PROPERTIES</span> <span class="p">([</span><span class="s2">&quot;key&quot;</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">][,</span><span class="o">...</span><span class="p">])</span>
</pre></div>
</div>
<p>说明：</p>
<ol class="simple">
<li>PROPERTIES中<code class="docutils literal notranslate"><span class="pre">symbol</span></code>表示的是，执行入口函数的对应symbol，这个参数是必须设定。你可以通过<code class="docutils literal notranslate"><span class="pre">nm</span></code>命令来获得对应的symbol，比如<code class="docutils literal notranslate"><span class="pre">nm</span> <span class="pre">libudfsample.so</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">AddUdf</span></code>获得到的<code class="docutils literal notranslate"><span class="pre">_ZN9doris_udf6AddUdfEPNS_15FunctionContextERKNS_6IntValES4_</span></code>就是对应的symbol。</li>
<li>PROPERTIES中<code class="docutils literal notranslate"><span class="pre">object_file</span></code>表示的是从哪里能够下载到对应的动态库，这个参数是必须设定的。</li>
<li>name: 一个function是要归属于某个DB的，name的形式为<code class="docutils literal notranslate"><span class="pre">dbName</span></code>.<code class="docutils literal notranslate"><span class="pre">funcName</span></code>。当<code class="docutils literal notranslate"><span class="pre">dbName</span></code>没有明确指定的时候，就是使用当前session所在的db作为<code class="docutils literal notranslate"><span class="pre">dbName</span></code>。</li>
</ol>
<p>具体使用可以参见 <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">FUNCTION</span></code> 获取更详细信息。</p>
</div>
<div class="section" id="id8">
<h2>使用UDF<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>用户使用UDF/UDAF必须拥有对应数据库的 <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> 权限。</p>
<p>UDF的使用与普通的函数方式一致，唯一的区别在于，内置函数的作用域是全局的，而UDF的作用域是DB内部。当链接session位于数据内部时，直接使用UDF名字会在当前DB内部查找对应的UDF。否则用户需要显示的指定UDF的数据库名字，例如<code class="docutils literal notranslate"><span class="pre">dbName</span></code>.<code class="docutils literal notranslate"><span class="pre">funcName</span></code>。</p>
</div>
<div class="section" id="id9">
<h2>删除UDF函数<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>当你不再需要UDF函数时，你可以通过下述命令来删除一个UDF函数, 可以参考 <code class="docutils literal notranslate"><span class="pre">DROP</span> <span class="pre">FUNCTION</span></code>。</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../internal/index.html" class="btn btn-neutral float-right" title="设计文档" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="doris-on-es.html" class="btn btn-neutral float-left" title="Doris On ES" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Apache Doris(Incubating)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
<div role="contentinfo">
    <p></p>
    <p>

        Apache Doris(incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.

    </p>
</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>