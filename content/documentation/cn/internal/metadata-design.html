

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>元数据设计文档 &mdash; Doris Documentations 0.11.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="SQL 手册" href="../sql-reference/index.html" />
    <link rel="prev" title="Doris存储文件格式优化" href="doris_storage_optimization.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Doris Documentations
          

          
          </a>

          
            
            
              <div class="version">
                0.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">中文</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../installing/index.html">编译与部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/index.html">开始使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../administrator-guide/index.html">操作手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending-doris/index.html">扩展功能</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">设计文档</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="doris_storage_optimization.html">Doris存储文件格式优化</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">元数据设计文档</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">名词解释</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">整体架构</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">元数据结构</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">数据流</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">实现细节</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../sql-reference/index.html">SQL 手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../community/index.html">Apache 社区</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../en/index.html">English</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Doris Documentations</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">中文</a> &raquo;</li>
        
          <li><a href="index.html">设计文档</a> &raquo;</li>
        
      <li>元数据设计文档</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/incubator-doris/blob/master/docs/documentation/cn/internal/metadata-design.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>元数据设计文档<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id2">
<h2>名词解释<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>FE：Frontend，即 Doris 的前端节点。主要负责接收和返回客户端请求、元数据以及集群管理、查询计划生成等工作。</li>
<li>BE：Backend，即 Doris 的后端节点。主要负责数据存储与管理、查询计划执行等工作。</li>
<li>bdbje：<a class="reference external" href="http://www.oracle.com/technetwork/database/berkeleydb/overview/index-093405.html">Oracle Berkeley DB Java Edition</a>。在 Doris 中，我们使用 bdbje 完成元数据操作日志的持久化、FE 高可用等功能。</li>
</ul>
</div>
<div class="section" id="id3">
<h2>整体架构<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p><img alt="../../../_images/palo_architecture.jpg" src="../../../_images/palo_architecture.jpg" /></p>
<p>如上图，Doris 的整体架构分为两层。多个 FE 组成第一层，提供 FE 的横向扩展和高可用。多个 BE 组成第二层，负责数据存储于管理。本文主要介绍 FE 这一层中，元数据的设计与实现方式。</p>
<ol class="simple">
<li>FE 节点分为 follower 和 observer 两类。各个 FE 之间，通过 bdbje（<a class="reference external" href="http://www.oracle.com/technetwork/database/database-technologies/berkeleydb/overview/index-093405.html">BerkeleyDB Java Edition</a>）进行 leader 选举，数据同步等工作。</li>
<li>follower 节点通过选举，其中一个 follower 成为 leader 节点，负责元数据的写入操作。当 leader 节点宕机后，其他 follower 节点会重新选举出一个 leader，保证服务的高可用。</li>
<li>observer 节点仅从 leader 节点进行元数据同步，不参与选举。可以横向扩展以提供元数据的读服务的扩展性。</li>
</ol>
<blockquote>
<div>注：follower 和 observer 对应 bdbje 中的概念为 replica 和 observer。下文可能会同时使用两种名称。</div></blockquote>
</div>
<div class="section" id="id4">
<h2>元数据结构<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>Doris 的元数据是全内存的。每个 FE 内存中，都维护一个完整的元数据镜像。在百度内部，一个包含2500张表，100万个分片（300万副本）的集群，元数据在内存中仅占用约 2GB。（当然，查询所使用的中间对象、各种作业信息等内存开销，需要根据实际情况估算。但总体依然维持在一个较低的内存开销范围内。）</p>
<p>同时，元数据在内存中整体采用树状的层级结构存储，并且通过添加辅助结构，能够快速访问各个层级的元数据信息。</p>
<p>下图是 Doris 元信息所存储的内容。</p>
<p><img alt="../../../_images/metadata_contents.png" src="../../../_images/metadata_contents.png" /></p>
<p>如上图，Doris 的元数据主要存储4类数据：</p>
<ol class="simple">
<li>用户数据信息。包括数据库、表的 Schema、分片信息等。</li>
<li>各类作业信息。如导入作业，Clone 作业、SchemaChange 作业等。</li>
<li>用户及权限信息。</li>
<li>集群及节点信息。</li>
</ol>
</div>
<div class="section" id="id5">
<h2>数据流<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p><img alt="../../../_images/metadata_stream.png" src="../../../_images/metadata_stream.png" /></p>
<p>元数据的数据流具体过程如下：</p>
<ol class="simple">
<li>只有 leader FE 可以对元数据进行写操作。写操作在修改 leader 的内存后，会序列化为一条log，按照 key-value 的形式写入 bdbje。其中 key 为连续的整型，作为 log id，value 即为序列化后的操作日志。</li>
<li>日志写入 bdbje 后，bdbje 会根据策略（写多数/全写），将日志复制到其他 non-leader 的 FE 节点。non-leader FE 节点通过对日志回放，修改自身的元数据内存镜像，完成与 leader 节点的元数据同步。</li>
<li>leader 节点的日志条数达到阈值后（默认 10w 条），会启动 checkpoint 线程。checkpoint 会读取已有的 image 文件，和其之后的日志，重新在内存中回放出一份新的元数据镜像副本。然后将该副本写入到磁盘，形成一个新的 image。之所以是重新生成一份镜像副本，而不是将已有镜像写成 image，主要是考虑写 image 加读锁期间，会阻塞写操作。所以每次 checkpoint 会占用双倍内存空间。</li>
<li>image 文件生成后，leader 节点会通知其他 non-leader 节点新的 image 已生成。non-leader 主动通过 http 拉取最新的 image 文件，来更换本地的旧文件。</li>
<li>bdbje 中的日志，在 image 做完后，会定期删除旧的日志。</li>
</ol>
</div>
<div class="section" id="id6">
<h2>实现细节<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id7">
<h3>元数据目录<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li>元数据目录通过 FE 的配置项 <code class="docutils literal notranslate"><span class="pre">meta_dir</span></code> 指定。</li>
<li><code class="docutils literal notranslate"><span class="pre">bdb/</span></code> 目录下为 bdbje 的数据存放目录。</li>
<li><code class="docutils literal notranslate"><span class="pre">image/</span></code> 目录下为 image 文件的存放目录。<ul>
<li><code class="docutils literal notranslate"><span class="pre">image.[logid]</span></code> 是最新的 image 文件。后缀 <code class="docutils literal notranslate"><span class="pre">logid</span></code> 表明 image 所包含的最后一条日志的 id。</li>
<li><code class="docutils literal notranslate"><span class="pre">image.ckpt</span></code> 是正在写入的 image 文件，如果写入成功，会重命名为 <code class="docutils literal notranslate"><span class="pre">image.[logid]</span></code>，并替换掉就的 image 文件。</li>
<li><code class="docutils literal notranslate"><span class="pre">VERSION</span></code> 文件中记录着 <code class="docutils literal notranslate"><span class="pre">cluster_id</span></code>。<code class="docutils literal notranslate"><span class="pre">cluster_id</span></code> 唯一标识一个 Doris 集群。是在 leader 第一次启动时随机生成的一个 32 位整型。也可以通过 fe 配置项 <code class="docutils literal notranslate"><span class="pre">cluster_id</span></code> 来指定一个 cluster id。</li>
<li><code class="docutils literal notranslate"><span class="pre">ROLE</span></code> 文件中记录的 FE 自身的角色。只有 <code class="docutils literal notranslate"><span class="pre">FOLLOWER</span></code> 和 <code class="docutils literal notranslate"><span class="pre">OBSERVER</span></code> 两种。其中 <code class="docutils literal notranslate"><span class="pre">FOLLOWER</span></code> 表示 FE 为一个可选举的节点。（注意：即使是 leader 节点，其角色也为 <code class="docutils literal notranslate"><span class="pre">FOLLOWER</span></code>）</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="id8">
<h3>启动流程<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<ol>
<li><p class="first">FE 第一次启动，如果启动脚本不加任何参数，则会尝试以 leader 的身份启动。在 FE 启动日志中会最终看到 <code class="docutils literal notranslate"><span class="pre">transfer</span> <span class="pre">from</span> <span class="pre">UNKNOWN</span> <span class="pre">to</span> <span class="pre">MASTER</span></code>。</p>
</li>
<li><p class="first">FE 第一次启动，如果启动脚本中指定了 <code class="docutils literal notranslate"><span class="pre">-helper</span></code> 参数，并且指向了正确的 leader FE 节点，那么该 FE 首先会通过 http 向 leader 节点询问自身的角色（即 ROLE）和 cluster_id。然后拉取最新的 image 文件。读取 image 文件，生成元数据镜像后，启动 bdbje，开始进行 bdbje 日志同步。同步完成后，开始回放 bdbje 中，image 文件之后的日志，完成最终的元数据镜像生成。</p>
<blockquote>
<div><p>注1：使用 <code class="docutils literal notranslate"><span class="pre">-helper</span></code> 参数启动时，需要首先通过 mysql 命令，通过 leader 来添加该 FE，否则，启动时会报错。</p>
</div></blockquote>
<blockquote>
<div><p>注2：<code class="docutils literal notranslate"><span class="pre">-helper</span></code> 可以指向任何一个 follower 节点，即使它不是 leader。</p>
</div></blockquote>
<blockquote>
<div><p>注2：bdbje 在同步日志过程中，fe 日志会显示 <code class="docutils literal notranslate"><span class="pre">xxx</span> <span class="pre">detached</span></code>, 此时正在进行日志拉取，属于正常现象。</p>
</div></blockquote>
</li>
<li><p class="first">FE 非第一次启动，如果启动脚本不加任何参数，则会根据本地存储的 ROLE 信息，来确定自己的身份。同时根据本地 bdbje 中存储的集群信息，获取 leader 的信息。然后读取本地的 image 文件，以及 bdbje 中的日志，完成元数据镜像生成。（如果本地 ROLE 中记录的角色和 bdbje 中记录的不一致，则会报错。）</p>
</li>
<li><p class="first">FE 非第一次启动，且启动脚本中指定了 <code class="docutils literal notranslate"><span class="pre">-helper</span></code> 参数。则和第一次启动的流程一样，也会先去询问 leader 角色。但是会和自身存储的 ROLE 进行比较。如果不一致，则会报错。</p>
</li>
</ol>
<div class="section" id="id9">
<h4>元数据读写与同步<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<ol>
<li><p class="first">用户可以使用 mysql 连接任意一个 FE 节点进行元数据的读写访问。如果连接的是 non-leader 节点，则该节点会将写操作转发给 leader 节点。leader 写成功后，会返回一个 leader 当前最新的 log id。之后，non-leader 节点会等待自身回放的 log id 大于回传的 log id 后，才将命令成功的消息返回给客户端。这种方式保证了任意 FE 节点的 Read-Your-Write 语义。</p>
<blockquote>
<div><p>注：一些非写操作，也会转发给 leader 执行。比如 <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">LOAD</span></code> 操作。因为这些命令通常需要读取一些作业的中间状态，而这些中间状态是不写 bdbje 的，因此 non-leader 节点的内存中，是没有这些中间状态的。（FE 直接的元数据同步完全依赖 bdbje 的日志回放，如果一个元数据修改操作不写 bdbje 日志，则在其他 non-leader 节点中是看不到该操作修改后的结果的。）</p>
</div></blockquote>
</li>
<li><p class="first">leader 节点会启动一个 TimePrinter 线程。该线程会定期向 bdbje 中写入一个当前时间的 key-value 条目。其余 non-leader 节点通过回放这条日志，读取日志中记录的时间，和本地时间进行比较，如果发现和本地时间的落后大于指定的阈值（配置项：<code class="docutils literal notranslate"><span class="pre">meta_delay_toleration_second</span></code>。写入间隔为该配置项的一半），则该节点会处于<strong>不可读</strong>的状态。此机制解决了 non-leader 节点在长时间和 leader 失联后，仍然提供过期的元数据服务的问题。</p>
</li>
<li><p class="first">各个 FE 的元数据只保证最终一致性。正常情况下，不一致的窗口期仅为毫秒级。我们保证同一 session 中，元数据访问的单调一致性。但是如果同一 client 连接不同 FE，则可能出现元数据回退的现象。（但对于批量更新系统，该问题影响很小。）</p>
</li>
</ol>
</div>
</div>
<div class="section" id="id10">
<h3>宕机恢复<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li>leader 节点宕机后，其余 follower 会立即选举出一个新的 leader 节点提供服务。</li>
<li>当多数 follower 节点宕机时，元数据不可写入。当元数据处于不可写入状态下，如果这时发生写操作请求，目前的处理流程是 <strong>FE 进程直接退出</strong>。后续会优化这个逻辑，在不可写状态下，依然提供读服务。</li>
<li>observer 节点宕机，不会影响任何其他节点的状态。也不会影响元数据在其他节点的读写。</li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../sql-reference/index.html" class="btn btn-neutral float-right" title="SQL 手册" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="doris_storage_optimization.html" class="btn btn-neutral float-left" title="Doris存储文件格式优化" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Apache Doris(Incubating)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
<div role="contentinfo">
    <p></p>
    <p>

        Apache Doris is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the name of Apache TLP sponsor. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.

    </p>
</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>