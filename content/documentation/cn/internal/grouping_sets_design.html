

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>GROUPING SETS 设计文档 &mdash; Doris Documentations 0.11.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="元数据设计文档" href="metadata-design.html" />
    <link rel="prev" title="Doris存储文件格式优化" href="doris_storage_optimization.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Doris Documentations
          

          
          </a>

          
            
            
              <div class="version">
                0.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">中文</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../installing/index.html">编译与部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/index.html">开始使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../administrator-guide/index.html">操作手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending-doris/index.html">扩展功能</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">设计文档</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="doris_storage_optimization.html">Doris存储文件格式优化</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">GROUPING SETS 设计文档</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">1. GROUPING SETS 相关背景知识</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">2. 设计目标</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">3. 实现方案</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="metadata-design.html">元数据设计文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="spark_load.html">Doris支持spark导入设计文档</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../sql-reference/index.html">SQL 手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer-guide/index.html">开发者手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../community/index.html">Apache 社区</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../en/index.html">English</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Doris Documentations</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">中文</a> &raquo;</li>
        
          <li><a href="index.html">设计文档</a> &raquo;</li>
        
      <li>GROUPING SETS 设计文档</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/incubator-doris/blob/master/docs/documentation/cn/internal/grouping_sets_design.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <!-- 
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
--><div class="section" id="grouping-sets">
<h1>GROUPING SETS 设计文档<a class="headerlink" href="#grouping-sets" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>1. GROUPING SETS 相关背景知识<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3>1.1 GROUPING SETS 子句<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>GROUP BY GROUPING SETS 是对 GROUP BY 子句的扩展，它能够在一个 GROUP BY 子句中一次实现多个集合的分组。其结果等价于将多个相应 GROUP BY 子句进行 UNION 操作。</p>
<p>特别地，一个空的子集意味着将所有的行聚集到一个分组。
GROUP BY 子句是只含有一个元素的 GROUP BY GROUPING SETS 的特例。</p>
<p>例如，GROUPING SETS 语句：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">SUM</span><span class="p">(</span> <span class="n">k3</span> <span class="p">)</span> <span class="n">FROM</span> <span class="n">t</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">GROUPING</span> <span class="n">SETS</span> <span class="p">(</span> <span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">),</span> <span class="p">(</span><span class="n">k1</span><span class="p">),</span> <span class="p">(</span><span class="n">k2</span><span class="p">),</span> <span class="p">(</span> <span class="p">)</span> <span class="p">);</span>
</pre></div>
</div>
<p>其查询结果等价于：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">SUM</span><span class="p">(</span> <span class="n">k3</span> <span class="p">)</span> <span class="n">FROM</span> <span class="n">t</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span>
<span class="n">UNION</span>
<span class="n">SELECT</span> <span class="n">k1</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">SUM</span><span class="p">(</span> <span class="n">k3</span> <span class="p">)</span> <span class="n">FROM</span> <span class="n">t</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">k1</span>
<span class="n">UNION</span>
<span class="n">SELECT</span> <span class="n">null</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">SUM</span><span class="p">(</span> <span class="n">k3</span> <span class="p">)</span> <span class="n">FROM</span> <span class="n">t</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">k2</span>
<span class="n">UNION</span>
<span class="n">SELECT</span> <span class="n">null</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">SUM</span><span class="p">(</span> <span class="n">k3</span> <span class="p">)</span> <span class="n">FROM</span> <span class="n">t</span>
</pre></div>
</div>
<p>下面是一个实际数据的例子：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mysql&gt; SELECT * FROM t;
+------+------+------+
| k1   | k2   | k3   |
+------+------+------+
| a    | A    |    1 |
| a    | A    |    2 |
| a    | B    |    1 |
| a    | B    |    3 |
| b    | A    |    1 |
| b    | A    |    4 |
| b    | B    |    1 |
| b    | B    |    5 |
+------+------+------+
8 rows in set (0.01 sec)

mysql&gt; SELECT k1, k2, SUM(k3) FROM t GROUP BY GROUPING SETS ( (k1, k2), (k2), (k1), ( ) );
+------+------+-----------+
| k1   | k2   | sum(`k3`) |
+------+------+-----------+
| b    | B    |         6 |
| a    | B    |         4 |
| a    | A    |         3 |
| b    | A    |         5 |
| NULL | B    |        10 |
| NULL | A    |         8 |
| a    | NULL |         7 |
| b    | NULL |        11 |
| NULL | NULL |        18 |
+------+------+-----------+
9 rows in set (0.06 sec)
</pre></div>
</div>
</div>
<div class="section" id="rollup">
<h3>1.2 ROLLUP 子句<a class="headerlink" href="#rollup" title="Permalink to this headline">¶</a></h3>
<p>ROLLUP 是对 GROUPING SETS 的扩展。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span> <span class="n">SUM</span><span class="p">(</span> <span class="n">d</span> <span class="p">)</span> <span class="n">FROM</span> <span class="n">tab1</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">ROLLUP</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>这个 ROLLUP 等价于下面的 GROUPING SETS：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GROUPING</span> <span class="n">SETS</span> <span class="p">(</span>
<span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">),</span>
<span class="p">(</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">),</span>
<span class="p">(</span> <span class="n">a</span><span class="p">),</span>
<span class="p">(</span> <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="cube">
<h3>1.3 CUBE 子句<a class="headerlink" href="#cube" title="Permalink to this headline">¶</a></h3>
<p>CUBE 也是对 GROUPING SETS 的扩展。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CUBE</span> <span class="p">(</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">e3</span><span class="p">,</span> <span class="o">...</span> <span class="p">)</span>
</pre></div>
</div>
<p>其含义是 GROUPING SETS 后面列表中的所有子集。</p>
<p>例如，CUBE ( a, b, c ) 等价于下面的 GROUPING SETS：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GROUPING</span> <span class="n">SETS</span> <span class="p">(</span>
<span class="p">(</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="p">),</span>
<span class="p">(</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">),</span>
<span class="p">(</span> <span class="n">a</span><span class="p">,</span>    <span class="n">c</span> <span class="p">),</span>
<span class="p">(</span> <span class="n">a</span>       <span class="p">),</span>
<span class="p">(</span>    <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="p">),</span>
<span class="p">(</span>    <span class="n">b</span>    <span class="p">),</span>
<span class="p">(</span>       <span class="n">c</span> <span class="p">),</span>
<span class="p">(</span>         <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="grouping-grouping-id">
<h3>1.4 GROUPING 和 GROUPING_ID 函数<a class="headerlink" href="#grouping-grouping-id" title="Permalink to this headline">¶</a></h3>
<p>当我们没有统计某一列时，它的值显示为 NULL，这也可能是列本身就有 NULL 值，这就需要一种方法区分是没有统计还是值本来就是 NULL。为此引入 GROUPING 和 GROUPING_ID 函数。
GROUPING(column:Column) 函数用于区分分组后的单个列是普通列和聚合列。如果是聚合列，则返回1，反之，则是0. GROUPING() 只能有一个参数列。</p>
<p>GROUPING_ID(column1, column2) 则根据指定的column 顺序，否则根据聚合的时候给的集合的元素顺序，计算出一个列列表的 bitmap 值，一个列如果是聚合列为0，否则为1. GROUPING_ID()函数返回位向量的十进制值。
比如 [0 1 0] -&gt;2 从下列第三个查询可以看到这种对应关系</p>
<p>例如，对于下面的表：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">t</span><span class="p">;</span>
<span class="o">+------+------+------+</span>
<span class="o">|</span> <span class="n">k1</span>   <span class="o">|</span> <span class="n">k2</span>   <span class="o">|</span> <span class="n">k3</span>   <span class="o">|</span>
<span class="o">+------+------+------+</span>
<span class="o">|</span> <span class="n">a</span>    <span class="o">|</span> <span class="n">A</span>    <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">a</span>    <span class="o">|</span> <span class="n">A</span>    <span class="o">|</span>    <span class="mi">2</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">a</span>    <span class="o">|</span> <span class="n">B</span>    <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">a</span>    <span class="o">|</span> <span class="n">B</span>    <span class="o">|</span>    <span class="mi">3</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">b</span>    <span class="o">|</span> <span class="n">A</span>    <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">b</span>    <span class="o">|</span> <span class="n">A</span>    <span class="o">|</span>    <span class="mi">4</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">b</span>    <span class="o">|</span> <span class="n">B</span>    <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">b</span>    <span class="o">|</span> <span class="n">B</span>    <span class="o">|</span>    <span class="mi">5</span> <span class="o">|</span>
<span class="o">+------+------+------+</span>
</pre></div>
</div>
<p>grouping sets 的结果如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mysql&gt; SELECT k1, k2, GROUPING(k1), GROUPING(k2), SUM(k3) FROM t GROUP BY GROUPING SETS ( (k1, k2), (k2), (k1), ( ) );
+------+------+----------------+----------------+-----------+
| k1   | k2   | grouping(`k1`) | grouping(`k2`) | sum(`k3`) |
+------+------+----------------+----------------+-----------+
| a    | A    |              0 |              0 |         3 |
| a    | B    |              0 |              0 |         4 |
| a    | NULL |              0 |              1 |         7 |
| b    | A    |              0 |              0 |         5 |
| b    | B    |              0 |              0 |         6 |
| b    | NULL |              0 |              1 |        11 |
| NULL | A    |              1 |              0 |         8 |
| NULL | B    |              1 |              0 |        10 |
| NULL | NULL |              1 |              1 |        18 |
+------+------+----------------+----------------+-----------+
9 rows in set (0.02 sec)

mysql&gt; SELECT k1, k2, GROUPING_ID(k1,k2), SUM(k3) FROM t GROUP BY GROUPING SETS ( (k1, k2), (k2), (k1), ( ) );
+------+------+-------------------------+-----------+
| k1   | k2   | grouping_id(`k1`, `k2`) | sum(`k3`) |
+------+------+-------------------------+-----------+
| a    | A    |                       0 |         3 |
| a    | B    |                       0 |         4 |
| a    | NULL |                       1 |         7 |
| b    | A    |                       0 |         5 |
| b    | B    |                       0 |         6 |
| b    | NULL |                       1 |        11 |
| NULL | A    |                       2 |         8 |
| NULL | B    |                       2 |        10 |
| NULL | NULL |                       3 |        18 |
+------+------+-------------------------+-----------+
9 rows in set (0.02 sec)

mysql&gt; SELECT k1, k2, grouping(k1), grouping(k2), GROUPING_ID(k1,k2), SUM(k4) FROM t GROUP BY GROUPING SETS ( (k1, k2), (k2), (k1), ( ) ) order by k1, k2;
+------+------+----------------+----------------+-------------------------+-----------+
| k1   | k2   | grouping(`k1`) | grouping(`k2`) | grouping_id(`k1`, `k2`) | sum(`k4`) |
+------+------+----------------+----------------+-------------------------+-----------+
| a    | A    |              0 |              0 |                       0 |         3 |
| a    | B    |              0 |              0 |                       0 |         4 |
| a    | NULL |              0 |              1 |                       1 |         7 |
| b    | A    |              0 |              0 |                       0 |         5 |
| b    | B    |              0 |              0 |                       0 |         6 |
| b    | NULL |              0 |              1 |                       1 |        11 |
| NULL | A    |              1 |              0 |                       2 |         8 |
| NULL | B    |              1 |              0 |                       2 |        10 |
| NULL | NULL |              1 |              1 |                       3 |        18 |
+------+------+----------------+----------------+-------------------------+-----------+
9 rows in set (0.02 sec)
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>1.5 GROUPING SETS 的组合与嵌套<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>首先，一个 GROUP BY 子句本质上是一个 GROUPING SETS 的特例, 例如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   GROUP BY a
等同于
   GROUP BY GROUPING SETS((a))
同样地，
   GROUP BY a,b,c
等同于
   GROUP BY GROUPING SETS((a,b,c))
</pre></div>
</div>
<p>同样的，CUBE 和 ROLLUP 也可以展开成 GROUPING SETS，因此 GROUP BY, CUBE, ROLLUP, GROUPING SETS 的各种组合和嵌套本质上就是 GROUPING SETS 的组合与嵌套。</p>
<p>对于 GROUPING SETS 的嵌套，语义上等价于将嵌套内的语句直接写到外面。（参考：<a class="reference external" href="https://www.brytlyt.com/documentation/data-manipulation-dml/grouping-sets-rollup-cube/">https://www.brytlyt.com/documentation/data-manipulation-dml/grouping-sets-rollup-cube/</a>），其中写道：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">CUBE</span> <span class="ow">and</span> <span class="n">ROLLUP</span> <span class="n">constructs</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">either</span> <span class="n">directly</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">clause</span><span class="p">,</span> <span class="ow">or</span> <span class="n">nested</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">GROUPING</span> <span class="n">SETS</span> <span class="n">clause</span><span class="o">.</span> <span class="n">If</span> <span class="n">one</span> <span class="n">GROUPING</span> <span class="n">SETS</span> <span class="n">clause</span> <span class="ow">is</span> <span class="n">nested</span> <span class="n">inside</span> <span class="n">another</span><span class="p">,</span> <span class="n">the</span> <span class="n">effect</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">same</span> <span class="k">as</span> <span class="k">if</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">elements</span> <span class="n">of</span> <span class="n">the</span> <span class="n">inner</span> <span class="n">clause</span> <span class="n">had</span> <span class="n">been</span> <span class="n">written</span> <span class="n">directly</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">outer</span> <span class="n">clause</span><span class="o">.</span>
</pre></div>
</div>
<p>对于多个 GROUPING SETS 的组合列表，很多数据库认为是叉乘（cross product）的关系。</p>
<p>例如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>GROUP BY a, CUBE (b, c), GROUPING SETS ((d), (e))

等同于：

GROUP BY GROUPING SETS (
(a, b, c, d), (a, b, c, e),
(a, b, d),    (a, b, e),
(a, c, d),    (a, c, e),
(a, d),       (a, e)
)
</pre></div>
</div>
<p>对于 GROUPING SETS 的组合与嵌套，各个数据库支持不太一样。例如 snowflake 不支持任何的组合和嵌套。
（<a class="reference external" href="https://docs.snowflake.net/manuals/sql-reference/constructs/group-by.html">https://docs.snowflake.net/manuals/sql-reference/constructs/group-by.html</a>）</p>
<p>Oracle 既支持组合，也支持嵌套。
（<a class="reference external" href="https://docs.oracle.com/cd/B19306_01/server.102/b14223/aggreg.htm#i1006842">https://docs.oracle.com/cd/B19306_01/server.102/b14223/aggreg.htm#i1006842</a>）</p>
<p>Presto 支持组合，但不支持嵌套。
（<a class="reference external" href="https://prestodb.github.io/docs/current/sql/select.html">https://prestodb.github.io/docs/current/sql/select.html</a>）</p>
</div>
</div>
<div class="section" id="id4">
<h2>2. 设计目标<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>从语法上支持 GROUPING SETS， ROLLUP 和 CUBE。实现上述所述的1.1, 1.2, 1.3 1.4.</p>
<p>对于1.6 GROUPING SETS 的组合与嵌套 先不实现。</p>
<p>具体语法列出如下：</p>
<div class="section" id="id5">
<h3>2.1 GROUPING SETS 语法<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT ...
FROM ...
[ ... ]
GROUP BY GROUPING SETS ( groupSet [ , groupSet [ , ... ] ] )
[ ... ]

groupSet ::= { ( expr  [ , expr [ , ... ] ] )}

&lt;expr&gt;
各种表达式，包括列名.
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>2.2 ROLLUP 语法<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT ...
FROM ...
[ ... ]
GROUP BY ROLLUP ( expr  [ , expr [ , ... ] ] )
[ ... ]

&lt;expr&gt;
各种表达式，包括列名.
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>2.3 CUBE 语法<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT ...
FROM ...
[ ... ]
GROUP BY CUBE ( expr  [ , expr [ , ... ] ] )
[ ... ]

&lt;expr&gt;
各种表达式，包括列名.
</pre></div>
</div>
</div>
</div>
<div class="section" id="id8">
<h2>3. 实现方案<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id9">
<h3>3.1 整体思路<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>既然 GROUPING SET 子句逻辑上等价于多个相应 GROUP BY 子句的 UNION，可以通过扩展输入行(此输入行已经是通过下推条件过滤和投影后的), 在此基础上进行一个单一的 GROUP BY 操作来达到目的。</p>
<p>关键是怎样扩展输入行呢？下面举例说明：</p>
<p>例如，对应下面的语句：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="n">FROM</span> <span class="n">src</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="n">GROUPING</span> <span class="n">SETS</span> <span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="p">());</span>
</pre></div>
</div>
<p>假定 src 表的数据如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
</pre></div>
</div>
<p>根据 GROUPING SETS 子句给出的列表，可以将输入行扩展为下面的 8 行 （GROUPING SETS集合数 * 行数, 同时为每行生成对应的 全列的GROUPING_ID: 和其他grouping 函数的值</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>       <span class="p">(</span><span class="n">GROUPING_ID</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="mi">00</span><span class="o">-&gt;</span><span class="mi">0</span><span class="p">)</span>
<span class="mi">1</span><span class="p">,</span> <span class="n">null</span>    <span class="p">(</span><span class="n">GUPING_ID</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="n">null</span> <span class="o">-&gt;</span> <span class="mi">01</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">null</span><span class="p">,</span> <span class="mi">2</span>    <span class="p">(</span><span class="n">GROUPING_ID</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="mi">10</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">null</span><span class="p">,</span> <span class="n">null</span> <span class="p">(</span><span class="n">GROUPING_ID</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="n">null</span> <span class="o">-&gt;</span> <span class="mi">11</span> <span class="o">-&gt;</span> <span class="mi">3</span><span class="p">)</span>

<span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>       <span class="p">(</span><span class="n">GROUPING_ID</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="mi">00</span> <span class="o">-&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="mi">3</span><span class="p">,</span> <span class="n">null</span>    <span class="p">(</span><span class="n">GROUPING_ID</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="n">null</span> <span class="o">-&gt;</span> <span class="mi">01</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">null</span><span class="p">,</span> <span class="mi">4</span>    <span class="p">(</span><span class="n">GROUPING_ID</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="mi">10</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">null</span><span class="p">,</span> <span class="n">null</span> <span class="p">(</span><span class="n">GROUPING_ID</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="n">null</span> <span class="o">-&gt;</span> <span class="mi">11</span> <span class="o">-&gt;</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>然后，将上面的 8 行数据作为输入，对 a, b, GROUPING_ID 进行 GROUP BY 操作即可。</p>
</div>
<div class="section" id="id10">
<h3>3.2 具体例子验证说明<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>假设有一个 t 表，包含如下列和数据：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">t</span><span class="p">;</span>
<span class="o">+------+------+------+</span>
<span class="o">|</span> <span class="n">k1</span>   <span class="o">|</span> <span class="n">k2</span>   <span class="o">|</span> <span class="n">k3</span>   <span class="o">|</span>
<span class="o">+------+------+------+</span>
<span class="o">|</span> <span class="n">a</span>    <span class="o">|</span> <span class="n">A</span>    <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">a</span>    <span class="o">|</span> <span class="n">A</span>    <span class="o">|</span>    <span class="mi">2</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">a</span>    <span class="o">|</span> <span class="n">B</span>    <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">a</span>    <span class="o">|</span> <span class="n">B</span>    <span class="o">|</span>    <span class="mi">3</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">b</span>    <span class="o">|</span> <span class="n">A</span>    <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">b</span>    <span class="o">|</span> <span class="n">A</span>    <span class="o">|</span>    <span class="mi">4</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">b</span>    <span class="o">|</span> <span class="n">B</span>    <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">b</span>    <span class="o">|</span> <span class="n">B</span>    <span class="o">|</span>    <span class="mi">5</span> <span class="o">|</span>
<span class="o">+------+------+------+</span>
<span class="mi">8</span> <span class="n">rows</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
<p>对于如下的查询：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">GROUPING_ID</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span><span class="p">),</span> <span class="n">SUM</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">t</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">GROUPING</span> <span class="n">SETS</span> <span class="p">((</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">),</span> <span class="p">(</span><span class="n">k1</span><span class="p">),</span> <span class="p">(</span><span class="n">k2</span><span class="p">),</span> <span class="p">());</span>
</pre></div>
</div>
<p>首先，对输入行进行扩展，每行数据扩展成 4 行 (GROUPING SETS子句的集合数目)，同时增加 GROUPING_ID() 列 ：</p>
<p>例如 a, A, 1 扩展后变成下面的 4 行：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>+------+------+------+-------------------------+
| k1   | k2   | k3   | GROUPING_ID(`k1`, `k2`) |
+------+------+------+-------------------------+
| a    | A    |    1 |                       0 |
| a    | NULL |    1 |                       1 |
| NULL | A    |    1 |                       2 |
| NULL | NULL |    1 |                       3 |
+------+------+------+-------------------------+
</pre></div>
</div>
<p>最终， 全部扩展后的输入行如下（总共 32 行）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>+------+------+------+-------------------------+
| k1   | k2   | k3   | GROUPING_ID(`k1`, `k2`) |
+------+------+------+-------------------------+
| a    | A    |    1 |                       0 |
| a    | A    |    2 |                       0 |
| a    | B    |    1 |                       0 |
| a    | B    |    3 |                       0 |
| b    | A    |    1 |                       0 |
| b    | A    |    4 |                       0 |
| b    | B    |    1 |                       0 |
| b    | B    |    5 |                       0 |
| a    | NULL |    1 |                       1 |
| a    | NULL |    1 |                       1 |
| a    | NULL |    2 |                       1 |
| a    | NULL |    3 |                       1 |
| b    | NULL |    1 |                       1 |
| b    | NULL |    1 |                       1 |
| b    | NULL |    4 |                       1 |
| b    | NULL |    5 |                       1 |
| NULL | A    |    1 |                       2 |
| NULL | A    |    1 |                       2 |
| NULL | A    |    2 |                       2 |
| NULL | A    |    4 |                       2 |
| NULL | B    |    1 |                       2 |
| NULL | B    |    1 |                       2 |
| NULL | B    |    3 |                       2 |
| NULL | B    |    5 |                       2 |
| NULL | NULL |    1 |                       3 |
| NULL | NULL |    1 |                       3 |
| NULL | NULL |    1 |                       3 |
| NULL | NULL |    1 |                       3 |
| NULL | NULL |    2 |                       3 |
| NULL | NULL |    3 |                       3 |
| NULL | NULL |    4 |                       3 |
| NULL | NULL |    5 |                       3 |
+------+------+------+-------------------------+
32 rows in set.
</pre></div>
</div>
<p>现在对k1, k2, GROUPING_ID(<code class="docutils literal notranslate"><span class="pre">k1</span></code>, <code class="docutils literal notranslate"><span class="pre">k2</span></code>) 进行 GROUP BY：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>+------+------+-------------------------+-----------+
| k1   | k2   | grouping_id(`k1`, `k2`) | sum(`k3`) |
+------+------+-------------------------+-----------+
| a    | A    |                       0 |         3 |
| a    | B    |                       0 |         4 |
| a    | NULL |                       1 |         7 |
| b    | A    |                       0 |         5 |
| b    | B    |                       0 |         6 |
| b    | NULL |                       1 |        11 |
| NULL | A    |                       2 |         8 |
| NULL | B    |                       2 |        10 |
| NULL | NULL |                       3 |        18 |
+------+------+-------------------------+-----------+
9 rows in set (0.02 sec)
</pre></div>
</div>
<p>可以看到，其结果与对 GROUPING SETS 子句后每个子集进行 GROUP BY 后再进行 UNION 的结果一致。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>select k1, k2, sum(k3) from t group by k1, k2
UNION ALL
select NULL, k2, sum(k3) from t group by k2
UNION ALL
select k1, NULL, sum(k3) from t group by k1
UNION ALL
select NULL, NULL, sum(k3) from t;

+------+------+-----------+
| k1   | k2   | sum(`k3`) |
+------+------+-----------+
| b    | B    |         6 |
| b    | A    |         5 |
| a    | A    |         3 |
| a    | B    |         4 |
| a    | NULL |         7 |
| b    | NULL |        11 |
| NULL | B    |        10 |
| NULL | A    |         8 |
| NULL | NULL |        18 |
+------+------+-----------+
9 rows in set (0.06 sec)
</pre></div>
</div>
</div>
<div class="section" id="fe">
<h3>3.3 FE 规划阶段<a class="headerlink" href="#fe" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id11">
<h4>3.3.1 主要任务<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<ol class="simple">
<li>引入 GroupByClause 类，封装 Group By 相关信息，替换原有的 groupingExprs.</li>
<li>增加 Grouping Sets, Cube 和 RollUp 的语法支持和语法检查、错误处理和错误信息；</li>
<li>在 SelectStmt 类中增加 GroupByClause 成员；</li>
<li>引入 GroupingFunctionCallExpr 类，封装grouping 和grouping_id 函数调用</li>
<li>引入 VirtualSlot 类，封装grouping，grouping_id  生成的虚拟列和实际列的对应关系</li>
<li>增加虚拟列 GROUPING_ID 和其他grouping，grouping_id 函数对应的虚拟列，并将此列加入到原有的 groupingExprs 表达式列表中；</li>
<li>增加一个 PlanNode，考虑更通用的功能，命名为 RepeatNode。对于 GroupingSets 的聚合，在执行计划中插入 RepeatNode。</li>
</ol>
</div>
<div class="section" id="tuple">
<h4>3.3.2 Tuple<a class="headerlink" href="#tuple" title="Permalink to this headline">¶</a></h4>
<p>在 GroupByClause 类中为了将 GROUPING_ID 加到 groupingExprs 表达式列表中，需要创建 virtual SlotRef, 相应的，需要对这个 slot 创建一个 tuple, 叫 GROUPING_ID Tuple。</p>
<p>对于 RepeatNode 这个执行计划，其输入是子节点的所有 tuple， 输出的 tuple 除了 repeat 子节点的数据外，还需要填写 GROUPING_ID 和其他grouping，grouping_id 对应的虚拟列，因此。</p>
</div>
</div>
<div class="section" id="be">
<h3>3.4 BE 查询执行阶段<a class="headerlink" href="#be" title="Permalink to this headline">¶</a></h3>
<p>主要任务：</p>
<ol class="simple">
<li>通过 RepeatNode 的执行类，增加扩展输入行的逻辑，其功能是在聚合之前将原有数据进行 repeat：对每行增加一列 GROUPING_ID， 然后按照 GroupingSets 中的集合数进行 repeat，并对对应列置为 null。根据grouping list设置新增虚拟列的值</li>
<li>实现 grouping_id() 和grouping() 函数。</li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="metadata-design.html" class="btn btn-neutral float-right" title="元数据设计文档" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="doris_storage_optimization.html" class="btn btn-neutral float-left" title="Doris存储文件格式优化" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Apache Doris(Incubating)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
<div role="contentinfo">
    <p></p>
    <p>

        Apache Doris(incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.

    </p>
</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>