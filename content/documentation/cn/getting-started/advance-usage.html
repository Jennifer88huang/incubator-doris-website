

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>高级使用指南 &mdash; Doris Documentations 0.11.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="最佳实践" href="best-practice.html" />
    <link rel="prev" title="基础使用指南" href="basic-usage.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Doris Documentations
          

          
          </a>

          
            
            
              <div class="version">
                0.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">中文</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../installing/index.html">编译与部署</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">开始使用</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="basic-usage.html">基础使用指南</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">高级使用指南</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">1 表结构变更</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rollup">2 Rollup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">2 数据表的查询</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="best-practice.html">最佳实践</a></li>
<li class="toctree-l3"><a class="reference internal" href="data-partition.html">数据划分</a></li>
<li class="toctree-l3"><a class="reference internal" href="data-model-rollup.html">数据模型、ROLLUP 及前缀索引</a></li>
<li class="toctree-l3"><a class="reference internal" href="hit-the-rollup.html">Rollup 与查询</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../administrator-guide/index.html">操作手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending-doris/index.html">扩展功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal/index.html">设计文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sql-reference/index.html">SQL 手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer-guide/index.html">开发者手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../community/index.html">Apache 社区</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../en/index.html">English</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Doris Documentations</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">中文</a> &raquo;</li>
        
          <li><a href="index.html">开始使用</a> &raquo;</li>
        
      <li>高级使用指南</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/incubator-doris/blob/master/docs/documentation/cn/getting-started/advance-usage.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>高级使用指南<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>这里我们介绍 Doris 的一些高级特性。</p>
<div class="section" id="id2">
<h2>1 表结构变更<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>使用 ALTER TABLE 命令可以修改表的 Schema，包括如下修改：</p>
<ul class="simple">
<li>增加列</li>
<li>删除列</li>
<li>修改列类型</li>
<li>改变列顺序</li>
</ul>
<p>以下举例说明。</p>
<p>原表 table1 的 Schema 如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+-------------+------+-------+---------+-------+</span>
<span class="o">|</span> <span class="n">Field</span>    <span class="o">|</span> <span class="n">Type</span>        <span class="o">|</span> <span class="n">Null</span> <span class="o">|</span> <span class="n">Key</span>   <span class="o">|</span> <span class="n">Default</span> <span class="o">|</span> <span class="n">Extra</span> <span class="o">|</span>
<span class="o">+----------+-------------+------+-------+---------+-------+</span>
<span class="o">|</span> <span class="n">siteid</span>   <span class="o">|</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>     <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">true</span>  <span class="o">|</span> <span class="mi">10</span>      <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">citycode</span> <span class="o">|</span> <span class="n">smallint</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">true</span>  <span class="o">|</span> <span class="n">N</span><span class="o">/</span><span class="n">A</span>     <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">username</span> <span class="o">|</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">true</span>  <span class="o">|</span>         <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">pv</span>       <span class="o">|</span> <span class="n">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">false</span> <span class="o">|</span> <span class="mi">0</span>       <span class="o">|</span> <span class="n">SUM</span>   <span class="o">|</span>
<span class="o">+----------+-------------+------+-------+---------+-------+</span>
</pre></div>
</div>
<p>我们新增一列 uv，类型为 BIGINT，聚合类型为 SUM，默认值为 0:</p>
<p><code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span> <span class="pre">table1</span> <span class="pre">ADD</span> <span class="pre">COLUMN</span> <span class="pre">uv</span> <span class="pre">BIGINT</span> <span class="pre">SUM</span> <span class="pre">DEFAULT</span> <span class="pre">'0'</span> <span class="pre">after</span> <span class="pre">pv;</span></code></p>
<p>提交成功后，可以通过以下命令查看作业进度:</p>
<p><code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">ALTER</span> <span class="pre">TABLE</span> <span class="pre">COLUMN;</span></code></p>
<p>当作业状态为 FINISHED，则表示作业完成。新的 Schema 已生效。</p>
<p>ALTER TABLE 完成之后, 可以通过 <code class="docutils literal notranslate"><span class="pre">DESC</span> <span class="pre">TABLE</span></code> 查看最新的 Schema。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">DESC</span> <span class="n">table1</span><span class="p">;</span>
<span class="o">+----------+-------------+------+-------+---------+-------+</span>
<span class="o">|</span> <span class="n">Field</span>    <span class="o">|</span> <span class="n">Type</span>        <span class="o">|</span> <span class="n">Null</span> <span class="o">|</span> <span class="n">Key</span>   <span class="o">|</span> <span class="n">Default</span> <span class="o">|</span> <span class="n">Extra</span> <span class="o">|</span>
<span class="o">+----------+-------------+------+-------+---------+-------+</span>
<span class="o">|</span> <span class="n">siteid</span>   <span class="o">|</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>     <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">true</span>  <span class="o">|</span> <span class="mi">10</span>      <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">citycode</span> <span class="o">|</span> <span class="n">smallint</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">true</span>  <span class="o">|</span> <span class="n">N</span><span class="o">/</span><span class="n">A</span>     <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">username</span> <span class="o">|</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">true</span>  <span class="o">|</span>         <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">pv</span>       <span class="o">|</span> <span class="n">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">false</span> <span class="o">|</span> <span class="mi">0</span>       <span class="o">|</span> <span class="n">SUM</span>   <span class="o">|</span>
<span class="o">|</span> <span class="n">uv</span>       <span class="o">|</span> <span class="n">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">false</span> <span class="o">|</span> <span class="mi">0</span>       <span class="o">|</span> <span class="n">SUM</span>   <span class="o">|</span>
<span class="o">+----------+-------------+------+-------+---------+-------+</span>
<span class="mi">5</span> <span class="n">rows</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
<p>可以使用以下命令取消当前正在执行的作业:</p>
<p><code class="docutils literal notranslate"><span class="pre">CANCEL</span> <span class="pre">ALTER</span> <span class="pre">TABLE</span> <span class="pre">COLUMN</span> <span class="pre">FROM</span> <span class="pre">table1</span></code></p>
<p>更多帮助，可以参阅 <code class="docutils literal notranslate"><span class="pre">HELP</span> <span class="pre">ALTER</span> <span class="pre">TABLE</span></code>。</p>
</div>
<div class="section" id="rollup">
<h2>2 Rollup<a class="headerlink" href="#rollup" title="Permalink to this headline">¶</a></h2>
<p>Rollup 可以理解为 Table 的一个物化索引结构。<strong>物化</strong> 是因为其数据在物理上独立存储，而 <strong>索引</strong> 的意思是，Rollup可以调整列顺序以增加前缀索引的命中率，也可以减少key列以增加数据的聚合度。</p>
<p>以下举例说明。</p>
<p>原表table1的Schema如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+-------------+------+-------+---------+-------+</span>
<span class="o">|</span> <span class="n">Field</span>    <span class="o">|</span> <span class="n">Type</span>        <span class="o">|</span> <span class="n">Null</span> <span class="o">|</span> <span class="n">Key</span>   <span class="o">|</span> <span class="n">Default</span> <span class="o">|</span> <span class="n">Extra</span> <span class="o">|</span>
<span class="o">+----------+-------------+------+-------+---------+-------+</span>
<span class="o">|</span> <span class="n">siteid</span>   <span class="o">|</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>     <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">true</span>  <span class="o">|</span> <span class="mi">10</span>      <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">citycode</span> <span class="o">|</span> <span class="n">smallint</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">true</span>  <span class="o">|</span> <span class="n">N</span><span class="o">/</span><span class="n">A</span>     <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">username</span> <span class="o">|</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">true</span>  <span class="o">|</span>         <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">pv</span>       <span class="o">|</span> <span class="n">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">false</span> <span class="o">|</span> <span class="mi">0</span>       <span class="o">|</span> <span class="n">SUM</span>   <span class="o">|</span>
<span class="o">|</span> <span class="n">uv</span>       <span class="o">|</span> <span class="n">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">false</span> <span class="o">|</span> <span class="mi">0</span>       <span class="o">|</span> <span class="n">SUM</span>   <span class="o">|</span>
<span class="o">+----------+-------------+------+-------+---------+-------+</span>
</pre></div>
</div>
<p>对于 table1 明细数据是 siteid, citycode, username 三者构成一组 key，从而对 pv 字段进行聚合；如果业务方经常有看城市 pv 总量的需求，可以建立一个只有 citycode, pv 的rollup。</p>
<p><code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span> <span class="pre">table1</span> <span class="pre">ADD</span> <span class="pre">ROLLUP</span> <span class="pre">rollup_city(citycode,</span> <span class="pre">pv);</span></code></p>
<p>提交成功后，可以通过以下命令查看作业进度：</p>
<p><code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">ALTER</span> <span class="pre">TABLE</span> <span class="pre">ROLLUP;</span></code></p>
<p>当作业状态为 FINISHED，则表示作业完成。</p>
<p>Rollup 建立完成之后可以使用 <code class="docutils literal notranslate"><span class="pre">DESC</span> <span class="pre">table1</span> <span class="pre">ALL</span></code> 查看表的 Rollup 信息。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">desc</span> <span class="n">table1</span> <span class="nb">all</span><span class="p">;</span>
<span class="o">+-------------+----------+-------------+------+-------+--------+-------+</span>
<span class="o">|</span> <span class="n">IndexName</span>   <span class="o">|</span> <span class="n">Field</span>    <span class="o">|</span> <span class="n">Type</span>        <span class="o">|</span> <span class="n">Null</span> <span class="o">|</span> <span class="n">Key</span>   <span class="o">|</span> <span class="n">Default</span> <span class="o">|</span> <span class="n">Extra</span> <span class="o">|</span>
<span class="o">+-------------+----------+-------------+------+-------+---------+-------+</span>
<span class="o">|</span> <span class="n">table1</span>      <span class="o">|</span> <span class="n">siteid</span>   <span class="o">|</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>     <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">true</span>  <span class="o">|</span> <span class="mi">10</span>      <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span>             <span class="o">|</span> <span class="n">citycode</span> <span class="o">|</span> <span class="n">smallint</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">true</span>  <span class="o">|</span> <span class="n">N</span><span class="o">/</span><span class="n">A</span>     <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span>             <span class="o">|</span> <span class="n">username</span> <span class="o">|</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">true</span>  <span class="o">|</span>         <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span>             <span class="o">|</span> <span class="n">pv</span>       <span class="o">|</span> <span class="n">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">false</span> <span class="o">|</span> <span class="mi">0</span>       <span class="o">|</span> <span class="n">SUM</span>   <span class="o">|</span>
<span class="o">|</span>             <span class="o">|</span> <span class="n">uv</span>       <span class="o">|</span> <span class="n">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">false</span> <span class="o">|</span> <span class="mi">0</span>       <span class="o">|</span> <span class="n">SUM</span>   <span class="o">|</span>
<span class="o">|</span>             <span class="o">|</span>          <span class="o">|</span>             <span class="o">|</span>      <span class="o">|</span>       <span class="o">|</span>         <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">rollup_city</span> <span class="o">|</span> <span class="n">citycode</span> <span class="o">|</span> <span class="n">smallint</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">true</span>  <span class="o">|</span> <span class="n">N</span><span class="o">/</span><span class="n">A</span>     <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span>             <span class="o">|</span> <span class="n">pv</span>       <span class="o">|</span> <span class="n">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="o">|</span> <span class="n">No</span>   <span class="o">|</span> <span class="n">false</span> <span class="o">|</span> <span class="mi">0</span>       <span class="o">|</span> <span class="n">SUM</span>   <span class="o">|</span>
<span class="o">+-------------+----------+-------------+------+-------+---------+-------+</span>
<span class="mi">8</span> <span class="n">rows</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
<p>可以使用以下命令取消当前正在执行的作业:</p>
<p><code class="docutils literal notranslate"><span class="pre">CANCEL</span> <span class="pre">ALTER</span> <span class="pre">TABLE</span> <span class="pre">ROLLUP</span> <span class="pre">FROM</span> <span class="pre">table1;</span></code></p>
<p>Rollup 建立之后，查询不需要指定 Rollup 进行查询。还是指定原有表进行查询即可。程序会自动判断是否应该使用 Rollup。是否命中 Rollup可以通过 <code class="docutils literal notranslate"><span class="pre">EXPLAIN</span> <span class="pre">your_sql;</span></code> 命令进行查看。</p>
<p>更多帮助，可以参阅 <code class="docutils literal notranslate"><span class="pre">HELP</span> <span class="pre">ALTER</span> <span class="pre">TABLE</span></code>。</p>
</div>
<div class="section" id="id3">
<h2>2 数据表的查询<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id4">
<h3>2.1 内存限制<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>为了防止用户的一个查询可能因为消耗内存过大。查询进行了内存控制，一个查询任务，在单个 BE 节点上默认使用不超过 2GB 内存。</p>
<p>用户在使用时，如果发现报 <code class="docutils literal notranslate"><span class="pre">Memory</span> <span class="pre">limit</span> <span class="pre">exceeded</span></code> 错误，一般是超过内存限制了。</p>
<p>遇到内存超限时，用户应该尽量通过优化自己的 sql 语句来解决。</p>
<p>如果确切发现2GB内存不能满足，可以手动设置内存参数。</p>
<p>显示查询内存限制:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">VARIABLES</span> <span class="n">LIKE</span> <span class="s2">&quot;%mem_limit%&quot;</span><span class="p">;</span>
<span class="o">+---------------+------------+</span>
<span class="o">|</span> <span class="n">Variable_name</span> <span class="o">|</span> <span class="n">Value</span>      <span class="o">|</span>
<span class="o">+---------------+------------+</span>
<span class="o">|</span> <span class="n">exec_mem_limit</span><span class="o">|</span> <span class="mi">2147483648</span> <span class="o">|</span>
<span class="o">+---------------+------------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">exec_mem_limit</span></code> 的单位是 byte，可以通过 <code class="docutils literal notranslate"><span class="pre">SET</span></code> 命令改变 <code class="docutils literal notranslate"><span class="pre">exec_mem_limit</span></code> 的值。如改为 8GB。</p>
<p><code class="docutils literal notranslate"><span class="pre">SET</span> <span class="pre">exec_mem_limit</span> <span class="pre">=</span> <span class="pre">8589934592;</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">VARIABLES</span> <span class="n">LIKE</span> <span class="s2">&quot;%mem_limit%&quot;</span><span class="p">;</span>
<span class="o">+---------------+------------+</span>
<span class="o">|</span> <span class="n">Variable_name</span> <span class="o">|</span> <span class="n">Value</span>      <span class="o">|</span>
<span class="o">+---------------+------------+</span>
<span class="o">|</span> <span class="n">exec_mem_limit</span><span class="o">|</span> <span class="mi">8589934592</span> <span class="o">|</span>
<span class="o">+---------------+------------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><ul class="simple">
<li>以上该修改为 session 级别，仅在当前连接 session 内有效。断开重连则会变回默认值。</li>
<li>如果需要修改全局变量，可以这样设置：<code class="docutils literal notranslate"><span class="pre">SET</span> <span class="pre">GLOBAL</span> <span class="pre">exec_mem_limit</span> <span class="pre">=</span> <span class="pre">8589934592;</span></code>。设置完成后，断开 session 重新登录，参数将永久生效。</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id5">
<h3>2.2 查询超时<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>当前默认查询时间设置为最长为 300 秒，如果一个查询在 300 秒内没有完成，则查询会被 Doris 系统 cancel 掉。用户可以通过这个参数来定制自己应用的超时时间，实现类似 wait(timeout) 的阻塞方式。</p>
<p>查看当前超时设置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">VARIABLES</span> <span class="n">LIKE</span> <span class="s2">&quot;%query_timeout%&quot;</span><span class="p">;</span>
<span class="o">+---------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span> <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+---------------+-------+</span>
<span class="o">|</span> <span class="n">QUERY_TIMEOUT</span> <span class="o">|</span> <span class="mi">300</span>   <span class="o">|</span>
<span class="o">+---------------+-------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
<p>修改超时时间到1分钟:</p>
<p><code class="docutils literal notranslate"><span class="pre">SET</span> <span class="pre">query_timeout</span> <span class="pre">=</span> <span class="pre">60;</span></code></p>
<blockquote>
<div><ul class="simple">
<li>当前超时的检查间隔为 5 秒，所以小于 5 秒的超时不会太准确。</li>
<li>以上修改同样为 session 级别。可以通过 <code class="docutils literal notranslate"><span class="pre">SET</span> <span class="pre">GLOBAL</span></code> 修改全局有效。</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="broadcast-shuffle-join">
<h3>2.3 Broadcast/Shuffle Join<a class="headerlink" href="#broadcast-shuffle-join" title="Permalink to this headline">¶</a></h3>
<p>系统默认实现 Join 的方式，是将小表进行条件过滤后，将其广播到大表所在的各个节点上，形成一个内存 Hash 表，然后流式读出大表的数据进行Hash Join。但是如果当小表过滤后的数据量无法放入内存的话，此时 Join 将无法完成，通常的报错应该是首先造成内存超限。</p>
<p>如果遇到上述情况，建议使用 Shuffle Join 的方式，也被称作 Partitioned Join。即将小表和大表都按照 Join 的 key 进行 Hash，然后进行分布式的 Join。这个对内存的消耗就会分摊到集群的所有计算节点上。</p>
<p>使用 Broadcast Join（默认）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mysql&gt; select sum(table1.pv) from table1 join table2 where table1.siteid = 2;
+--------------------+
| sum(`table1`.`pv`) |
+--------------------+
|                 10 |
+--------------------+
1 row in set (0.20 sec)
</pre></div>
</div>
<p>使用 Broadcast Join（显式指定）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mysql&gt; select sum(table1.pv) from table1 join [broadcast] table2 where table1.siteid = 2;
+--------------------+
| sum(`table1`.`pv`) |
+--------------------+
|                 10 |
+--------------------+
1 row in set (0.20 sec)
</pre></div>
</div>
<p>使用 Shuffle Join:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mysql&gt; select sum(table1.pv) from table1 join [shuffle] table2 where table1.siteid = 2;
+--------------------+
| sum(`table1`.`pv`) |
+--------------------+
|                 10 |
+--------------------+
1 row in set (0.15 sec)
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>2.4 查询重试和高可用<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>当部署多个 FE 节点时，用户可以在多个 FE 之上部署负载均衡层来实现 Doris 的高可用。</p>
<p>一下提供一些高可用的方案：</p>
<p><strong>第一种</strong></p>
<p>自己在应用层代码进行重试和负载均衡。比如发现一个连接挂掉，就自动在其他连接上进行重试。应用层代码重试需要应用自己配置多个doris前端节点地址。</p>
<p><strong>第二种</strong></p>
<p>如果使用 mysql jdbc connector 来连接Doris，可以使用 jdbc 的自动重试机制:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>jdbc:mysql://[host:port],[host:port].../[database][?propertyName1][=propertyValue1][&amp;propertyName2][=propertyValue2]...
</pre></div>
</div>
<p><strong>第三种</strong></p>
<p>应用可以连接到和应用部署到同一机器上的 MySQL Proxy，通过配置 MySQL Proxy 的 Failover 和 Load Balance 功能来达到目的。</p>
<p><code class="docutils literal notranslate"><span class="pre">http://dev.mysql.com/doc/refman/5.6/en/mysql-proxy-using.html</span></code></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="best-practice.html" class="btn btn-neutral float-right" title="最佳实践" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="basic-usage.html" class="btn btn-neutral float-left" title="基础使用指南" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Apache Doris(Incubating)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
<div role="contentinfo">
    <p></p>
    <p>

        Apache Doris is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the name of Apache TLP sponsor. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.

    </p>
</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>