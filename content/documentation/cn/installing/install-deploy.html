

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>安装与部署 &mdash; Doris Documentations 0.11.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="集群升级" href="upgrade.html" />
    <link rel="prev" title="编译" href="compilation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Doris Documentations
          

          
          </a>

          
            
            
              <div class="version">
                0.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">中文</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">编译与部署</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="compilation.html">编译</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">安装与部署</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">软硬件需求</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">集群部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">扩容缩容</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">常见问题</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="upgrade.html">集群升级</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/index.html">开始使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../administrator-guide/index.html">操作手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending-doris/index.html">扩展功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal/index.html">设计文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sql-reference/index.html">SQL 手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer-guide/index.html">开发者手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../community/index.html">Apache 社区</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../en/index.html">English</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Doris Documentations</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">中文</a> &raquo;</li>
        
          <li><a href="index.html">编译与部署</a> &raquo;</li>
        
      <li>安装与部署</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/incubator-doris/blob/master/docs/documentation/cn/installing/install-deploy.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <!-- 
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
--><div class="section" id="id1">
<h1>安装与部署<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>该文档主要介绍了部署 Doris 所需软硬件环境、建议的部署方式、集群扩容缩容，以及集群搭建到运行过程中的常见问题。在阅读本文档前，请先根据编译文档编译 Doris。</p>
<div class="section" id="id2">
<h2>软硬件需求<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3>概述<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Doris 作为一款开源的 MPP 架构 OLAP 数据库，能够运行在绝大多数主流的商用服务器上。为了能够充分运用 MPP 架构的并发优势，以及 Doris 的高可用特性，我们建议 Doris 的部署遵循以下需求：</p>
<div class="section" id="linux">
<h4>Linux 操作系统版本需求<a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<thead>
<tr>
<th>Linux 系统</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>CentOS</td>
<td>7.1 及以上</td>
</tr>
<tr>
<td>Ubuntu</td>
<td>16.04 及以上</td>
</tr>
</tbody>
</table></div>
<div class="section" id="id4">
<h4>软件需求<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<thead>
<tr>
<th>软件</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>Java</td>
<td>1.8 及以上</td>
</tr>
<tr>
<td>GCC</td>
<td>4.8.2 及以上</td>
</tr>
</tbody>
</table></div>
<div class="section" id="id5">
<h4>开发测试环境<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<thead>
<tr>
<th>模块</th>
<th>CPU</th>
<th>内存</th>
<th>磁盘</th>
<th>网络</th>
<th>实例数量</th>
</tr>
</thead>
<tbody>
<tr>
<td>Frontend</td>
<td>8核+</td>
<td>8GB+</td>
<td>SSD 或 SATA，10GB+ *</td>
<td>千兆网卡</td>
<td>1</td>
</tr>
<tr>
<td>Backend</td>
<td>8核+</td>
<td>16GB+</td>
<td>SSD 或 SATA，50GB+ *</td>
<td>千兆网卡</td>
<td>1-3 *</td>
</tr>
</tbody>
</table></div>
<div class="section" id="id6">
<h4>生产环境<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<thead>
<tr>
<th>模块</th>
<th>CPU</th>
<th>内存</th>
<th>磁盘</th>
<th>网络</th>
<th>实例数量（最低要求）</th>
</tr>
</thead>
<tbody>
<tr>
<td>Frontend</td>
<td>16核+</td>
<td>64GB+</td>
<td>SSD 或 RAID 卡，100GB+ *</td>
<td>万兆网卡</td>
<td>1-5 *</td>
</tr>
<tr>
<td>Backend</td>
<td>16核+</td>
<td>64GB+</td>
<td>SSD 或 SATA，100G+ *</td>
<td>万兆网卡</td>
<td>10-100 *</td>
</tr>
</tbody>
</table><blockquote>
<div><p>注1：</p>
<ol class="simple">
<li>FE 的磁盘空间主要用于存储元数据，包括日志和 image。通常从几百 MB 到几个 GB 不等。</li>
<li>BE 的磁盘空间主要用于存放用户数据，总磁盘空间按用户总数据量 * 3（3副本）计算，然后再预留额外 40% 的空间用作后台 compaction 以及一些中间数据的存放。</li>
<li>一台机器上可以部署多个 BE 实例，但是<strong>只能部署一个 FE</strong>。如果需要 3 副本数据，那么至少需要 3 台机器各部署一个 BE 实例（而不是1台机器部署3个BE实例）。<strong>多个FE所在服务器的时钟必须保持一致（允许最多5秒的时钟偏差）</strong></li>
<li>测试环境也可以仅适用一个 BE 进行测试。实际生产环境，BE 实例数量直接决定了整体查询延迟。</li>
<li>所有部署节点关闭 Swap。</li>
</ol>
</div></blockquote>
<blockquote>
<div><p>注2：FE 节点的数量</p>
<ol class="simple">
<li>FE 角色分为 Follower 和 Observer，（Leader 为 Follower 组中选举出来的一种角色，以下统称 Follower，具体含义见 <a class="reference internal" href="../internal/metadata-design.html"><span class="doc">元数据设计文档</span></a>）。</li>
<li>FE 节点数据至少为1（1 个 Follower）。当部署 1 个 Follower 和 1 个 Observer 时，可以实现读高可用。当部署 3 个 Follower 时，可以实现读写高可用（HA）。</li>
<li>Follower 的数量<strong>必须</strong>为奇数，Observer 数量随意。</li>
<li>根据以往经验，当集群可用性要求很高是（比如提供在线业务），可以部署 3 个 Follower 和 1-3 个 Observer。如果是离线业务，建议部署 1 个 Follower 和 1-3 个 Observer。</li>
</ol>
</div></blockquote>
<ul class="simple">
<li><strong>通常我们建议 10 ~ 100 台左右的机器，来充分发挥 Doris 的性能（其中 3 台部署 FE（HA），剩余的部署 BE）</strong></li>
<li><strong>当然，Doris的性能与节点数量及配置正相关。在最少4台机器（一台 FE，三台 BE，其中一台 BE 混部一个 Observer FE 提供元数据备份），以及较低配置的情况下，依然可以平稳的运行 Doris。</strong></li>
<li><strong>如果 FE 和 BE 混部，需注意资源竞争问题，并保证元数据目录和数据目录分属不同磁盘。</strong></li>
</ul>
</div>
<div class="section" id="broker">
<h4>Broker 部署<a class="headerlink" href="#broker" title="Permalink to this headline">¶</a></h4>
<p>Broker 是用于访问外部数据源（如 hdfs）的进程。通常，在每台机器上部署一个 broker 实例即可。</p>
</div>
<div class="section" id="id7">
<h4>网络需求<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>Doris 各个实例直接通过网络进行通讯。以下表格展示了所有需要的端口</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>实例名称</th>
<th>端口名称</th>
<th>默认端口</th>
<th>通讯方向</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>BE</td>
<td>be_port</td>
<td>9060</td>
<td>FE --&gt; BE</td>
<td>BE 上 thrift server 的端口，用于接收来自 FE 的请求</td>
</tr>
<tr>
<td>BE</td>
<td>webserver_port</td>
<td>8040</td>
<td>BE &lt;--&gt; BE</td>
<td>BE 上的 http server 的端口</td>
</tr>
<tr>
<td>BE</td>
<td>heartbeat_service_port</td>
<td>9050</td>
<td>FE --&gt; BE</td>
<td>BE 上心跳服务端口（thrift），用于接收来自 FE 的心跳</td>
</tr>
<tr>
<td>BE</td>
<td>brpc_port*</td>
<td>8060</td>
<td>FE&lt;--&gt;BE, BE &lt;--&gt; BE</td>
<td>BE 上的 brpc 端口，用于 BE 之间通讯</td>
</tr>
<tr>
<td>FE</td>
<td>http_port *</td>
<td>8030</td>
<td>FE &lt;--&gt; FE，用户</td>
<td>FE 上的 http server 端口</td>
</tr>
<tr>
<td>FE</td>
<td>rpc_port</td>
<td>9020</td>
<td>BE --&gt; FE, FE &lt;--&gt; FE</td>
<td>FE 上的 thrift server 端口</td>
</tr>
<tr>
<td>FE</td>
<td>query_port</td>
<td>9030</td>
<td>用户</td>
<td>FE 上的 mysql server 端口</td>
</tr>
<tr>
<td>FE</td>
<td>edit_log_port</td>
<td>9010</td>
<td>FE &lt;--&gt; FE</td>
<td>FE 上的 bdbje 之间通信用的端口</td>
</tr>
<tr>
<td>Broker</td>
<td>broker_ipc_port</td>
<td>8000</td>
<td>FE --&gt; Broker, BE --&gt; Broker</td>
<td>Broker 上的 thrift server，用于接收请求</td>
</tr>
</tbody>
</table><blockquote>
<div><p>注：</p>
<ol class="simple">
<li>当部署多个 FE 实例时，要保证 FE 的 http_port 配置相同。</li>
<li>部署前请确保各个端口在应有方向上的访问权限。</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="ip">
<h4>IP 绑定<a class="headerlink" href="#ip" title="Permalink to this headline">¶</a></h4>
<p>因为有多网卡的存在，或因为安装过 docker 等环境导致的虚拟网卡的存在，同一个主机可能存在多个不同的 ip。当前 Doris 并不能自动识别可用 IP。所以当遇到部署主机上有多个 IP 时，必须通过 priority_networks 配置项来强制指定正确的 IP。</p>
<p>priority_networks 是 FE 和 BE 都有的一个配置，配置项需写在 fe.conf 和 be.conf 中。该配置项用于在 FE 或 BE 启动时，告诉进程应该绑定哪个IP。示例如下：</p>
<p><code class="docutils literal notranslate"><span class="pre">priority_networks=10.1.3.0/24</span></code></p>
<p>这是一种 <a class="reference external" href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing">CIDR</a> 的表示方法。FE 或 BE 会根据这个配置项来寻找匹配的IP，作为自己的 localIP。</p>
<p><strong>注意</strong>：当配置完 priority_networks 并启动 FE 或 BE 后，只是保证了 FE 或 BE 自身的 IP 进行了正确的绑定。而在使用 ADD BACKEND 或 ADD FRONTEND 语句中，也需要指定和 priority_networks 配置匹配的 IP，否则集群无法建立。举例：</p>
<p>BE 的配置为：<code class="docutils literal notranslate"><span class="pre">priority_networks=10.1.3.0/24</span></code></p>
<p>但是在 ADD BACKEND 时使用的是：<code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">ADD</span> <span class="pre">BACKEND</span> <span class="pre">&quot;192.168.0.1:9050&quot;;</span></code></p>
<p>则 FE 和 BE 将无法正常通信。</p>
<p>这时，必须 DROP 掉这个添加错误的 BE，重新使用正确的 IP 执行 ADD BACKEND。</p>
<p>FE 同理。</p>
<p>BROKER 当前没有，也不需要 priority_networks 这个选项。Broker 的服务默认绑定在 0.0.0.0 上。只需在 ADD BROKER 时，执行正确可访问的 BROKER IP 即可。</p>
</div>
</div>
</div>
<div class="section" id="id8">
<h2>集群部署<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id9">
<h3>手动部署<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<div class="section" id="fe">
<h4>FE 部署<a class="headerlink" href="#fe" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">拷贝 FE 部署文件到指定节点</p>
<p>将源码编译生成的 output 下的 fe 文件夹拷贝到 FE 的节点指定部署路径下。</p>
</li>
<li><p class="first">配置 FE</p>
<ol class="simple">
<li>配置文件为 conf/fe.conf。其中注意：<code class="docutils literal notranslate"><span class="pre">meta_dir</span></code>：元数据存放位置。默认在 fe/palo-meta/ 下。需<strong>手动创建</strong>该目录。</li>
<li>fe.conf 中 JAVA_OPTS 默认 java 最大堆内存为 4GB，建议生产环境调整至 8G 以上。</li>
</ol>
</li>
<li><p class="first">启动FE</p>
<p><code class="docutils literal notranslate"><span class="pre">sh</span> <span class="pre">bin/start_fe.sh</span> <span class="pre">--daemon</span></code></p>
<p>FE进程启动进入后台执行。日志默认存放在 fe/log/ 目录下。如启动失败，可以通过查看 fe/log/fe.log 或者 fe/log/fe.out 查看错误信息。</p>
</li>
<li><p class="first">如需部署多 FE，请参见 “FE 扩容和缩容” 章节</p>
</li>
</ul>
</div>
<div class="section" id="be">
<h4>BE 部署<a class="headerlink" href="#be" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">拷贝 BE 部署文件到所有要部署 BE 的节点</p>
<p>将源码编译生成的 output 下的 be 文件夹拷贝到 BE 的节点的指定部署路径下。</p>
</li>
<li><p class="first">修改所有 BE 的配置</p>
<p>修改 be/conf/be.conf。主要是配置 <code class="docutils literal notranslate"><span class="pre">storage_root_path</span></code>：数据存放目录，使用 <code class="docutils literal notranslate"><span class="pre">;</span></code> 分隔（最后一个目录后不要加 <code class="docutils literal notranslate"><span class="pre">;</span></code>），其它可以采用默认值。</p>
</li>
<li><p class="first">在 FE 中添加所有 BE 节点</p>
<p>BE 节点需要先在 FE 中添加，才可加入集群。可以使用 mysql-client 连接到 FE：</p>
<p><code class="docutils literal notranslate"><span class="pre">./mysql-client</span> <span class="pre">-h</span> <span class="pre">host</span> <span class="pre">-P</span> <span class="pre">port</span> <span class="pre">-uroot</span></code></p>
<p>其中 host 为 FE 所在节点 ip；port 为 fe/conf/fe.conf 中的 query_port；默认使用 root 账户，无密码登录。</p>
<p>登录后，执行以下命令来添加每一个 BE：</p>
<p><code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">ADD</span> <span class="pre">BACKEND</span> <span class="pre">&quot;host:port&quot;;</span></code></p>
<p>如果使用多租户功能，则执行以下命令添加 BE:</p>
<p><code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">ADD</span> <span class="pre">FREE</span> <span class="pre">BACKEND</span> <span class="pre">&quot;host:port&quot;;</span></code></p>
<p>其中 host 为 BE 所在节点 ip；port 为 be/conf/be.conf 中的 heartbeat_service_port。</p>
<p>如果不添加 FREE 关键字，BE 默认进入自动生成的 cluster，添加了 FREE 关键字后新的 BE 不属于任何 cluster，这样创建新 cluster 的时候就可以从这些空闲的be中选取，详细见<a class="reference internal" href="../administrator-guide/operation/multi-tenant.html"><span class="doc">多租户设计文档</span></a></p>
</li>
<li><p class="first">启动 BE</p>
<p><code class="docutils literal notranslate"><span class="pre">sh</span> <span class="pre">bin/start_be.sh</span> <span class="pre">--daemon</span></code></p>
<p>BE 进程将启动并进入后台执行。日志默认存放在 be/log/ 目录下。如启动失败，可以通过查看 be/log/be.log 或者 be/log/be.out 查看错误信息。</p>
</li>
<li><p class="first">查看BE状态</p>
<p>使用 mysql-client 连接到 FE，并执行 <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">PROC</span> <span class="pre">'/backends';</span></code> 查看 BE 运行情况。如一切正常，<code class="docutils literal notranslate"><span class="pre">isAlive</span></code> 列应为 <code class="docutils literal notranslate"><span class="pre">true</span></code>。</p>
</li>
</ul>
</div>
<div class="section" id="fs-broker">
<h4>（可选）FS_Broker 部署<a class="headerlink" href="#fs-broker" title="Permalink to this headline">¶</a></h4>
<p>Broker 以插件的形式，独立于 Doris 部署。如果需要从第三方存储系统导入数据，需要部署相应的 Broker，默认提供了读取 HDFS 和百度云 BOS 的 fs_broker。fs_broker 是无状态的，建议每一个 FE 和 BE 节点都部署一个 Broker。</p>
<ul>
<li><p class="first">拷贝源码 fs_broker 的 output 目录下的相应 Broker 目录到需要部署的所有节点上。建议和 BE 或者 FE 目录保持同级。</p>
</li>
<li><p class="first">修改相应 Broker 配置</p>
<p>在相应 broker/conf/ 目录下对应的配置文件中，可以修改相应配置。</p>
</li>
<li><p class="first">启动 Broker</p>
<p><code class="docutils literal notranslate"><span class="pre">sh</span> <span class="pre">bin/start_broker.sh</span> <span class="pre">--daemon</span></code> 启动 Broker。</p>
</li>
<li><p class="first">添加 Broker</p>
<p>要让 Doris 的 FE 和 BE 知道 Broker 在哪些节点上，通过 sql 命令添加 Broker 节点列表。</p>
<p>使用 mysql-client 连接启动的 FE，执行以下命令：</p>
<p><code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">ADD</span> <span class="pre">BROKER</span> <span class="pre">broker_name</span> <span class="pre">&quot;host1:port1&quot;,&quot;host2:port2&quot;,...;</span></code></p>
<p>其中 host 为 Broker 所在节点 ip；port 为 Broker 配置文件中的 broker_ipc_port。</p>
</li>
<li><p class="first">查看 Broker 状态</p>
<p>使用 mysql-client 连接任一已启动的 FE，执行以下命令查看 Broker 状态：<code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">PROC</span> <span class="pre">&quot;/brokers&quot;;</span></code></p>
</li>
</ul>
<p><strong>注：在生产环境中，所有实例都应使用守护进程启动，以保证进程退出后，会被自动拉起，如 <a class="reference external" href="http://supervisord.org/">Supervisor</a>。如需使用守护进程启动，在 0.9.0 及之前版本中，需要修改各个 start_xx.sh 脚本，去掉最后的 &amp; 符号</strong>。从 0.10.0 版本开始，直接调用 <code class="docutils literal notranslate"><span class="pre">sh</span> <span class="pre">start_xx.sh</span></code> 启动即可。也可参考 <a class="reference external" href="https://www.cnblogs.com/lenmom/p/9973401.html">这里</a></p>
</div>
</div>
</div>
<div class="section" id="id10">
<h2>扩容缩容<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<p>Doris 可以很方便的扩容和缩容 FE、BE、Broker 实例。</p>
<div class="section" id="id11">
<h3>FE 扩容和缩容<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>可以通过将 FE 扩容至 3 个一上节点来实现 FE 的高可用。</p>
<p>用户可以通过 mysql 客户端登陆 Master FE。通过:</p>
<p><code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">PROC</span> <span class="pre">'/frontends';</span></code></p>
<p>来查看当前 FE 的节点情况。</p>
<p>也可以通过前端页面连接：<code class="docutils literal notranslate"><span class="pre">http://fe_hostname:fe_http_port/frontend</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">http://fe_hostname:fe_http_port/system?path=//frontends</span></code> 来查看 FE 节点的情况。</p>
<p>以上方式，都需要 Doris 的 root 用户权限。</p>
<p>FE 节点的扩容和缩容过程，不影响当前系统运行。</p>
<div class="section" id="id12">
<h4>增加 FE 节点<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>FE 分为 Leader，Follower 和 Observer 三种角色。 默认一个集群，只能有一个 Leader，可以有多个 Follower 和 Observer。其中 Leader 和 Follower 组成一个 Paxos 选择组，如果 Leader 宕机，则剩下的 Follower 会自动选出新的 Leader，保证写入高可用。Observer 同步 Leader 的数据，但是不参加选举。如果只部署一个 FE，则 FE 默认就是 Leader。</p>
<p>第一个启动的 FE 自动成为 Leader。在此基础上，可以添加若干 Follower 和 Observer。</p>
<p>添加 Follower 或 Observer。使用 mysql-client 连接到已启动的 FE，并执行：</p>
<p><code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">ADD</span> <span class="pre">FOLLOWER</span> <span class="pre">&quot;host:port&quot;;</span></code></p>
<p>或</p>
<p><code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">ADD</span> <span class="pre">OBSERVER</span> <span class="pre">&quot;host:port&quot;;</span></code></p>
<p>其中 host 为 Follower 或 Observer 所在节点 ip，port 为其配置文件 fe.conf 中的 edit_log_port。</p>
<p>配置及启动 Follower 或 Observer。Follower 和 Observer 的配置同 Leader 的配置。第一次启动时，需执行以下命令：</p>
<p><code class="docutils literal notranslate"><span class="pre">./bin/start_fe.sh</span> <span class="pre">--helper</span> <span class="pre">host:port</span> <span class="pre">--daemon</span></code></p>
<p>查看 Follower 或 Observer 运行状态。使用 mysql-client 连接到任一已启动的 FE，并执行：SHOW PROC ‘/frontends’; 可以查看当前已加入集群的 FE 及其对应角色。</p>
<blockquote>
<div><p>FE 扩容注意事项：</p>
<ol class="simple">
<li>Follower FE（包括 Leader）的数量必须为奇数，建议最多部署 3 个组成高可用（HA）模式即可。</li>
<li>当 FE 处于高可用部署时（1个 Leader，2个 Follower），我们建议通过增加 Observer FE 来扩展 FE 的读服务能力。当然也可以继续增加 Follower FE，但几乎是不必要的。</li>
<li>通常一个 FE 节点可以应对 10-20 台 BE 节点。建议总的 FE 节点数量在 10 个以下。而通常 3 个即可满足绝大部分需求。</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="id13">
<h4>删除 FE 节点<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p>使用以下命令删除对应的 FE 节点：</p>
<p><code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">DROP</span> <span class="pre">FOLLOWER[OBSERVER]</span> <span class="pre">&quot;fe_host:edit_log_port&quot;;</span></code></p>
<blockquote>
<div><p>FE 缩容注意事项：</p>
<ol class="simple">
<li>删除 Follower FE 时，确保最终剩余的 Follower（包括 Leader）节点为奇数。</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="id14">
<h3>BE 扩容和缩容<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>用户可以通过 mysql-client 登陆 Leader FE。通过:</p>
<p><code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">PROC</span> <span class="pre">'/backends';</span></code></p>
<p>来查看当前 BE 的节点情况。</p>
<p>也可以通过前端页面连接：<code class="docutils literal notranslate"><span class="pre">http://fe_hostname:fe_http_port/backend</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">http://fe_hostname:fe_http_port/system?path=//backends</span></code> 来查看 BE 节点的情况。</p>
<p>以上方式，都需要 Doris 的 root 用户权限。</p>
<p>BE 节点的扩容和缩容过程，不影响当前系统运行以及正在执行的任务，并且不会影响当前系统的性能。数据均衡会自动进行。根据集群现有数据量的大小，集群会在几个小时到1天不等的时间内，恢复到负载均衡的状态。集群负载情况，可以参见 <a class="reference internal" href="../administrator-guide/operation/tablet-repair-and-balance.html"><span class="doc">Tablet 负载均衡文档</span></a>。</p>
<div class="section" id="id15">
<h4>增加 BE 节点<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>BE 节点的增加方式同 <strong>BE 部署</strong> 一节中的方式，通过 <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">ADD</span> <span class="pre">BACKEND</span></code> 命令增加 BE 节点。</p>
<blockquote>
<div><p>BE 扩容注意事项：</p>
<ol class="simple">
<li>BE 扩容后，Doris 会自动根据负载情况，进行数据均衡，期间不影响使用。</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="id16">
<h4>删除 BE 节点<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>删除 BE 节点有两种方式：DROP 和 DECOMMISSION</p>
<p>DROP 语句如下：</p>
<p><code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">DROP</span> <span class="pre">BACKEND</span> <span class="pre">&quot;be_host:be_heartbeat_service_port&quot;;</span></code></p>
<p><strong>注意：DROP BACKEND 会直接删除该 BE，并且其上的数据将不能再恢复！！！所以我们强烈不推荐使用 DROP BACKEND 这种方式删除 BE 节点。当你使用这个语句时，会有对应的防误操作提示。</strong></p>
<p>DECOMMISSION 语句如下：</p>
<p><code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">DECOMMISSION</span> <span class="pre">BACKEND</span> <span class="pre">&quot;be_host:be_heartbeat_service_port&quot;;</span></code></p>
<blockquote>
<div><p>DECOMMISSION 命令说明：</p>
<ol class="simple">
<li>该命令用于安全删除 BE 节点。命令下发后，Doris 会尝试将该 BE 上的数据向其他 BE 节点迁移，当所有数据都迁移完成后，Doris 会自动删除该节点。</li>
<li>该命令是一个异步操作。执行后，可以通过 <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">PROC</span> <span class="pre">'/backends';</span></code> 看到该 BE 节点的 isDecommission 状态为 true。表示该节点正在进行下线。</li>
<li>该命令<strong>不一定执行成功</strong>。比如剩余 BE 存储空间不足以容纳下线 BE 上的数据，或者剩余机器数量不满足最小副本数时，该命令都无法完成，并且 BE 会一直处于 isDecommission 为 true 的状态。</li>
<li>DECOMMISSION 的进度，可以通过 <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">PROC</span> <span class="pre">'/backends';</span></code> 中的 TabletNum 查看，如果正在进行，TabletNum 将不断减少。</li>
<li>该操作可以通过:<code class="docutils literal notranslate"><span class="pre">CANCEL</span> <span class="pre">DECOMMISSION</span> <span class="pre">BACKEND</span> <span class="pre">&quot;be_host:be_heartbeat_service_port&quot;;</span></code>命令取消。取消后，该 BE 上的数据将维持当前剩余的数据量。后续 Doris 重新进行负载均衡</li>
</ol>
</div></blockquote>
<p><strong>对于多租户部署环境下，BE 节点的扩容和缩容，请参阅 <a class="reference internal" href="../administrator-guide/operation/multi-tenant.html"><span class="doc">多租户设计文档</span></a>。</strong></p>
</div>
</div>
<div class="section" id="id17">
<h3>Broker 扩容缩容<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>Broker 实例的数量没有硬性要求。通常每台物理机部署一个即可。Broker 的添加和删除可以通过以下命令完成：</p>
<p><code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">ADD</span> <span class="pre">BROKER</span> <span class="pre">broker_name</span> <span class="pre">&quot;broker_host:broker_ipc_port&quot;;</span></code>
<code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">DROP</span> <span class="pre">BROKER</span> <span class="pre">broker_name</span> <span class="pre">&quot;broker_host:broker_ipc_port&quot;;</span></code>
<code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">DROP</span> <span class="pre">ALL</span> <span class="pre">BROKER</span> <span class="pre">broker_name;</span></code></p>
<p>Broker 是无状态的进程，可以随意启停。当然，停止后，正在其上运行的作业会失败，重试即可。</p>
</div>
</div>
<div class="section" id="id18">
<h2>常见问题<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id19">
<h3>进程相关<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<ol>
<li><p class="first">如何确定 FE 进程启动成功</p>
<p>FE 进程启动后，会首先加载元数据，根据 FE 角色的不同，在日志中会看到 <code class="docutils literal notranslate"><span class="pre">transfer</span> <span class="pre">from</span> <span class="pre">UNKNOWN</span> <span class="pre">to</span> <span class="pre">MASTER/FOLLOWER/OBSERVER</span></code>。最终会看到 <code class="docutils literal notranslate"><span class="pre">thrift</span> <span class="pre">server</span> <span class="pre">started</span></code> 日志，并且可以通过 mysql 客户端连接到 FE，则表示 FE 启动成功。</p>
<p>也可以通过如下连接查看是否启动成功：<code class="docutils literal notranslate"><span class="pre">http://fe_host:fe_http_port/api/bootstrap</span></code></p>
<p>如果返回：<code class="docutils literal notranslate"><span class="pre">{&quot;status&quot;:&quot;OK&quot;,&quot;msg&quot;:&quot;Success&quot;}</span></code></p>
<p>则表示启动成功，其余情况，则可能存在问题。</p>
<blockquote>
<div><p>注：如果在 fe.log 中查看不到启动失败的信息，也许在 fe.out 中可以看到。</p>
</div></blockquote>
</li>
<li><p class="first">如何确定 BE 进程启动成功</p>
<p>BE 进程启动后，如果之前有数据，则可能有数分钟不等的数据索引加载时间。</p>
<p>如果是 BE 的第一次启动，或者该 BE 尚未加入任何集群，则 BE 日志会定期滚动 <code class="docutils literal notranslate"><span class="pre">waiting</span> <span class="pre">to</span> <span class="pre">receive</span> <span class="pre">first</span> <span class="pre">heartbeat</span> <span class="pre">from</span> <span class="pre">frontend</span></code> 字样。表示 BE 还未通过 FE 的心跳收到 Master 的地址，正在被动等待。这种错误日志，在 FE 中 ADD BACKEND 并发送心跳后，就会消失。如果在接到心跳后，又重复出现 <code class="docutils literal notranslate"><span class="pre">master</span> <span class="pre">client,</span> <span class="pre">get</span> <span class="pre">client</span> <span class="pre">from</span> <span class="pre">cache</span> <span class="pre">failed.host:</span> <span class="pre">,</span> <span class="pre">port:</span> <span class="pre">0,</span> <span class="pre">code:</span> <span class="pre">7</span></code> 字样，说明 FE 成功连接了 BE，但 BE 无法主动连接 FE。可能需要检查 BE 到 FE 的 rpc_port 的连通性。</p>
<p>如果 BE 已经被加入集群，日志中应该每隔 5 秒滚动来自 FE 的心跳日志：<code class="docutils literal notranslate"><span class="pre">get</span> <span class="pre">heartbeat,</span> <span class="pre">host:</span> <span class="pre">xx.xx.xx.xx,</span> <span class="pre">port:</span> <span class="pre">9020,</span> <span class="pre">cluster</span> <span class="pre">id:</span> <span class="pre">xxxxxx</span></code>，表示心跳正常。</p>
<p>其次，日志中应该每隔 10 秒滚动 <code class="docutils literal notranslate"><span class="pre">finish</span> <span class="pre">report</span> <span class="pre">task</span> <span class="pre">success.</span> <span class="pre">return</span> <span class="pre">code:</span> <span class="pre">0</span></code> 的字样，表示 BE 向 FE 的通信正常。</p>
<p>同时，如果有数据查询，应该能看到不停滚动的日志，并且有 <code class="docutils literal notranslate"><span class="pre">execute</span> <span class="pre">time</span> <span class="pre">is</span> <span class="pre">xxx</span></code> 日志，表示 BE 启动成功，并且查询正常。</p>
<p>也可以通过如下连接查看是否启动成功：<code class="docutils literal notranslate"><span class="pre">http://be_host:be_http_port/api/health</span></code></p>
<p>如果返回：<code class="docutils literal notranslate"><span class="pre">{&quot;status&quot;:</span> <span class="pre">&quot;OK&quot;,&quot;msg&quot;:</span> <span class="pre">&quot;To</span> <span class="pre">Be</span> <span class="pre">Added&quot;}</span></code></p>
<p>则表示启动成功，其余情况，则可能存在问题。</p>
<blockquote>
<div><p>注：如果在 be.INFO 中查看不到启动失败的信息，也许在 be.out 中可以看到。</p>
</div></blockquote>
</li>
<li><p class="first">搭建系统后，如何确定 FE、BE 连通性正常</p>
<p>首先确认 FE 和 BE 进程都已经单独正常启动，并确认已经通过 <code class="docutils literal notranslate"><span class="pre">ADD</span> <span class="pre">BACKEND</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">ADD</span> <span class="pre">FOLLOWER/OBSERVER</span></code> 语句添加了所有节点。</p>
<p>如果心跳正常，BE 的日志中会显示 <code class="docutils literal notranslate"><span class="pre">get</span> <span class="pre">heartbeat,</span> <span class="pre">host:</span> <span class="pre">xx.xx.xx.xx,</span> <span class="pre">port:</span> <span class="pre">9020,</span> <span class="pre">cluster</span> <span class="pre">id:</span> <span class="pre">xxxxxx</span></code>。如果心跳失败，在 FE 的日志中会出现 <code class="docutils literal notranslate"><span class="pre">backend[10001]</span> <span class="pre">got</span> <span class="pre">Exception:</span> <span class="pre">org.apache.thrift.transport.TTransportException</span></code> 类似的字样，或者其他 thrift 通信异常日志，表示 FE 向 10001 这个 BE 的心跳失败。这里需要检查 FE 向 BE host 的心跳端口的连通性。</p>
<p>如果 BE 向 FE 的通信正常，则 BE 日志中会显示 <code class="docutils literal notranslate"><span class="pre">finish</span> <span class="pre">report</span> <span class="pre">task</span> <span class="pre">success.</span> <span class="pre">return</span> <span class="pre">code:</span> <span class="pre">0</span></code> 的字样。否则会出现 <code class="docutils literal notranslate"><span class="pre">master</span> <span class="pre">client,</span> <span class="pre">get</span> <span class="pre">client</span> <span class="pre">from</span> <span class="pre">cache</span> <span class="pre">failed</span></code> 的字样。这种情况下，需要检查 BE 向 FE 的 rpc_port 的连通性。</p>
</li>
<li><p class="first">Doris 各节点认证机制</p>
<p>除了 Master FE 以外，其余角色节点（Follower FE，Observer FE，Backend），都需要通过 <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">ADD</span></code> 语句先注册到集群，然后才能加入集群。</p>
<p>Master FE 在第一次启动时，会在 palo-meta/image/VERSION 文件中生成一个 cluster_id。</p>
<p>FE 在第一次加入集群时，会首先从 Master FE 获取这个文件。之后每次 FE 之间的重新连接（FE 重启），都会校验自身 cluster id 是否与已存在的其它 FE 的 cluster id 相同。如果不同，则该 FE 会自动退出。</p>
<p>BE 在第一次接收到 Master FE 的心跳时，会从心跳中获取到 cluster id，并记录到数据目录的 <code class="docutils literal notranslate"><span class="pre">cluster_id</span></code> 文件中。之后的每次心跳都会比对 FE 发来的 cluster id。如果 cluster id 不相等，则 BE 会拒绝响应 FE 的心跳。</p>
<p>心跳中同时会包含 Master FE 的 ip。当 FE 切主时，新的 Master FE 会携带自身的 ip 发送心跳给 BE，BE 会更新自身保存的 Master FE 的 ip。</p>
<blockquote>
<div><p><strong>priority_network</strong></p>
<p>priority_network 是 FE 和 BE 都有一个配置，其主要目的是在多网卡的情况下，协助 FE 或 BE 识别自身 ip 地址。priority_network 采用 CIDR 表示法：<a class="reference external" href="https://tools.ietf.org/html/rfc4632">RFC 4632</a></p>
<p>当确认 FE 和 BE 连通性正常后，如果仍然出现建表 Timeout 的情况，并且 FE 的日志中有 <code class="docutils literal notranslate"><span class="pre">backend</span> <span class="pre">does</span> <span class="pre">not</span> <span class="pre">found.</span> <span class="pre">host:</span> <span class="pre">xxx.xxx.xxx.xxx</span></code> 字样的错误信息。则表示 Doris 自动识别的 IP 地址有问题，需要手动设置 priority_network 参数。</p>
<p>出现这个问题的主要原因是：当用户通过 <code class="docutils literal notranslate"><span class="pre">ADD</span> <span class="pre">BACKEND</span></code> 语句添加 BE 后，FE 会识别该语句中指定的是 hostname 还是 IP。如果是 hostname，则 FE 会自动将其转换为 IP 地址并存储到元数据中。当 BE 在汇报任务完成信息时，会携带自己的 IP 地址。而如果 FE 发现 BE 汇报的 IP 地址和元数据中不一致时，就会出现如上错误。</p>
<p>这个错误的解决方法：1）分别在 FE 和 BE 设置 <strong>priority_network</strong> 参数。通常 FE 和 BE 都处于一个网段，所以该参数设置为相同即可。2）在 <code class="docutils literal notranslate"><span class="pre">ADD</span> <span class="pre">BACKEND</span></code> 语句中直接填写 BE 正确的 IP 地址而不是 hostname，以避免 FE 获取到错误的 IP 地址。</p>
</div></blockquote>
</li>
<li><p class="first">BE 进程文件句柄数</p>
<p>BE进程文件句柄数，受min_file_descriptor_number/max_file_descriptor_number两个参数控制。</p>
<p>如果不在[min_file_descriptor_number, max_file_descriptor_number]区间内，BE进程启动会出错，可以使用ulimit进行设置。</p>
<p>min_file_descriptor_number的默认值为65536。</p>
<p>max_file_descriptor_number的默认值为131072.</p>
<p>举例而言：ulimit -n 65536; 表示将文件句柄设成65536。</p>
<p>启动BE进程之后，可以通过 cat /proc/$pid/limits 查看进程实际生效的句柄数</p>
</li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="upgrade.html" class="btn btn-neutral float-right" title="集群升级" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="compilation.html" class="btn btn-neutral float-left" title="编译" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Apache Doris(Incubating)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
<div role="contentinfo">
    <p></p>
    <p>

        Apache Doris(incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.

    </p>
</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>