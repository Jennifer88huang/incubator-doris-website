

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Routine Load &mdash; Doris Documentations 0.11.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Insert Into" href="insert-into-manual.html" />
    <link rel="prev" title="Stream load" href="stream-load-manual.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Doris Documentations
          

          
          </a>

          
            
            
              <div class="version">
                0.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">中文</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../installing/index.html">编译与部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started/index.html">开始使用</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">操作手册</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">数据导入</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="load-manual.html">导入总览</a></li>
<li class="toctree-l4"><a class="reference internal" href="broker-load-manual.html">Broker Load</a></li>
<li class="toctree-l4"><a class="reference internal" href="stream-load-manual.html">Stream load</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Routine Load</a></li>
<li class="toctree-l4"><a class="reference internal" href="insert-into-manual.html">Insert Into</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../alter-table/index.html">表结构变更</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http-actions/index.html">HTTP API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../operation/index.html">运维操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="../backup-restore.html">备份与恢复</a></li>
<li class="toctree-l3"><a class="reference internal" href="../broker.html">Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="../colocation-join.html">Colocation Join</a></li>
<li class="toctree-l3"><a class="reference internal" href="../export-manual.html">数据导出</a></li>
<li class="toctree-l3"><a class="reference internal" href="../privilege.html">权限管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../small-file-mgr.html">文件管理器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../time-zone.html">时区</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../extending-doris/index.html">扩展功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../internal/index.html">设计文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sql-reference/index.html">SQL 手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../community/index.html">Apache 社区</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../en/index.html">English</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Doris Documentations</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">中文</a> &raquo;</li>
        
          <li><a href="../index.html">操作手册</a> &raquo;</li>
        
          <li><a href="index.html">数据导入</a> &raquo;</li>
        
      <li>Routine Load</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/incubator-doris/blob/master/docs/documentation/cn/administrator-guide/load-data/routine-load-manual.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="routine-load">
<h1>Routine Load<a class="headerlink" href="#routine-load" title="Permalink to this headline">¶</a></h1>
<p>例行导入（Routine Load）功能为用户提供了一种自动从指定数据源进行数据导入的功能。</p>
<p>本文档主要介绍该功能的实现原理、使用方式以及最佳实践。</p>
<div class="section" id="id1">
<h2>名词解释<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>FE：Frontend，Doris 的前端节点。负责元数据管理和请求接入。</li>
<li>BE：Backend，Doris 的后端节点。负责查询执行和数据存储。</li>
<li>RoutineLoadJob：用户提交的一个例行导入作业。</li>
<li>JobScheduler：例行导入作业调度器，用于调度和拆分一个 RoutineLoadJob 为多个 Task。</li>
<li>Task：RoutineLoadJob 被 JobScheduler 根据规则拆分的子任务。</li>
<li>TaskScheduler：任务调度器。用于调度 Task 的执行。</li>
</ul>
</div>
<div class="section" id="id2">
<h2>原理<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>         <span class="o">+---------+</span>
         <span class="o">|</span>  <span class="n">Client</span> <span class="o">|</span>
         <span class="o">+----+----+</span>
              <span class="o">|</span>
<span class="o">+-----------------------------+</span>
<span class="o">|</span> <span class="n">FE</span>          <span class="o">|</span>               <span class="o">|</span>
<span class="o">|</span> <span class="o">+-----------</span><span class="n">v</span><span class="o">------------+</span>  <span class="o">|</span>
<span class="o">|</span> <span class="o">|</span>                        <span class="o">|</span>  <span class="o">|</span>
<span class="o">|</span> <span class="o">|</span>   <span class="n">Routine</span> <span class="n">Load</span> <span class="n">Job</span>     <span class="o">|</span>  <span class="o">|</span>
<span class="o">|</span> <span class="o">|</span>                        <span class="o">|</span>  <span class="o">|</span>
<span class="o">|</span> <span class="o">+---+--------+--------+--+</span>  <span class="o">|</span>
<span class="o">|</span>     <span class="o">|</span>        <span class="o">|</span>        <span class="o">|</span>     <span class="o">|</span>
<span class="o">|</span> <span class="o">+---</span><span class="n">v</span><span class="o">--+</span> <span class="o">+---</span><span class="n">v</span><span class="o">--+</span> <span class="o">+---</span><span class="n">v</span><span class="o">--+</span>  <span class="o">|</span>
<span class="o">|</span> <span class="o">|</span> <span class="n">task</span> <span class="o">|</span> <span class="o">|</span> <span class="n">task</span> <span class="o">|</span> <span class="o">|</span> <span class="n">task</span> <span class="o">|</span>  <span class="o">|</span>
<span class="o">|</span> <span class="o">+--+---+</span> <span class="o">+---+--+</span> <span class="o">+---+--+</span>  <span class="o">|</span>
<span class="o">|</span>    <span class="o">|</span>         <span class="o">|</span>        <span class="o">|</span>     <span class="o">|</span>
<span class="o">+-----------------------------+</span>
     <span class="o">|</span>         <span class="o">|</span>        <span class="o">|</span>
     <span class="n">v</span>         <span class="n">v</span>        <span class="n">v</span>
 <span class="o">+---+--+</span>   <span class="o">+--+---+</span>   <span class="o">++-----+</span>
 <span class="o">|</span>  <span class="n">BE</span>  <span class="o">|</span>   <span class="o">|</span>  <span class="n">BE</span>  <span class="o">|</span>   <span class="o">|</span>  <span class="n">BE</span>  <span class="o">|</span>
 <span class="o">+------+</span>   <span class="o">+------+</span>   <span class="o">+------+</span>
</pre></div>
</div>
<p>如上图，Client 向 FE 提交一个例行导入作业。</p>
<p>FE 通过 JobScheduler 将一个导入作业拆分成若干个 Task。每个 Task 负责导入指定的一部分数据。Task 被 TaskScheduler 分配到指定的 BE 上执行。</p>
<p>在 BE 上，一个 Task 被视为一个普通的导入任务，通过 Stream Load 的导入机制进行导入。导入完成后，向 FE 汇报。</p>
<p>FE 中的 JobScheduler 根据汇报结果，继续生成后续新的 Task，或者对失败的 Task 进行重试。</p>
<p>整个例行导入作业通过不断的产生新的 Task，来完成数据不间断的导入。</p>
</div>
<div class="section" id="kafka">
<h2>Kafka 例行导入<a class="headerlink" href="#kafka" title="Permalink to this headline">¶</a></h2>
<p>当前我们仅支持从 Kafka 系统进行例行导入。该部分会详细介绍 Kafka 例行导入使用方式和最佳实践。</p>
<div class="section" id="id3">
<h3>使用限制<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li>支持无认证的 Kafka 访问，以及通过 SSL 方式认证的 Kafka 集群。</li>
<li>支持的消息格式为 csv 文本格式。每一个 message 为一行，且行尾<strong>不包含</strong>换行符。</li>
<li>仅支持 Kafka 0.10.0.0(含) 以上版本。</li>
</ol>
</div>
<div class="section" id="id4">
<h3>创建例行导入任务<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>创建例行导入任务的的详细语法可以连接到 Doris 后，执行 <code class="docutils literal notranslate"><span class="pre">HELP</span> <span class="pre">CREATE</span> <span class="pre">ROUTINE</span> <span class="pre">LOAD;</span></code> 查看语法帮助。这里主要详细介绍，创建作业时的注意事项。</p>
<ul>
<li><p class="first">columns_mapping</p>
<p><code class="docutils literal notranslate"><span class="pre">columns_mapping</span></code> 主要用于指定表结构和 message 中的列映射关系，以及一些列的转换。如果不指定，Doris 会默认 message 中的列和表结构的列按顺序一一对应。虽然在正常情况下，如果源数据正好一一对应，则不指定也可以进行正常的数据导入。但是我们依然强烈建议用户<strong>显式的指定列映射关系</strong>。这样当表结构发生变化（比如增加一个 nullable 的列），或者源文件发生变化（比如增加了一列）时，导入任务依然可以继续进行。否则，当发生上述变动后，因为列映射关系不再一一对应，导入将报错。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">columns_mapping</span></code> 中我们同样可以使用一些内置函数进行列的转换。但需要注意函数参数对应的实际列类型。举例说明：</p>
<p>假设用户需要导入只包含 <code class="docutils literal notranslate"><span class="pre">k1</span></code> 一列的表，列类型为 <code class="docutils literal notranslate"><span class="pre">int</span></code>。并且需要将源文件中的 null 值转换为 0。该功能可以通过 <code class="docutils literal notranslate"><span class="pre">ifnull</span></code> 函数实现。正确是的使用方式如下：</p>
<p><code class="docutils literal notranslate"><span class="pre">COLUMNS</span> <span class="pre">(xx,</span> <span class="pre">k1=ifnull(xx,</span> <span class="pre">&quot;3&quot;))</span></code></p>
<p>注意这里我们使用 <code class="docutils literal notranslate"><span class="pre">&quot;3&quot;</span></code> 而不是 <code class="docutils literal notranslate"><span class="pre">3</span></code>，虽然 <code class="docutils literal notranslate"><span class="pre">k1</span></code> 的类型为 <code class="docutils literal notranslate"><span class="pre">int</span></code>。因为对于导入任务来说，源数据中的列类型都为 <code class="docutils literal notranslate"><span class="pre">varchar</span></code>，所以这里 <code class="docutils literal notranslate"><span class="pre">xx</span></code> 虚拟列的类型也为 <code class="docutils literal notranslate"><span class="pre">varchar</span></code>。所以我们需要使用 <code class="docutils literal notranslate"><span class="pre">&quot;3&quot;</span></code> 来进行对应的匹配，否则 <code class="docutils literal notranslate"><span class="pre">ifnull</span></code> 函数无法找到参数为 <code class="docutils literal notranslate"><span class="pre">(varchar,</span> <span class="pre">int)</span></code> 的函数签名，将出现错误。</p>
<p>再举例，假设用户需要导入只包含 <code class="docutils literal notranslate"><span class="pre">k1</span></code> 一列的表，列类型为 <code class="docutils literal notranslate"><span class="pre">int</span></code>。并且需要将源文件中的对应列进行处理：将负数转换为正数，而将正数乘以 100。这个功能可以通过 <code class="docutils literal notranslate"><span class="pre">case</span> <span class="pre">when</span></code> 函数实现，正确写法应如下：</p>
<p><code class="docutils literal notranslate"><span class="pre">COLUMNS</span> <span class="pre">(xx,</span> <span class="pre">case</span> <span class="pre">when</span> <span class="pre">xx</span> <span class="pre">&lt;</span> <span class="pre">0</span> <span class="pre">than</span> <span class="pre">cast(-xx</span> <span class="pre">as</span> <span class="pre">varchar)</span> <span class="pre">else</span> <span class="pre">cast((xx</span> <span class="pre">+</span> <span class="pre">'100')</span> <span class="pre">as</span> <span class="pre">varchar)</span> <span class="pre">end)</span></code></p>
<p>注意这里我们需要将 <code class="docutils literal notranslate"><span class="pre">case</span> <span class="pre">when</span></code> 中所有的参数都最终转换为 varchar，才能得到期望的结果。</p>
</li>
<li><p class="first">where_predicates</p>
<p><code class="docutils literal notranslate"><span class="pre">where_predicates</span></code> 中的的列的类型，已经是实际的列类型了，所以无需向 <code class="docutils literal notranslate"><span class="pre">columns_mapping</span></code> 那样强制的转换为 varchar 类型。按照实际的列类型书写即可。</p>
</li>
<li><p class="first">desired_concurrent_number</p>
<p><code class="docutils literal notranslate"><span class="pre">desired_concurrent_number</span></code> 用于指定一个例行作业期望的并发度。即一个作业，最多有多少 task 同时在执行。对于 Kafka 导入而言，当前的实际并发度计算如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Min</span><span class="p">(</span><span class="n">partition</span> <span class="n">num</span><span class="p">,</span> <span class="n">desired_concurrent_number</span><span class="p">,</span> <span class="n">alive_backend_num</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">max_routine_load_task_concurrrent_num</span><span class="p">)</span>
</pre></div>
</div>
<p>其中 <code class="docutils literal notranslate"><span class="pre">Config.max_routine_load_task_concurrrent_num</span></code> 是系统的一个默认的最大并发数限制。这是一个 FE 配置，可以通过改配置调整。默认为 5。</p>
<p>其中 partition num 指订阅的 Kafka topic 的 partition 数量。<code class="docutils literal notranslate"><span class="pre">alive_backend_num</span></code> 是当前正常的 BE 节点数。</p>
</li>
<li><p class="first">max_batch_interval/max_batch_rows/max_batch_size</p>
<p>这三个参数用于控制单个任务的执行时间。其中任意一个阈值达到，则任务结束。其中 <code class="docutils literal notranslate"><span class="pre">max_batch_rows</span></code> 用于记录从 Kafka 中读取到的数据行数。<code class="docutils literal notranslate"><span class="pre">max_batch_size</span></code> 用于记录从 Kafka 中读取到的数据量，单位是字节。目前一个任务的消费速率大约为 5-10MB/s。</p>
<p>那么假设一行数据 500B，用户希望每 100MB 或 10 秒为一个 task。100MB 的预期处理时间是 10-20 秒，对应的行数约为 200000 行。则一个合理的配置为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;max_batch_interval&quot;</span> <span class="o">=</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span>
<span class="s2">&quot;max_batch_rows&quot;</span> <span class="o">=</span> <span class="s2">&quot;200000&quot;</span><span class="p">,</span>
<span class="s2">&quot;max_batch_size&quot;</span> <span class="o">=</span> <span class="s2">&quot;104857600&quot;</span>
</pre></div>
</div>
<p>以上示例中的参数也是这些配置的默认参数。</p>
</li>
<li><p class="first">max_error_number</p>
<p><code class="docutils literal notranslate"><span class="pre">max_error_number</span></code> 用于控制错误率。在错误率过高的时候，作业会自动暂停。因为整个作业是面向数据流的，且由于数据流的无边界性，我们无法像其他导入任务一样，通过一个错误比例来计算错误率。因此这里提供了一种新的计算方式，来计算数据流中的错误比例。</p>
<p>我们设定了一个采样窗口。窗口的大小为 <code class="docutils literal notranslate"><span class="pre">max_batch_rows</span> <span class="pre">*</span> <span class="pre">10</span></code>。在一个采样窗口内，如果错误行数超过 <code class="docutils literal notranslate"><span class="pre">max_error_number</span></code>，则作业被暂停。如果没有超过，则下一个窗口重新开始计算错误行数。</p>
<p>我们假设 <code class="docutils literal notranslate"><span class="pre">max_batch_rows</span></code> 为 200000，则窗口大小为 2000000。设 <code class="docutils literal notranslate"><span class="pre">max_error_number</span></code> 为 20000，即用户预期每 2000000 行的错误行为 20000。即错误率为 1%。但是因为不是每批次任务正好消费 200000 行，所以窗口的实际范围是 [2000000, 2200000]，即有 10% 的统计误差。</p>
<p>错误行不包括通过 where 条件过滤掉的行。但是包括没有对应的 Doris 表中的分区的行。</p>
</li>
<li><p class="first">data_source_properties</p>
<p><code class="docutils literal notranslate"><span class="pre">data_source_properties</span></code> 中可以指定消费具体的 Kakfa partition。如果不指定，则默认消费所订阅的 topic 的所有 partition。</p>
<p>注意，当显式的指定了 partition，则导入作业不会再动态的检测 Kafka partition 的变化。如果没有指定，则会根据 kafka partition 的变化，动态调整需要消费的 partition。</p>
</li>
<li><p class="first">strict_mode</p>
<p>Routine load 导入可以开启 strict mode 模式。开启方式为在 job_properties 中增加 <code class="docutils literal notranslate"><span class="pre">&quot;strict_mode&quot;</span> <span class="pre">=</span> <span class="pre">&quot;true&quot;</span></code> 。默认的 strict mode 为开启。</p>
<p>strict mode 模式的意思是：对于导入过程中的列类型转换进行严格过滤。严格过滤的策略如下：</p>
<ol class="simple">
<li>对于列类型转换来说，如果 strict mode 为true，则错误的数据将被 filter。这里的错误数据是指：原始数据并不为空值，在参与列类型转换后结果为空值的这一类数据。</li>
<li>对于导入的某列由函数变换生成时，strict mode 对其不产生影响。</li>
<li>对于导入的某列类型包含范围限制的，如果原始数据能正常通过类型转换，但无法通过范围限制的，strict mode 对其也不产生影响。例如：如果类型是 decimal(1,0), 原始数据为 10，则属于可以通过类型转换但不在列声明的范围内。这种数据 strict 对其不产生影响。</li>
</ol>
</li>
</ul>
<div class="section" id="strict-mode-source-data">
<h4>strict mode 与 source data 的导入关系<a class="headerlink" href="#strict-mode-source-data" title="Permalink to this headline">¶</a></h4>
<p>这里以列类型为 TinyInt 来举例</p>
<blockquote>
<div>注：当表中的列允许导入空值时</div></blockquote>
<table border="1" class="docutils">
<thead>
<tr>
<th>source data</th>
<th>source data example</th>
<th>string to int</th>
<th>strict_mode</th>
<th>result</th>
</tr>
</thead>
<tbody>
<tr>
<td>空值</td>
<td>\N</td>
<td>N/A</td>
<td>true or false</td>
<td>NULL</td>
</tr>
<tr>
<td>not null</td>
<td>aaa or 2000</td>
<td>NULL</td>
<td>true</td>
<td>invalid data(filtered)</td>
</tr>
<tr>
<td>not null</td>
<td>aaa</td>
<td>NULL</td>
<td>false</td>
<td>NULL</td>
</tr>
<tr>
<td>not null</td>
<td>1</td>
<td>1</td>
<td>true or false</td>
<td>correct data</td>
</tr>
</tbody>
</table><p>这里以列类型为 Decimal(1,0) 举例</p>
<blockquote>
<div>注：当表中的列允许导入空值时</div></blockquote>
<table border="1" class="docutils">
<thead>
<tr>
<th>source data</th>
<th>source data example</th>
<th>string to int</th>
<th>strict_mode</th>
<th>result</th>
</tr>
</thead>
<tbody>
<tr>
<td>空值</td>
<td>\N</td>
<td>N/A</td>
<td>true or false</td>
<td>NULL</td>
</tr>
<tr>
<td>not null</td>
<td>aaa</td>
<td>NULL</td>
<td>true</td>
<td>invalid data(filtered)</td>
</tr>
<tr>
<td>not null</td>
<td>aaa</td>
<td>NULL</td>
<td>false</td>
<td>NULL</td>
</tr>
<tr>
<td>not null</td>
<td>1 or 10</td>
<td>1</td>
<td>true or false</td>
<td>correct data</td>
</tr>
</tbody>
</table><blockquote>
<div>注意：10 虽然是一个超过范围的值，但是因为其类型符合 decimal的要求，所以 strict mode对其不产生影响。10 最后会在其他 ETL 处理流程中被过滤。但不会被 strict mode 过滤。</div></blockquote>
</div>
<div class="section" id="ssl-kafka">
<h4>访问 SSL 认证的 Kafka 集群<a class="headerlink" href="#ssl-kafka" title="Permalink to this headline">¶</a></h4>
<p>访问 SSL 认证的 Kafka 集群需要用户提供用于认证 Kafka Broker 公钥的证书文件（ca.pem）。如果 Kafka 集群同时开启了客户端认证，则还需提供客户端的公钥（client.pem）、密钥文件（client.key），以及密钥密码。这里所需的文件需要先通过 <code class="docutils literal notranslate"><span class="pre">CREAE</span> <span class="pre">FILE</span></code> 命令上传到 Doris 中，<strong>并且 catalog 名称为 <code class="docutils literal notranslate"><span class="pre">kafka</span></code></strong>。<code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">FILE</span></code> 命令的具体帮助可以参见 <code class="docutils literal notranslate"><span class="pre">HELP</span> <span class="pre">CREATE</span> <span class="pre">FILE;</span></code>。这里给出示例：</p>
<ol>
<li><p class="first">上传文件</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">FILE</span> <span class="s2">&quot;ca.pem&quot;</span> <span class="n">PROPERTIES</span><span class="p">(</span><span class="s2">&quot;url&quot;</span> <span class="o">=</span> <span class="s2">&quot;https://example_url/kafka-key/ca.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;catalog&quot;</span> <span class="o">=</span> <span class="s2">&quot;kafka&quot;</span><span class="p">);</span>
<span class="n">CREATE</span> <span class="n">FILE</span> <span class="s2">&quot;client.key&quot;</span> <span class="n">PROPERTIES</span><span class="p">(</span><span class="s2">&quot;url&quot;</span> <span class="o">=</span> <span class="s2">&quot;https://example_urlkafka-key/client.key&quot;</span><span class="p">,</span> <span class="s2">&quot;catalog&quot;</span> <span class="o">=</span> <span class="s2">&quot;kafka&quot;</span><span class="p">);</span>
<span class="n">CREATE</span> <span class="n">FILE</span> <span class="s2">&quot;client.pem&quot;</span> <span class="n">PROPERTIES</span><span class="p">(</span><span class="s2">&quot;url&quot;</span> <span class="o">=</span> <span class="s2">&quot;https://example_url/kafka-key/client.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;catalog&quot;</span> <span class="o">=</span> <span class="s2">&quot;kafka&quot;</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p class="first">创建例行导入作业</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">ROUTINE</span> <span class="n">LOAD</span> <span class="n">db1</span><span class="o">.</span><span class="n">job1</span> <span class="n">on</span> <span class="n">tbl1</span>
<span class="n">PROPERTIES</span>
<span class="p">(</span>
    <span class="s2">&quot;desired_concurrent_number&quot;</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>
<span class="p">)</span>
<span class="n">FROM</span> <span class="n">KAFKA</span>
<span class="p">(</span>
    <span class="s2">&quot;kafka_broker_list&quot;</span><span class="o">=</span> <span class="s2">&quot;broker1:9091,broker2:9091&quot;</span><span class="p">,</span>
    <span class="s2">&quot;kafka_topic&quot;</span> <span class="o">=</span> <span class="s2">&quot;my_topic&quot;</span><span class="p">,</span>
    <span class="s2">&quot;property.security.protocol&quot;</span> <span class="o">=</span> <span class="s2">&quot;ssl&quot;</span><span class="p">,</span>
    <span class="s2">&quot;property.ssl.ca.location&quot;</span> <span class="o">=</span> <span class="s2">&quot;FILE:ca.pem&quot;</span><span class="p">,</span>
    <span class="s2">&quot;property.ssl.certificate.location&quot;</span> <span class="o">=</span> <span class="s2">&quot;FILE:client.pem&quot;</span><span class="p">,</span>
    <span class="s2">&quot;property.ssl.key.location&quot;</span> <span class="o">=</span> <span class="s2">&quot;FILE:client.key&quot;</span><span class="p">,</span>
    <span class="s2">&quot;property.ssl.key.password&quot;</span> <span class="o">=</span> <span class="s2">&quot;abcdefg&quot;</span>
<span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div><p>Doris 通过 Kafka 的 C++ API <code class="docutils literal notranslate"><span class="pre">librdkafka</span></code> 来访问 Kafka 集群。<code class="docutils literal notranslate"><span class="pre">librdkafka</span></code> 所支持的参数可以参阅</p>
<p><code class="docutils literal notranslate"><span class="pre">https://github.com/edenhill/librdkafka/blob/master/CONFIGURATION.md</span></code></p>
</div></blockquote>
</div>
</div>
<div class="section" id="id5">
<h3>查看导入作业状态<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>查看<strong>作业</strong>状态的具体命令和示例可以通过 <code class="docutils literal notranslate"><span class="pre">HELP</span> <span class="pre">SHOW</span> <span class="pre">ROUTINE</span> <span class="pre">LOAD;</span></code> 命令查看。</p>
<p>查看<strong>任务</strong>运行状态的具体命令和示例可以通过 <code class="docutils literal notranslate"><span class="pre">HELP</span> <span class="pre">SHOW</span> <span class="pre">ROUTINE</span> <span class="pre">LOAD</span> <span class="pre">TASK;</span></code> 命令查看。</p>
<p>只能查看当前正在运行中的任务，已结束和未开始的任务无法查看。</p>
</div>
<div class="section" id="id6">
<h3>作业控制<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>用户可以通过 <code class="docutils literal notranslate"><span class="pre">STOP/PAUSE/RESUME</span></code> 三个命令来控制作业的停止，暂停和重启。可以通过 <code class="docutils literal notranslate"><span class="pre">HELP</span> <span class="pre">STOP</span> <span class="pre">ROUTINE</span> <span class="pre">LOAD;</span></code>, <code class="docutils literal notranslate"><span class="pre">HELP</span> <span class="pre">PAUSE</span> <span class="pre">ROUTINE</span> <span class="pre">LOAD;</span></code> 以及 <code class="docutils literal notranslate"><span class="pre">HELP</span> <span class="pre">RESUME</span> <span class="pre">ROUTINE</span> <span class="pre">LOAD;</span></code> 三个命令查看帮助和示例。</p>
</div>
</div>
<div class="section" id="id7">
<h2>其他说明<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<ol>
<li><p class="first">例行导入作业和 ALTER TABLE 操作的关系</p>
<ul class="simple">
<li>例行导入不会阻塞 SCHEMA CHANGE 和 ROLLUP 操作。但是注意如果 SCHEMA CHANGE 完成后，列映射关系无法匹配，则会导致作业的错误数据激增，最终导致作业暂停。建议通过在例行导入作业中显式指定列映射关系，以及通过增加 Nullable 列或带 Default 值的列来减少这类问题。</li>
<li>删除表的 Partition 可能会导致导入数据无法找到对应的 Partition，作业进入暂停。</li>
</ul>
</li>
<li><p class="first">例行导入作业和其他导入作业的关系（LOAD, DELETE, INSERT）</p>
<ul class="simple">
<li>例行导入和其他 LOAD 作业以及 INSERT 操作没有冲突。</li>
<li>当执行 DELETE 操作时，对应表分区不能有任何正在执行的导入任务。所以在执行 DELETE 操作前，可能需要先暂停例行导入作业，并等待已下发的 task 全部完成后，才可以执行 DELETE。</li>
</ul>
</li>
<li><p class="first">例行导入作业和 DROP DATABASE/TABLE 操作的关系</p>
<p>当例行导入对应的 database 或 table 被删除后，作业会自动 CANCEL。</p>
</li>
<li><p class="first">kafka 类型的例行导入作业和 kafka topic 的关系</p>
<p>当用户在创建例行导入声明的 <code class="docutils literal notranslate"><span class="pre">kafka_topic</span></code> 在kafka集群中不存在时。</p>
<ul class="simple">
<li>如果用户 kafka 集群的 broker 设置了 <code class="docutils literal notranslate"><span class="pre">auto.create.topics.enable</span> <span class="pre">=</span> <span class="pre">true</span></code>，则 <code class="docutils literal notranslate"><span class="pre">kafka_topic</span></code> 会先被自动创建，自动创建的 partition 个数是由<strong>用户方的kafka集群</strong>中的 broker 配置 <code class="docutils literal notranslate"><span class="pre">num.partitions</span></code> 决定的。例行作业会正常的不断读取该 topic 的数据。</li>
<li>如果用户 kafka 集群的 broker 设置了 <code class="docutils literal notranslate"><span class="pre">auto.create.topics.enable</span> <span class="pre">=</span> <span class="pre">false</span></code>, 则 topic 不会被自动创建，例行作业会在没有读取任何数据之前就被暂停，状态为 <code class="docutils literal notranslate"><span class="pre">PAUSED</span></code>。</li>
</ul>
<p>所以，如果用户希望当 kafka topic 不存在的时候，被例行作业自动创建的话，只需要将<strong>用户方的kafka集群</strong>中的 broker 设置 <code class="docutils literal notranslate"><span class="pre">auto.create.topics.enable</span> <span class="pre">=</span> <span class="pre">true</span></code> 即可。</p>
</li>
</ol>
</div>
<div class="section" id="id8">
<h2>相关参数<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>一些系统配置参数会影响例行导入的使用。</p>
<ol>
<li><p class="first">max_routine_load_task_concurrent_num</p>
<p>FE 配置项，默认为 5，可以运行时修改。该参数限制了一个例行导入最大的子任务并发数。建议维持默认值。设置过大，可能导致同时并发的任务数过多，占用集群资源。</p>
</li>
<li><p class="first">max_consumer_num_per_group</p>
<p>BE 配置项，默认为 3。该参数表示一个子任务中最多生成几个 consumer 进行数据消费。对于 Kafka 数据源，一个 consumer 可能消费一个或多个 kafka partition。假设一个任务需要消费 6 个 kafka partition，则会生成 3 个 consumer，每个 consumer 消费 2 个 partition。如果只有 2 个 partition，则只会生成 2 个 consumer，每个 consumer 消费 1 个 partition。</p>
</li>
<li><p class="first">push_write_mbytes_per_sec</p>
<p>BE 配置项。默认为 10，即 10MB/s。该参数为导入通用参数，不限于例行导入作业。该参数限制了导入数据写入磁盘的速度。对于 SSD 等高性能存储设备，可以适当增加这个限速。</p>
</li>
<li><p class="first">max_concurrent_task_num_per_be</p>
<p>FE 配置项，默认为10，可以运行时修改。该参数限制了每个 BE 节点最多并发执行的子任务个数。建议维持默认值。如果设置过大，可能导致并发任务数过多，占用集群资源。</p>
<ul class="simple">
<li>如果用户发现许多 Routine load job 都处在 NEED_SCHEDULER 的状态，则说明整个集群的子任务并发数饱和了。</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">整个集群的子任务的并发数</span> <span class="pre">=</span> <span class="pre">BE</span> <span class="pre">的个数</span> <span class="pre">*</span> <span class="pre">max_concurrent_task_num_per_be</span></code> 这种情况下，首先确定是否所有 RUNNING 中的 job 可以被精简，比如暂停或停止掉已经无用的 job。其次，可以考虑修改这个参数，用于扩大整个集群的子任务并发数。</p>
</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="insert-into-manual.html" class="btn btn-neutral float-right" title="Insert Into" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="stream-load-manual.html" class="btn btn-neutral float-left" title="Stream load" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Apache Doris(Incubating)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
<div role="contentinfo">
    <p></p>
    <p>

        Apache Doris is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the name of Apache TLP sponsor. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.

    </p>
</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>