

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Doris Segment V2上线和试用手册 &mdash; Doris Documentations 0.11.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="文件管理器" href="small-file-mgr.html" />
    <link rel="prev" title="权限管理" href="privilege.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Doris Documentations
          

          
          </a>

          
            
            
              <div class="version">
                0.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">中文</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../downloads/index.html">下载</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installing/index.html">编译与部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/index.html">开始使用</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">操作手册</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="load-data/index.html">数据导入</a></li>
<li class="toctree-l3"><a class="reference internal" href="alter-table/index.html">表结构变更</a></li>
<li class="toctree-l3"><a class="reference internal" href="materialized-view/index.html">物化视图</a></li>
<li class="toctree-l3"><a class="reference internal" href="http-actions/index.html">HTTP API</a></li>
<li class="toctree-l3"><a class="reference internal" href="operation/index.html">运维操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="config/index.html">配置文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="backup-restore.html">备份与恢复</a></li>
<li class="toctree-l3"><a class="reference internal" href="broker.html">Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="colocation-join.html">Colocation Join</a></li>
<li class="toctree-l3"><a class="reference internal" href="dynamic-partition.html">动态分区</a></li>
<li class="toctree-l3"><a class="reference internal" href="export-manual.html">数据导出</a></li>
<li class="toctree-l3"><a class="reference internal" href="privilege.html">权限管理</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Doris Segment V2上线和试用手册</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">背景</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">上线</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="small-file-mgr.html">文件管理器</a></li>
<li class="toctree-l3"><a class="reference internal" href="sql-mode.html">SQL MODE</a></li>
<li class="toctree-l3"><a class="reference internal" href="time-zone.html">时区</a></li>
<li class="toctree-l3"><a class="reference internal" href="variables.html">变量</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../extending-doris/index.html">扩展功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal/index.html">设计文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sql-reference/index.html">SQL 手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer-guide/index.html">开发者手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../community/index.html">Apache 社区</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../en/index.html">English</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Doris Documentations</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">中文</a> &raquo;</li>
        
          <li><a href="index.html">操作手册</a> &raquo;</li>
        
      <li>Doris Segment V2上线和试用手册</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/incubator-doris/blob/master/docs/documentation/cn/administrator-guide/segment-v2-usage.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="doris-segment-v2">
<h1>Doris Segment V2上线和试用手册<a class="headerlink" href="#doris-segment-v2" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>背景<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Doris 0.12版本中实现了segment v2（新的存储格式），引入词典压缩、bitmap索引、page cache等优化，能够提升系统性能。目前0.12版本已经发布alpha版本，正在内部上线过程中，上线的方案和试用方法记录如下</p>
</div>
<div class="section" id="id2">
<h2>上线<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>为了保证上线的稳定性，上线分为三个阶段：
第一个阶段是上线0.12版本，但是不全量开启segment v2的功能，只在验证的时候，创建segment v2的表（或者索引）
第二个阶段是全量开启segment v2的功能，替换现有的segment存储格式，这样对新表会创建segment v2的格式的存储文件，但是对于旧表，需要依赖于compaction和schema change等过程，实现格式的转化
第三个阶段就是转化旧的segment格式到新的segment v2的格式，这个需要在验证segment v2的正确性和性能没有问题之后，可以按照用户意愿逐步完成。</p>
<div class="section" id="id3">
<h3>上线验证<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>正确性</li>
</ul>
<p>正确性是segment v2上线最需要保证的指标。 在第一阶段，为了保证线上环境的稳定性，并且验证segment v2的正确性，采用如下的方案：</p>
<ol>
<li><p class="first">选择几个需要验证的表，使用以下语句，创建segment v2格式的rollup表，该rollup表与base表的schema相同</p>
<p>alter table table_name add rollup table_name (columns) properties (“storage_format” = “v2”);</p>
<p>其中，
rollup后面的index名字直接指定为base table的table name，该语句会自动生成一个__v2_table_name。</p>
<p>columns可以随便指定一个列名即可，这里一方面是为了兼容现有的语法，一方面是为了方便。</p>
</li>
<li><p class="first">上面的创建出来的rollup index名字格式类似：__v2_table_name</p>
<p>通过命令 :</p>
<p><code class="docutils literal notranslate"><span class="pre">desc</span> <span class="pre">table_name</span> <span class="pre">all;</span></code></p>
<p>查看table中是否存在名字：__v2_table_name的rollup。由于创建segment v2的rollup表是一个异步操作，所以并不会立即成功。如果上面命令中并没有显示新创建的 rollup，可能是还在创建过程中。</p>
<p>可以通过下面命令查看正在进行的 rollup 表。</p>
<p><code class="docutils literal notranslate"><span class="pre">show</span> <span class="pre">alter</span> <span class="pre">table</span> <span class="pre">rollup;</span></code></p>
<p>看到会有一个名字为__v2_table_name的rollup表正在创建。</p>
</li>
<li><p class="first">通过查询base表和segment v2格式的rollup表，验证查询结果是否一致（查询可以来自audit日志）</p>
<p>为了让查询使用segment v2的rollup表，增加了一个session变量，通过在查询中使用如下的语句，来查询segment v2格式的index：</p>
<p>set use_v2_rollup = true;</p>
<p>比如说，要当前db中有一个simple的表，直接查询如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>	<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">simple</span><span class="p">;</span>         
	<span class="o">+------+-------+</span>
	<span class="o">|</span> <span class="n">key</span>  <span class="o">|</span> <span class="n">value</span> <span class="o">|</span>
	<span class="o">+------+-------+</span>
	<span class="o">|</span>    <span class="mi">2</span> <span class="o">|</span>     <span class="mi">6</span> <span class="o">|</span>
	<span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>     <span class="mi">6</span> <span class="o">|</span>
	<span class="o">|</span>    <span class="mi">4</span> <span class="o">|</span>     <span class="mi">5</span> <span class="o">|</span>
	<span class="o">+------+-------+</span>
	<span class="mi">3</span> <span class="n">rows</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
<p>然后使用使用如下的query查询__v2_simpel的rollup表：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>	<span class="n">mysql</span><span class="o">&gt;</span> <span class="nb">set</span> <span class="n">use_v2_rollup</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
	<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.04</span> <span class="n">sec</span><span class="p">)</span>

	<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">simple</span><span class="p">;</span>
	<span class="o">+------+-------+</span>	
	<span class="o">|</span> <span class="n">key</span>  <span class="o">|</span> <span class="n">value</span> <span class="o">|</span>
	<span class="o">+------+-------+</span>
	<span class="o">|</span>    <span class="mi">4</span> <span class="o">|</span>     <span class="mi">5</span> <span class="o">|</span>
	<span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>     <span class="mi">6</span> <span class="o">|</span>
	<span class="o">|</span>    <span class="mi">2</span> <span class="o">|</span>     <span class="mi">6</span> <span class="o">|</span>
	<span class="o">+------+-------+</span>
	<span class="mi">3</span> <span class="n">rows</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
<p>期望的结果是两次查询的结果相同。
如果结果不一致，需要进行排查。第一步需要定位是否是因为由于两次查询之间有新的导入，导致数据不一致。如果是的话，需要进行重试。如果不是，则需要进一步定位原因。</p>
</li>
<li><p class="first">对比同样查询在base表和segment v2的rollup表中的结果是否一致</p>
</li>
</ol>
<ul>
<li><p class="first">查询延时</p>
<p>在segment v2中优化了v1中的随机读取，并且增加了bitmap索引、lazy materialization等优化，预计查询延时会有下降，</p>
</li>
<li><p class="first">导入延时</p>
</li>
<li><p class="first">page cache命中率</p>
</li>
<li><p class="first">string类型字段压缩率</p>
</li>
<li><p class="first">bitmap索引的性能提升率和空间占用</p>
</li>
</ul>
</div>
<div class="section" id="segment-v2">
<h3>全量开启segment v2<a class="headerlink" href="#segment-v2" title="Permalink to this headline">¶</a></h3>
<p>有两个方式：</p>
<ol>
<li><p class="first">fe中有一个全局变量，通过设置全局变量default_rowset_type，来设置BE中使用segment v2作为默认的存储格式，命令如下：</p>
<p>set global default_rowset_type = beta;</p>
<p>使用这个方式，只需要执行上述命令，之后等待10s左右，FE会将配置同步到BE中。不需要在每个BE中进行配置。推荐使用这个配置。不过该方式目前没有简单的方式来验证BE上的default rowset type是否已经变更，一种办法是建一个表，然后查看对应的表的元数据。但是这样子比较麻烦，后续看需要可以在某个地方实现状态查看。</p>
</li>
<li><p class="first">修改BE中的配置文件中的配置default_rowset_type为BETA。这种方式需要在每个BE中添加对应的配置。</p>
</li>
</ol>
</div>
<div class="section" id="segment-v1v2">
<h3>转化segment v1格式为v2<a class="headerlink" href="#segment-v1v2" title="Permalink to this headline">¶</a></h3>
<p>如果不想等待系统后台自动转换存储格式（比如想要使用bitmap索引、词典压缩），可以手动指定触发某个表的存储格式转换。具体是通过schema change来实现将v1的格式转化为v2的格式：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alter</span> <span class="n">table</span> <span class="n">table_name</span> <span class="nb">set</span> <span class="p">(</span><span class="s2">&quot;storage_format&quot;</span> <span class="o">=</span> <span class="s2">&quot;v2&quot;</span><span class="p">);</span>

<span class="n">将存储格式转化为v2</span><span class="o">.</span>
</pre></div>
</div>
<p>如果在没有设置默认的存储格式为v2的时候，想要新建一个v2的表，需要按照以下的步骤进行操作：</p>
<ol class="simple">
<li>使用create table来创建v1的表</li>
<li>使用上面的schema change命令进行格式的转化</li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="small-file-mgr.html" class="btn btn-neutral float-right" title="文件管理器" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="privilege.html" class="btn btn-neutral float-left" title="权限管理" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Apache Doris(Incubating)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
<div role="contentinfo">
    <p></p>
    <p>

        Apache Doris(incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.

    </p>
</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>