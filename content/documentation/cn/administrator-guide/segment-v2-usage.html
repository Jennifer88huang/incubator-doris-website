

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Segment V2 升级手册 &mdash; Doris Documentations 0.11.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="文件管理器" href="small-file-mgr.html" />
    <link rel="prev" title="权限管理" href="privilege.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Doris Documentations
          

          
          </a>

          
            
            
              <div class="version">
                0.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">中文</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../downloads/index.html">下载</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installing/index.html">编译与部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/index.html">开始使用</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">操作手册</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="load-data/index.html">数据导入</a></li>
<li class="toctree-l3"><a class="reference internal" href="alter-table/index.html">表结构变更</a></li>
<li class="toctree-l3"><a class="reference internal" href="materialized-view/index.html">物化视图</a></li>
<li class="toctree-l3"><a class="reference internal" href="http-actions/index.html">HTTP API</a></li>
<li class="toctree-l3"><a class="reference internal" href="operation/index.html">运维操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="config/index.html">配置文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="backup-restore.html">备份与恢复</a></li>
<li class="toctree-l3"><a class="reference internal" href="broker.html">Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="colocation-join.html">Colocation Join</a></li>
<li class="toctree-l3"><a class="reference internal" href="dynamic-partition.html">动态分区</a></li>
<li class="toctree-l3"><a class="reference internal" href="export-manual.html">数据导出</a></li>
<li class="toctree-l3"><a class="reference internal" href="privilege.html">权限管理</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Segment V2 升级手册</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">背景</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">集群升级</a></li>
<li class="toctree-l4"><a class="reference internal" href="#v2">V2 格式转换</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="small-file-mgr.html">文件管理器</a></li>
<li class="toctree-l3"><a class="reference internal" href="sql-mode.html">SQL MODE</a></li>
<li class="toctree-l3"><a class="reference internal" href="time-zone.html">时区</a></li>
<li class="toctree-l3"><a class="reference internal" href="variables.html">变量</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../extending-doris/index.html">扩展功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal/index.html">设计文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sql-reference/index.html">SQL 手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer-guide/index.html">开发者手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../community/index.html">Apache 社区</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../en/index.html">English</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Doris Documentations</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">中文</a> &raquo;</li>
        
          <li><a href="index.html">操作手册</a> &raquo;</li>
        
      <li>Segment V2 升级手册</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/incubator-doris/blob/master/docs/documentation/cn/administrator-guide/segment-v2-usage.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <!-- 
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
--><div class="section" id="segment-v2">
<h1>Segment V2 升级手册<a class="headerlink" href="#segment-v2" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>背景<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Doris 0.12 版本中实现了新的存储格式：Segment V2，引入词典压缩、bitmap索引、page cache等优化，能够提升系统性能。</p>
<p>0.12 版本会同时支持读写原有的 Segment V1（以下简称V1） 和新的 Segment V2（以下简称V2） 两种格式。如果原有数据想使用 V2 相关特性，需通过命令将 V1 转换成 V2 格式。</p>
<p>本文档主要介绍从 0.11 版本升级至 0.12 版本后，如何转换和使用 V2 格式。</p>
<p>V2 格式的表可以支持以下新的特性：</p>
<ol class="simple">
<li>bitmap 索引</li>
<li>内存表</li>
<li>page cache</li>
<li>字典压缩</li>
<li>延迟物化（Lazy Materialization）</li>
</ol>
</div>
<div class="section" id="id2">
<h2>集群升级<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>0.12 版本仅支持从 0.11 版本升级，不支持从 0.11 之前的版本升级。请先确保升级的前的 Doris 集群版本为 0.11。</p>
<p>0.12 版本有两个 V2 相关的重要参数：</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">default_rowset_type</span></code>：FE 一个全局变量（Global Variable）设置，默认为 “alpha”，即 V1 版本。</li>
<li><code class="docutils literal notranslate"><span class="pre">default_rowset_type</span></code>：BE 的一个配置项，默认为 “ALPHA”，即 V1 版本。</li>
</ul>
<p>保持上述配置默认的话，按常规步骤对集群升级后，原有集群数据的存储格式不会变更，即依然为 V1 格式。如果对 V2 格式没有需求，则继续正常使用集群即可，无需做任何额外操作。所有原有数据、以及新导入的数据，都依然是 V1 版本。</p>
</div>
<div class="section" id="v2">
<h2>V2 格式转换<a class="headerlink" href="#v2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3>已有表数据转换成 V2<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>对于已有表数据的格式转换，Doris 提供两种方式：</p>
<ol>
<li><p class="first">创建一个 V2 格式的特殊 Rollup</p>
<p>该方式会针对指定表，创建一个 V2 格式的特殊 Rollup。创建完成后，新的 V2 格式的 Rollup 会和原有表格式数据并存。用户可以指定对 V2 格式的 Rollup 进行查询验证。</p>
<p>该方式主要用于对 V2 格式的验证，因为不会修改原有表数据，因此可以安全的进行 V2 格式的数据验证，而不用担心表数据因格式转换而损坏。通常先使用这个方式对数据进行校验，之后再使用方法2对整个表进行数据格式转换。</p>
<p>操作步骤如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## 创建 V2 格式的 Rollup</span>

<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">table_name</span> <span class="n">ADD</span> <span class="n">ROLLUP</span> <span class="n">table_name</span> <span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="n">PROPERTIES</span> <span class="p">(</span><span class="s2">&quot;storage_format&quot;</span> <span class="o">=</span> <span class="s2">&quot;v2&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>其中， Rollup 的名称必须为表名。columns 字段可以任意填写，系统不会检查该字段的合法性。该语句会自动生成一个名为 <code class="docutils literal notranslate"><span class="pre">__V2_table_name</span></code> 的 Rollup，并且该 Rollup 列包含表的全部列。</p>
<p>通过以下语句查看创建进度：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SHOW</span> <span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">ROLLUP</span><span class="p">;</span>
</pre></div>
</div>
<p>创建完成后，可以通过 <code class="docutils literal notranslate"><span class="pre">DESC</span> <span class="pre">table_name</span> <span class="pre">ALL;</span></code> 查看到名为 <code class="docutils literal notranslate"><span class="pre">__v2_table_name</span></code> 的 Rollup。</p>
<p>之后，通过如下命令，切换到 V2 格式查询：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">use_v2_rollup</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
<span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">table_name</span> <span class="n">limit</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">use_V2_Rollup</span></code> 这个变量会强制查询名为 <code class="docutils literal notranslate"><span class="pre">__V2_table_name</span></code> 的 Rollup，并且不会考虑其他 Rollup 的命中条件。所以该参数仅用于对 V2 格式数据进行验证。</p>
</li>
<li><p class="first">转换现有表数据格式</p>
<p>该方式相当于给指定的表发送一个 schema change 作业，作业完成后，表的所有数据会被转换成 V2 格式。该方法不会保留原有 v1 格式，所以请先使用方法1进行格式验证。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">table_name</span> <span class="n">SET</span> <span class="p">(</span><span class="s2">&quot;storage_format&quot;</span> <span class="o">=</span> <span class="s2">&quot;v2&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>之后通过如下命令查看作业进度：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SHOW</span> <span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">COLUMN</span><span class="p">;</span>
</pre></div>
</div>
<p>作业完成后，该表的所有数据（包括Rollup）都转换为了 V2。且 V1 版本的数据已被删除。如果该表是分区表，则之后创建的分区也都是 V2 格式。</p>
<p><strong>V2 格式的表不能重新转换为 V1</strong></p>
</li>
</ol>
</div>
<div class="section" id="id4">
<h3>创建新的 V2 格式的表<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>在不改变默认配置参数的情况下，用户可以创建 V2 格式的表：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">tbl_name</span>
<span class="p">(</span>
    <span class="n">k1</span> <span class="n">INT</span><span class="p">,</span>
    <span class="n">k2</span> <span class="n">INT</span>
<span class="p">)</span>
<span class="n">DISTRIBUTED</span> <span class="n">BY</span> <span class="n">HASH</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span> <span class="n">BUCKETS</span> <span class="mi">1</span>
<span class="n">PROPERTIES</span>
<span class="p">(</span>
    <span class="s2">&quot;storage_format&quot;</span> <span class="o">=</span> <span class="s2">&quot;v2&quot;</span>
<span class="p">);</span>
</pre></div>
</div>
<p>在 <code class="docutils literal notranslate"><span class="pre">properties</span></code> 中指定 <code class="docutils literal notranslate"><span class="pre">&quot;storage_format&quot;</span> <span class="pre">=</span> <span class="pre">&quot;v2&quot;</span></code> 后，该表将使用 V2 格式创建。如果是分区表，则之后创建的分区也都是 V2 格式。</p>
</div>
<div class="section" id="id5">
<h3>全量格式转换(试验功能)<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>通过以下方式可以开启整个集群的全量数据格式转换（V1 -&gt; V2）。全量数据转换是通过 BE 后台的数据 compaction 过程异步进行的。</p>
<ol>
<li><p class="first">从 BE 开启全量格式转换</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">be.conf</span></code> 中添加变量 <code class="docutils literal notranslate"><span class="pre">default_rowset_type=BETA</span></code> 并重启 BE 节点。在之后的 compaction 流程中，数据会自动从 V1 转换成 V2。</p>
</li>
<li><p class="first">从 FE 开启全量格式转换</p>
<p>通过 mysql 客户端连接 Doris 后，执行如下语句：</p>
<p><code class="docutils literal notranslate"><span class="pre">SET</span> <span class="pre">GLOBAL</span> <span class="pre">default_rowset_type</span> <span class="pre">=</span> <span class="pre">beta;</span></code></p>
<p>执行完成后，FE 会通过心跳将信息发送给 BE，之后 BE 的 compaction 流程中，数据会自动从 V1 转换成 V2。</p>
<p>FE 的配置参数优先级高于 BE 的配置。即使 BE 中的配置 <code class="docutils literal notranslate"><span class="pre">default_rowset_type</span></code> 为 ALPHA，如果 FE 配置为 beta 后，则 BE 依然开始进行 V1 到 V2 的数据格式转换。</p>
<p>**建议先通过对单独表的数据格式转换验证后，再进行全量转换。全量转换的时间比较长，且进度依赖于 compaction 的进度。**可能出现 compaction 无法完成的情况，因此需要通过显式的执行 <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span></code> 操作进行个别表的数据格式转换。</p>
</li>
<li><p class="first">查看全量转换进度</p>
<p>全量转换进度须通过脚本查看。脚本位置为代码库的 <code class="docutils literal notranslate"><span class="pre">tools/show_segment_status/</span></code> 目录。请参阅其中的 <code class="docutils literal notranslate"><span class="pre">README</span></code> 文档查看使用帮助。</p>
</li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="small-file-mgr.html" class="btn btn-neutral float-right" title="文件管理器" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="privilege.html" class="btn btn-neutral float-left" title="权限管理" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Apache Doris(Incubating)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
<div role="contentinfo">
    <p></p>
    <p>

        Apache Doris(incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.

    </p>
</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>