

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>动态分区 &mdash; Doris Documentations 0.11.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="数据导出" href="export-manual.html" />
    <link rel="prev" title="Colocation Join" href="colocation-join.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Doris Documentations
          

          
          </a>

          
            
            
              <div class="version">
                0.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">中文</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../downloads/index.html">下载</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installing/index.html">编译与部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/index.html">开始使用</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">操作手册</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="load-data/index.html">数据导入</a></li>
<li class="toctree-l3"><a class="reference internal" href="alter-table/index.html">表结构变更</a></li>
<li class="toctree-l3"><a class="reference internal" href="http-actions/index.html">HTTP API</a></li>
<li class="toctree-l3"><a class="reference internal" href="operation/index.html">运维操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="config/index.html">配置文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="backup-restore.html">备份与恢复</a></li>
<li class="toctree-l3"><a class="reference internal" href="broker.html">Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="colocation-join.html">Colocation Join</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">动态分区</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">名词解释</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">原理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">使用方式</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">高级操作</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="export-manual.html">数据导出</a></li>
<li class="toctree-l3"><a class="reference internal" href="privilege.html">权限管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="small-file-mgr.html">文件管理器</a></li>
<li class="toctree-l3"><a class="reference internal" href="sql-mode.html">SQL MODE</a></li>
<li class="toctree-l3"><a class="reference internal" href="time-zone.html">时区</a></li>
<li class="toctree-l3"><a class="reference internal" href="variables.html">变量</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../extending-doris/index.html">扩展功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal/index.html">设计文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sql-reference/index.html">SQL 手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer-guide/index.html">开发者手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../community/index.html">Apache 社区</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../en/index.html">English</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Doris Documentations</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">中文</a> &raquo;</li>
        
          <li><a href="index.html">操作手册</a> &raquo;</li>
        
      <li>动态分区</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/incubator-doris/blob/master/docs/documentation/cn/administrator-guide/dynamic-partition.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <!-- 
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
--><div class="section" id="id1">
<h1>动态分区<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>动态分区是在 Doris 0.12 版本中引入的新功能。旨在对表级别的分区实现生命周期管理(TTL)，减少用户的使用负担。</p>
<p>最初的设计、实现和效果可以参阅 <a class="reference external" href="https://github.com/apache/incubator-doris/issues/2262">ISSUE 2262</a>。</p>
<p>目前实现了动态添加分区的功能，下一个版本会支持动态删除分区的功能。</p>
<div class="section" id="id2">
<h2>名词解释<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>FE：Frontend，Doris 的前端节点。负责元数据管理和请求接入。</li>
<li>BE：Backend，Doris 的后端节点。负责查询执行和数据存储。</li>
</ul>
</div>
<div class="section" id="id3">
<h2>原理<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>在某些使用场景下，用户会将表按照天进行分区划分，每天定时执行例行任务，这时需要使用方手动管理分区，否则可能由于使用方没有创建分区导致数据导入失败，这给使用方带来了额外的维护成本。</p>
<p>在实现方式上, FE会启动一个后台线程，根据fe.conf中<code class="docutils literal notranslate"><span class="pre">dynamic_partition_enable</span></code> 及 <code class="docutils literal notranslate"><span class="pre">dynamic_partition_check_interval_seconds</span></code>参数决定该线程是否启动以及该线程的调度频率.</p>
<p>建表时，在properties中指定dynamic_partition属性，FE首先对动态分区属性进行解析，校验输入参数的合法性，然后将对应的属性持久化到FE的元数据中，并将该表注册到动态分区列表中，后台线程会根据配置参数定期对动态分区列表进行扫描，读取表的动态分区属性，执行添加分区的任务，每次的调度信息会保留在FE的内存中，可以通过<code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">DYNAMIC</span> <span class="pre">PARTITION</span> <span class="pre">TABLES</span></code>查看调度任务是否成功，如果存在分区创建失败，会将失败信息输出。</p>
</div>
<div class="section" id="id4">
<h2>使用方式<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id5">
<h3>建表<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>建表时，可以在 <code class="docutils literal notranslate"><span class="pre">PROPERTIES</span></code> 中指定以下<code class="docutils literal notranslate"><span class="pre">dynamic_partition</span></code>属性，表示这个表是一个动态分区表。</p>
<p>示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">example_db</span><span class="o">.</span><span class="n">dynamic_partition</span>
<span class="p">(</span>
<span class="n">k1</span> <span class="n">DATE</span><span class="p">,</span>
<span class="n">k2</span> <span class="n">INT</span><span class="p">,</span>
<span class="n">k3</span> <span class="n">SMALLINT</span><span class="p">,</span>
<span class="n">v1</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">2048</span><span class="p">),</span>
<span class="n">v2</span> <span class="n">DATETIME</span> <span class="n">DEFAULT</span> <span class="s2">&quot;2014-02-04 15:36:00&quot;</span>
<span class="p">)</span>
<span class="n">ENGINE</span><span class="o">=</span><span class="n">olap</span>
<span class="n">DUPLICATE</span> <span class="n">KEY</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">)</span>
<span class="n">PARTITION</span> <span class="n">BY</span> <span class="n">RANGE</span> <span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="p">(</span>
<span class="n">PARTITION</span> <span class="n">p1</span> <span class="n">VALUES</span> <span class="n">LESS</span> <span class="n">THAN</span> <span class="p">(</span><span class="s2">&quot;2014-01-01&quot;</span><span class="p">),</span>
<span class="n">PARTITION</span> <span class="n">p2</span> <span class="n">VALUES</span> <span class="n">LESS</span> <span class="n">THAN</span> <span class="p">(</span><span class="s2">&quot;2014-06-01&quot;</span><span class="p">),</span>
<span class="n">PARTITION</span> <span class="n">p3</span> <span class="n">VALUES</span> <span class="n">LESS</span> <span class="n">THAN</span> <span class="p">(</span><span class="s2">&quot;2014-12-01&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">DISTRIBUTED</span> <span class="n">BY</span> <span class="n">HASH</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span> <span class="n">BUCKETS</span> <span class="mi">32</span>
<span class="n">PROPERTIES</span><span class="p">(</span>
<span class="s2">&quot;storage_medium&quot;</span> <span class="o">=</span> <span class="s2">&quot;SSD&quot;</span><span class="p">,</span>
<span class="s2">&quot;dynamic_partition.enable&quot;</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
<span class="s2">&quot;dynamic_partition.time_unit&quot;</span> <span class="o">=</span> <span class="s2">&quot;DAY&quot;</span><span class="p">,</span>
<span class="s2">&quot;dynamic_partition.end&quot;</span> <span class="o">=</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
<span class="s2">&quot;dynamic_partition.prefix&quot;</span> <span class="o">=</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span>
<span class="s2">&quot;dynamic_partition.buckets&quot;</span> <span class="o">=</span> <span class="s2">&quot;32&quot;</span>
 <span class="p">);</span>
</pre></div>
</div>
<p>创建一张动态分区表，指定开启动态分区特性，以当天为2020-01-08为例，在每次调度时，会提前创建今天以及以后3天的4个分区(若分区已存在则会忽略)，分区名根据指定前缀分别为<code class="docutils literal notranslate"><span class="pre">p20200108</span></code> <code class="docutils literal notranslate"><span class="pre">p20200109</span></code> <code class="docutils literal notranslate"><span class="pre">p20200110</span></code> <code class="docutils literal notranslate"><span class="pre">p20200111</span></code>,每个分区的分桶数量为32，每个分区的范围如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[types: [DATE]; keys: [2020-01-08]; ‥types: [DATE]; keys: [2020-01-09]; )
[types: [DATE]; keys: [2020-01-09]; ‥types: [DATE]; keys: [2020-01-10]; )
[types: [DATE]; keys: [2020-01-10]; ‥types: [DATE]; keys: [2020-01-11]; )
[types: [DATE]; keys: [2020-01-11]; ‥types: [DATE]; keys: [2020-01-12]; )
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>开启动态分区功能<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li>首先需要在fe.conf中设置<code class="docutils literal notranslate"><span class="pre">dynamic_partition_enable=true</span></code>，可以在集群启动时通过修改配置文件指定，也可以在运行时通过http接口动态修改,修改方法查看高级操作部分</li>
<li>如果需要对0.12版本之前的表添加动态分区属性，则需要通过以下命令修改表的属性</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">dynamic_partition</span> <span class="nb">set</span> <span class="p">(</span><span class="s2">&quot;dynamic_partition.enable&quot;</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;dynamic_partition.time_unit&quot;</span> <span class="o">=</span> <span class="s2">&quot;DAY&quot;</span><span class="p">,</span> <span class="s2">&quot;dynamic_partition.end&quot;</span> <span class="o">=</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;dynamic_partition.prefix&quot;</span> <span class="o">=</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;dynamic_partition.buckets&quot;</span> <span class="o">=</span> <span class="s2">&quot;32&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>停止动态分区功能<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>如果需要对集群中所有动态分区表停止动态分区功能，则需要在fe.conf中设置<code class="docutils literal notranslate"><span class="pre">dynamic_partition_enable=false</span></code></p>
<p>如果需要对指定表停止动态分区功能，则可以通过以下命令修改表的属性</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">dynamic_partition</span> <span class="nb">set</span> <span class="p">(</span><span class="s2">&quot;dynamic_partition.enable&quot;</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h3>修改动态分区属性<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>通过如下命令可以修改动态分区的属性</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">dynamic_partition</span> <span class="nb">set</span><span class="p">(</span><span class="s2">&quot;key&quot;</span> <span class="o">=</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h3>查看动态分区表调度情况<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>通过以下命令可以进一步查看动态分区表的调度情况：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SHOW</span> <span class="n">DYNAMIC</span> <span class="n">PARTITION</span> <span class="n">TABLES</span><span class="p">;</span>

<span class="o">+-------------------+--------+----------+------+--------+---------+---------------------+---------------------+--------+------+</span>
<span class="o">|</span> <span class="n">TableName</span>         <span class="o">|</span> <span class="n">Enable</span> <span class="o">|</span> <span class="n">TimeUnit</span> <span class="o">|</span> <span class="n">End</span>  <span class="o">|</span> <span class="n">Prefix</span> <span class="o">|</span> <span class="n">Buckets</span> <span class="o">|</span> <span class="n">LastUpdateTime</span>      <span class="o">|</span> <span class="n">LastSchedulerTime</span>   <span class="o">|</span> <span class="n">State</span>  <span class="o">|</span> <span class="n">Msg</span>  <span class="o">|</span>
<span class="o">+-------------------+--------+----------+------+--------+---------+---------------------+---------------------+--------+------+</span>
<span class="o">|</span> <span class="n">dynamic_partition</span> <span class="o">|</span> <span class="n">true</span>   <span class="o">|</span> <span class="n">DAY</span>      <span class="o">|</span> <span class="mi">3</span>    <span class="o">|</span> <span class="n">p</span>      <span class="o">|</span> <span class="mi">32</span>      <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span> <span class="mi">20</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mi">09</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span> <span class="mi">20</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mi">34</span> <span class="o">|</span> <span class="n">NORMAL</span> <span class="o">|</span> <span class="n">N</span><span class="o">/</span><span class="n">A</span>  <span class="o">|</span>
<span class="o">+-------------------+--------+----------+------+--------+---------+---------------------+---------------------+--------+------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>LastUpdateTime: 最后一次修改动态分区属性的时间</li>
<li>LastSchedulerTime:   最后一次执行动态分区调度的时间</li>
<li>State:    最后一次执行动态分区调度的状态</li>
<li>Msg:  最后一次执行动态分区调度的错误信息</li>
</ul>
</div>
</div>
<div class="section" id="id10">
<h2>高级操作<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<div class="section" id="fe">
<h3>FE 配置项<a class="headerlink" href="#fe" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">dynamic_partition_enable</p>
<p>是否开启 Doris 的动态分区功能。默认为 false，即关闭。该参数只影响动态分区表的分区操作，不影响普通表。</p>
</li>
<li><p class="first">dynamic_partition_check_interval_seconds</p>
<p>动态分区线程的执行频率，默认为3600(1个小时)，即每1个小时进行一次调度</p>
</li>
</ul>
</div>
<div class="section" id="http-restful-api">
<h3>HTTP Restful API<a class="headerlink" href="#http-restful-api" title="Permalink to this headline">¶</a></h3>
<p>Doris 提供了修改动态分区配置参数的 HTTP Restful API，用于运行时修改动态分区配置参数。</p>
<p>该 API 实现在 FE 端，使用 <code class="docutils literal notranslate"><span class="pre">fe_host:fe_http_port</span></code> 进行访问。需要 ADMIN 权限。</p>
<ol>
<li><p class="first">将 dynamic_partition_enable 设置为 true 或 false</p>
<ul>
<li><p class="first">标记为 true</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>GET /api/_set_config?dynamic_partition_enable=true

例如: curl --location-trusted -u username:password -XGET http://fe_host:fe_http_port/api/_set_config?dynamic_partition_enable=true

返回：200
</pre></div>
</div>
</li>
<li><p class="first">标记为 false</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>GET /api/_set_config?dynamic_partition_enable=false

例如: curl --location-trusted -u username:password -XGET http://fe_host:fe_http_port/api/_set_config?dynamic_partition_enable=false

返回：200
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="first">设置 dynamic partition 的调度频率</p>
<ul>
<li><p class="first">设置调度时间为12小时调度一次</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>GET /api/_set_config?dynamic_partition_check_interval_seconds=432000

例如: curl --location-trusted -u username:password -XGET http://fe_host:fe_http_port/api/_set_config?dynamic_partition_check_interval_seconds=432000

返回：200
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="export-manual.html" class="btn btn-neutral float-right" title="数据导出" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="colocation-join.html" class="btn btn-neutral float-left" title="Colocation Join" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Apache Doris(Incubating)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
<div role="contentinfo">
    <p></p>
    <p>

        Apache Doris(incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.

    </p>
</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>