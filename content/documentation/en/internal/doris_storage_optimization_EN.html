

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Doris Storage File Format Optimization &mdash; Doris Documentations 0.11.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="GROUPING SETS DESIGN" href="grouping_sets_design_EN.html" />
    <link rel="prev" title="Design Documents" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Doris Documentations
          

          
          </a>

          
            
            
              <div class="version">
                0.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../cn/index.html">中文</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">English</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../downloads/index.html">Downloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installing/index.html">Compilation and Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../administrator-guide/index.html">Administrator Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending-doris/index.html">Extending Ability</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Design Documents</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Doris Storage File Format Optimization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#file-format">File format</a></li>
<li class="toctree-l4"><a class="reference internal" href="#read-write-logic">Read-write logic##</a></li>
<li class="toctree-l4"><a class="reference internal" href="#coding">Coding##</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compression">Compression##</a></li>
<li class="toctree-l4"><a class="reference internal" href="#todo">TODO</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="grouping_sets_design_EN.html">GROUPING SETS DESIGN</a></li>
<li class="toctree-l3"><a class="reference internal" href="metadata-design_EN.html">Metadata Design Document</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../sql-reference/index.html">SQL Manual</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer-guide/index.html">Developer Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../community/index.html">Apache Commnity</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Doris Documentations</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">English</a> &raquo;</li>
        
          <li><a href="index.html">Design Documents</a> &raquo;</li>
        
      <li>Doris Storage File Format Optimization</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/incubator-doris/blob/master/docs/documentation/en/internal/doris_storage_optimization_EN.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <!-- 
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
--><div class="section" id="doris-storage-file-format-optimization">
<h1>Doris Storage File Format Optimization<a class="headerlink" href="#doris-storage-file-format-optimization" title="Permalink to this headline">¶</a></h1>
<div class="section" id="file-format">
<h2>File format<a class="headerlink" href="#file-format" title="Permalink to this headline">¶</a></h2>
<p><img alt="../../../_images/segment_v21.png" src="../../../_images/segment_v21.png" /></p>
<center>1. doris segment</center><p>Documents include:</p>
<ul class="simple">
<li>The file starts with an 8-byte magic code to identify the file format and version</li>
<li>Data Region: Used to store data information for each column, where the data is loaded on demand by pages.</li>
<li>Index Region: Doris stores the index data of each column in Index Region, where the data is loaded according to column granularity, so the data information of the following column is stored separately.</li>
<li>Footer信息<ul>
<li>FileFooterPB: Metadata Information for Definition Files</li>
<li>Chesum of 4 bytes of footer Pb content</li>
<li>Four bytes FileFooterPB message length for reading FileFooterPB</li>
<li>The 8 byte MAGIC CODE is stored in the last bit to facilitate the identification of file types in different scenarios.</li>
</ul>
</li>
</ul>
<p>The data in the file is organized in the form of page, which is the basic unit of coding and compression. Current page types include the following:</p>
<div class="section" id="datapage">
<h3>DataPage<a class="headerlink" href="#datapage" title="Permalink to this headline">¶</a></h3>
<p>Data Page is divided into two types: nullable and non-nullable data pages.</p>
<p>Nullable’s data page includes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
                 <span class="o">+----------------+</span>
                 <span class="o">|</span>  <span class="n">value</span> <span class="n">count</span>   <span class="o">|</span>
                 <span class="o">|----------------|</span>
                 <span class="o">|</span>  <span class="n">first</span> <span class="n">row</span> <span class="nb">id</span>  <span class="o">|</span>
                 <span class="o">|----------------|</span>
                 <span class="o">|</span> <span class="n">bitmap</span> <span class="n">length</span>  <span class="o">|</span>
                 <span class="o">|----------------|</span>
                 <span class="o">|</span>  <span class="n">null</span> <span class="n">bitmap</span>   <span class="o">|</span>
                 <span class="o">|----------------|</span>
                 <span class="o">|</span>     <span class="n">data</span>       <span class="o">|</span>
                 <span class="o">|----------------|</span>
                 <span class="o">|</span>    <span class="n">checksum</span>    <span class="o">|</span>
                 <span class="o">+----------------+</span>
</pre></div>
</div>
<p>non -zero data page32467;- 26500;- 229140;-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                 <span class="o">|----------------|</span>
                 <span class="o">|</span>   <span class="n">value</span> <span class="n">count</span>  <span class="o">|</span>
                 <span class="o">|----------------|</span>
                 <span class="o">|</span>  <span class="n">first</span> <span class="n">row</span> <span class="nb">id</span>  <span class="o">|</span>
                 <span class="o">|----------------|</span>
                 <span class="o">|</span>     <span class="n">data</span>       <span class="o">|</span>
                 <span class="o">|----------------|</span>
                 <span class="o">|</span>    <span class="n">checksum</span>    <span class="o">|</span>
                 <span class="o">+----------------+</span>
</pre></div>
</div>
<p>The meanings of each field are as follows:</p>
<ul class="simple">
<li>value count<ul>
<li>Represents the number of rows in a page</li>
</ul>
</li>
<li>First row id<ul>
<li>Line number of the first line in page</li>
</ul>
</li>
<li>bitmap length<ul>
<li>Represents the number of bytes in the next bitmap</li>
</ul>
</li>
<li>null bitmap<ul>
<li>bitmap representing null information</li>
</ul>
</li>
<li>Data<ul>
<li>Store data after encoding and compress</li>
<li>You need to write in the header information of the data: is_compressed</li>
<li>Various kinds of data encoded by different codes need to write some field information in the header information in order to achieve data parsing.</li>
<li>TODO: Add header information for various encodings</li>
</ul>
</li>
<li>Checksum<ul>
<li>Store page granularity checksum, including page header and subsequent actual data</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="bloom-filter-pages">
<h3>Bloom Filter Pages<a class="headerlink" href="#bloom-filter-pages" title="Permalink to this headline">¶</a></h3>
<p>For each bloom filter column, a page of the bloom filter is generated corresponding to the granularity of the page and saved in the bloom filter pages area.</p>
</div>
<div class="section" id="ordinal-index-page">
<h3>Ordinal Index Page<a class="headerlink" href="#ordinal-index-page" title="Permalink to this headline">¶</a></h3>
<p>For each column, a sparse index of row numbers is established according to page granularity. The content is a pointer to the block (including offset and length) for the line number of the start line of the page</p>
</div>
<div class="section" id="short-key-index-page">
<h3>Short Key Index page<a class="headerlink" href="#short-key-index-page" title="Permalink to this headline">¶</a></h3>
<p>We generate a sparse index of short key every N rows (configurable) with the contents of short key - &gt; line number (ordinal)</p>
</div>
<div class="section" id="column-s-other-indexes">
<h3>Column’s other indexes###<a class="headerlink" href="#column-s-other-indexes" title="Permalink to this headline">¶</a></h3>
<p>The format design supports the subsequent expansion of other index information, such as bitmap index, spatial index, etc. It only needs to write the required data to the existing column data, and add the corresponding metadata fields to FileFooterPB.</p>
</div>
<div class="section" id="metadata-definition">
<h3>Metadata Definition###<a class="headerlink" href="#metadata-definition" title="Permalink to this headline">¶</a></h3>
<p>FileFooterPB is defined as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>message ColumnPB {
    optional uint32 column_id = 1; // 这里使用column id，不使用column name是因为计划支持修改列名
    optional string type = 2; // 列类型
    optional string aggregation = 3; // 是否聚合
    optional uint32 length = 4; // 长度
    optional bool is_key = 5; // 是否是主键列
    optional string default_value = 6; // 默认值
    optional uint32 precision = 9 [default = 27]; // 精度
    optional uint32 frac = 10 [default = 9];
    optional bool is_nullable = 11 [default=false]; // 是否有null
    optional bool is_bf_column = 15 [default=false]; // 是否有bf词典
	optional bool is_bitmap_column = 16 [default=false]; // 是否有bitmap索引
}

// page偏移
message PagePointerPB {
	required uint64 offset; // page在文件中的偏移
	required uint32 length; // page的大小
}

message MetadataPairPB {
  optional string key = 1;
  optional bytes value = 2;
}

message ColumnMetaPB {
	optional ColumnMessage encoding; // 编码方式

	optional PagePointerPB dict_page // 词典page
	repeated PagePointerPB bloom_filter_pages; // bloom filter词典信息
	optional PagePointerPB ordinal_index_page; // 行号索引数据
	optional PagePointerPB page_zone_map_page; // page级别统计信息索引数据

	optional PagePointerPB bitmap_index_page; // bitmap索引数据

	optional uint64 data_footprint; // 列中索引的大小
	optional uint64 index_footprint; // 列中数据的大小
	optional uint64 raw_data_footprint; // 原始列数据大小

	optional CompressKind compress_kind; // 列的压缩方式

	optional ZoneMapPB column_zone_map; //文件级别的过滤条件
	repeated MetadataPairPB column_meta_datas;
}

message FileFooterPB {
	optional uint32 version = 2 [default = 1]; // 用于版本兼容和升级使用
	repeated ColumnPB schema = 5; // 列Schema
    optional uint64 num_values = 4; // 文件中保存的行数
    optional uint64 index_footprint = 7; // 索引大小
    optional uint64 data_footprint = 8; // 数据大小
	optional uint64 raw_data_footprint = 8; // 原始数据大小

    optional CompressKind compress_kind = 9 [default = COMPRESS_LZO]; // 压缩方式
    repeated ColumnMetaPB column_metas = 10; // 列元数据
	optional PagePointerPB key_index_page; // short key索引page
}
</pre></div>
</div>
</div>
</div>
<div class="section" id="read-write-logic">
<h2>Read-write logic##<a class="headerlink" href="#read-write-logic" title="Permalink to this headline">¶</a></h2>
<div class="section" id="write">
<h3>Write<a class="headerlink" href="#write" title="Permalink to this headline">¶</a></h3>
<p>The general writing process is as follows:</p>
<ol class="simple">
<li>Write magic</li>
<li>Generate corresponding Column Writer according to schema information. Each Column Writer obtains corresponding encoding information (configurable) according to different types, and generates corresponding encoder according to encoding.</li>
<li>Call encoder - &gt; add (value) for data writing. Each K line generates a short key index entry, and if the current page satisfies certain conditions (the size exceeds 1M or the number of rows is K), a new page is generated and cached in memory.</li>
<li>Continuous cycle step 3 until data writing is completed. Brush the data of each column into the file in sequence</li>
<li>Generate FileFooterPB information and write it to the file.</li>
</ol>
<p>Relevant issues:</p>
<ul class="simple">
<li>How does the index of short key be generated?<ul>
<li>Now we still generate a short key sparse index according to how many rows are sparse, and keep a short sparse index generated every 1024 rows. The specific content is: short key - &gt; ordinal</li>
</ul>
</li>
<li>What should be stored in the ordinal index?<ul>
<li>Store the first ordinal to page pointer mapping information for pages</li>
</ul>
</li>
<li>What are stored in pages of different encoding types?<ul>
<li>Dictionary Compression</li>
<li>plain</li>
<li>rle</li>
<li>bshuf</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="read">
<h3>Read###<a class="headerlink" href="#read" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li>Read the magic of the file and judge the type and version of the file.</li>
<li>Read FileFooterPB and check sum</li>
<li>Read short key index and data ordinal index information of corresponding columns according to required columns</li>
<li>Use start key and end key, locate the row number to be read through short key index, then determine the row ranges to be read through ordinal index, and filter the row ranges to be read through statistics, bitmap index and so on.</li>
<li>Then read row data through ordinal index according to row ranges</li>
</ol>
<p>Relevant issues:</p>
<ol>
<li><p class="first">How to quickly locate a row within the page?</p>
<p>The data inside the page is encoding, so it can not locate the row-level data quickly. Different encoding methods have different schemes for fast line number positioning in-house, which need to be analyzed concretely:</p>
<ul class="simple">
<li>If it is rle-coded, skip is performed by resolving the head of RLE until the RLE block containing the row is reached, and then the reverse solution is performed.</li>
<li>binary plain encoding: offset information will be stored in the page, and offset information will be specified in the page header. When reading, offset information will be parsed into the array first, so that you can quickly locate the data of a row of block through offset data information of each row.</li>
</ul>
</li>
<li><p class="first">How to achieve efficient block reading? Consider merging adjacent blocks while they are being read, one-time reading?
This requires judging whether the block is continuous at the time of reading, and if it is continuous, reading it once.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="coding">
<h2>Coding##<a class="headerlink" href="#coding" title="Permalink to this headline">¶</a></h2>
<p>In the existing Doris storage, plain encoding is adopted for string type encoding, which is inefficient. After comparison, it is found that in Baidu statistics scenario, data will expand more than twice because of string type coding. Therefore, it is planned to introduce dictionary-based coding compression.</p>
</div>
<div class="section" id="compression">
<h2>Compression##<a class="headerlink" href="#compression" title="Permalink to this headline">¶</a></h2>
<p>It implements a scalable compression framework, supports a variety of compression algorithms, facilitates the subsequent addition of new compression algorithms, and plans to introduce zstd compression.</p>
</div>
<div class="section" id="todo">
<h2>TODO<a class="headerlink" href="#todo" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li>How to implement nested types? How to locate line numbers in nested types?</li>
<li>How to optimize the downstream bitmap and column statistics statistics caused by ScanRange splitting?</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="grouping_sets_design_EN.html" class="btn btn-neutral float-right" title="GROUPING SETS DESIGN" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Design Documents" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Apache Doris(Incubating)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
<div role="contentinfo">
    <p></p>
    <p>

        Apache Doris(incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.

    </p>
</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>